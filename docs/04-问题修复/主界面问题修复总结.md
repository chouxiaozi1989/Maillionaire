# 主界面问题修复总结

## 修复概览

本次修复解决了主界面的三个关键问题：

1. ✅ 邮箱文件夹列表超长无法显示滚动条
2. ✅ 邮箱文件夹显示未关联邮箱账户
3. ✅ 系统设置界面改为弹窗

---

## 问题 1：文件夹列表滚动条（已修复）

### 问题描述
创建多个自定义文件夹后，文件夹列表超出可视区域，但没有显示滚动条，导致底部文件夹无法访问。

### 修复方案
在 `src/views/Main.vue` 的 `.folder-menu` 样式中添加滚动条配置。

**修改文件**：`src/views/Main.vue`

**修复代码**（第 521-544 行）：
```scss
.folder-menu {
  flex: 1;
  border-right: none;
  overflow-y: auto;           // ✅ 启用垂直滚动
  overflow-x: hidden;         // ✅ 隐藏横向滚动
  
  /* 自定义滚动条样式 */
  &::-webkit-scrollbar {
    width: 6px;               // 细窄滚动条
  }
  
  &::-webkit-scrollbar-track {
    background: #F5F5F5;      // 浅灰轨道
  }
  
  &::-webkit-scrollbar-thumb {
    background: #D9D9D9;      // 浅灰滑块
    border-radius: 3px;
    
    &:hover {
      background: #BFBFBF;    // 悬停变深
    }
  }
}
```

**效果**：
- ✅ 文件夹列表可以滚动
- ✅ 自定义滚动条样式更美观
- ✅ 支持鼠标滚轮操作

---

## 问题 2：文件夹未关联邮箱账户

### 问题描述
所有账户共享同一个文件夹列表，导致：
1. 切换账户时文件夹不更新
2. 文件夹显示"未关联邮箱账户"
3. 不同账户的自定义文件夹混在一起

### 根本原因
文件夹存储在全局的 `folders.json` 文件中，没有按账户区分。

**旧版逻辑**：
```
所有账户 → folders.json
```

**问题**：
- ❌ 账户 A 的自定义文件夹会显示在账户 B
- ❌ 切换账户后文件夹列表不变
- ❌ 无法区分不同账户的文件夹

### 修复方案
将文件夹存储改为**按账户分别存储**。

**新版逻辑**：
```
账户 A → folders_account_A_id.json
账户 B → folders_account_B_id.json
账户 C → folders_account_C_id.json
```

**修复内容**：

#### 1. 修复 `loadFolders()` - 按账户加载

**文件**：`src/stores/mail.js`

```javascript
async function loadFolders() {
  try {
    const accountId = accountStore.currentAccountId
    if (!accountId) {
      console.log('[Mail] No current account, using default folders')
      return
    }
    
    // ✅ 按账户加载文件夹
    const data = await storageService.readJSON(`folders_${accountId}.json`)
    if (data) {
      folders.value = data.folders || getDefaultFolders()
      lastSyncTime.value = data.lastSyncTime
      console.log(`[Mail] Loaded ${folders.value.length} folders for account ${accountId}`)
    } else {
      // 如果没有数据，使用默认文件夹
      folders.value = getDefaultFolders()
      console.log('[Mail] Using default folders')
    }
  } catch (error) {
    console.error('[Mail] Failed to load folders:', error)
    // 加载失败时使用默认文件夹
    folders.value = getDefaultFolders()
  }
}

// ✅ 新增：获取默认文件夹列表
function getDefaultFolders() {
  return [
    { id: 'inbox', name: '收件箱', icon: 'InboxOutlined', system: true },
    { id: 'sent', name: '已发送', icon: 'SendOutlined', system: true },
    { id: 'drafts', name: '草稿箱', icon: 'EditOutlined', system: true },
    { id: 'trash', name: '回收站', icon: 'DeleteOutlined', system: true },
    { id: 'starred', name: '星标邮件', icon: 'StarOutlined', system: true },
  ]
}
```

#### 2. 修复 `syncServerFolders()` - 按账户保存

```javascript
async function syncServerFolders() {
  // ... 同步逻辑 ...
  
  lastSyncTime.value = new Date().toISOString()
  
  // ✅ 按账户保存文件夹
  const accountId = accountStore.currentAccountId
  if (accountId) {
    await storageService.writeJSON(`folders_${accountId}.json`, {
      folders: folders.value,
      lastSyncTime: lastSyncTime.value,
    })
    console.log(`[Mail] Saved ${folders.value.length} folders for account ${accountId}`)
  }
  
  return folders.value
}
```

#### 3. 修复 `createFolder()` - 按账户保存

```javascript
async function createFolder(folderName) {
  try {
    const accountId = accountStore.currentAccountId
    if (!accountId) {
      throw new Error('请先选择账户')
    }
    
    const newFolder = {
      id: `custom_${Date.now()}`,
      name: folderName,
      icon: 'FolderOutlined',
      system: false,
      createdAt: new Date().toISOString(),
    }
    
    folders.value.push(newFolder)
    
    // ✅ 按账户保存
    await storageService.writeJSON(`folders_${accountId}.json`, {
      folders: folders.value,
      lastSyncTime: lastSyncTime.value,
    })
    
    return newFolder
  } catch (error) {
    console.error('Failed to create folder:', error)
    throw error
  }
}
```

#### 4. 修复 `deleteFolder()` - 按账户保存

```javascript
async function deleteFolder(folderId) {
  try {
    const accountId = accountStore.currentAccountId
    if (!accountId) {
      throw new Error('请先选择账户')
    }
    
    const folder = folders.value.find(f => f.id === folderId)
    if (!folder || folder.system) {
      throw new Error('无法删除系统文件夹')
    }
    
    folders.value = folders.value.filter(f => f.id !== folderId)
    
    // ✅ 按账户保存
    await storageService.writeJSON(`folders_${accountId}.json`, {
      folders: folders.value,
      lastSyncTime: lastSyncTime.value,
    })
  } catch (error) {
    console.error('Failed to delete folder:', error)
    throw error
  }
}
```

#### 5. 增强 `handleAccountChange()` - 切换时重新加载

**文件**：`src/views/Main.vue`

```javascript
async function handleAccountChange(accountId) {
  try {
    accountStore.switchAccount(accountId)
    
    console.log(`[Main] Switching to account ${accountId}`)
    
    // ✅ 重新加载该账户的文件夹列表
    await mailStore.loadFolders()
    
    // 重新加载邮件
    await mailStore.loadMails('inbox')
    
    // 重置选中的文件夹为收件箱
    selectedFolders.value = ['inbox']
    
    // ✅ 如果当前不在收件箱页面，跳转到收件箱
    if (router.currentRoute.value.path !== '/main/inbox') {
      router.push('/main/inbox')
    }
    
    message.success('已切换账户')
  } catch (error) {
    console.error('Switch account failed:', error)
    message.error('切换账户失败：' + error.message)
  }
}
```

### 修复效果

**修复前**：
```
账户 A: [收件箱, 已发送, 工作邮件, 个人邮件]
       ↓ 切换账户
账户 B: [收件箱, 已发送, 工作邮件, 个人邮件]  ← 文件夹相同 ❌
```

**修复后**：
```
账户 A: [收件箱, 已发送, 工作邮件]  ← A 的文件夹 ✅
       ↓ 切换账户
账户 B: [收件箱, 已发送, 个人邮件]  ← B 的文件夹 ✅
```

**验证清单**：
- ✅ 切换账户时文件夹列表自动更新
- ✅ 每个账户有独立的自定义文件夹
- ✅ 默认文件夹（收件箱等）总是显示
- ✅ 同步服务器文件夹按账户保存
- ✅ 创建/删除文件夹按账户保存

---

## 问题 3：设置界面改为弹窗

### 问题描述
原设置界面是一个独立的路由页面，需要改为弹窗形式，保持用户操作上下文连续性。

### 修复方案
创建新的设置弹窗组件，替换原有的路由跳转方式。

#### 1. 创建设置弹窗组件

**文件**：`src/components/settings/SettingsModal.vue` (新建)

**功能特性**：
- ✅ 模态弹窗形式（900px 宽度）
- ✅ 左侧导航菜单
- ✅ 三个设置面板：通用设置、代理设置、关于
- ✅ 紧凑布局，适合弹窗显示
- ✅ 独立的保存和测试按钮

**组件结构**：
```vue
<template>
  <a-modal
    :open="visible"
    title="系统设置"
    :width="900"
    :footer="null"
    @cancel="handleClose"
  >
    <a-layout>
      <!-- 左侧菜单 -->
      <a-layout-sider :width="180">
        <a-menu>
          <a-menu-item key="general">通用设置</a-menu-item>
          <a-menu-item key="proxy">代理设置</a-menu-item>
          <a-menu-item key="about">关于</a-menu-item>
        </a-menu>
      </a-layout-sider>
      
      <!-- 右侧内容 -->
      <a-layout-content>
        <!-- 动态面板内容 -->
      </a-layout-content>
    </a-layout>
  </a-modal>
</template>
```

**设置面板**：

1. **通用设置**
   - 主题模式（浅色/深色/跟随系统）
   - 语言（简体中文/English）
   - 每页显示邮件数
   - 自动同步开关
   - 同步间隔滑块

2. **代理设置**
   - 启用代理开关
   - 代理协议（SOCKS5/HTTP/HTTPS）
   - 服务器地址和端口
   - 认证配置
   - 测试连接按钮

3. **关于页面**
   - 应用 Logo
   - 版本信息
   - 开发者信息
   - 技术栈
   - 链接（GitHub、帮助文档）

#### 2. 修改主界面集成弹窗

**文件**：`src/views/Main.vue`

**修改内容**：

##### 2.1 导入组件
```javascript
import SettingsModal from '@/components/settings/SettingsModal.vue'
```

##### 2.2 添加状态
```javascript
const showSettingsModal = ref(false)
```

##### 2.3 修改点击事件
```javascript
// ❌ 旧版：跳转路由
function handleSettings() {
  router.push('/main/settings')
}

// ✅ 新版：打开弹窗
function handleSettings() {
  showSettingsModal.value = true
}
```

##### 2.4 添加弹窗组件
```vue
<template>
  <div class="main-layout">
    <!-- ... 其他内容 ... -->
    
    <!-- 撰写邮件弹窗 -->
    <ComposeModal v-model:visible="showComposeModal" />
    
    <!-- ✅ 系统设置弹窗 -->
    <SettingsModal v-model:visible="showSettingsModal" />
    
    <!-- 新建文件夹弹窗 -->
    <a-modal ...>
  </div>
</template>
```

### 修复效果

**修复前**：
```
用户操作流程：
1. 点击设置按钮
2. 页面跳转到 /main/settings  ← 离开邮件列表
3. 修改设置
4. 点击返回按钮
5. 回到邮件列表              ← 上下文丢失
```

**修复后**：
```
用户操作流程：
1. 点击设置按钮
2. 弹窗打开                  ← 停留在当前页面
3. 修改设置
4. 点击保存/取消
5. 弹窗关闭                  ← 上下文保持
```

**优势**：
- ✅ 不离开当前页面
- ✅ 操作上下文连续
- ✅ 更快的交互响应
- ✅ 符合现代应用习惯
- ✅ 可以同时查看邮件和调整设置

---

## 修改文件清单

### 问题 1：滚动条
- ✅ `src/views/Main.vue` - 添加 CSS 滚动条样式

### 问题 2：文件夹关联
- ✅ `src/stores/mail.js`
  - `loadFolders()` - 按账户加载
  - `getDefaultFolders()` - 新增默认文件夹函数
  - `syncServerFolders()` - 按账户保存
  - `createFolder()` - 按账户保存
  - `deleteFolder()` - 按账户保存
  
- ✅ `src/views/Main.vue`
  - `handleAccountChange()` - 增强切换逻辑

### 问题 3：设置弹窗
- ✅ `src/components/settings/SettingsModal.vue` - 新建设置弹窗组件
- ✅ `src/views/Main.vue`
  - 导入 SettingsModal 组件
  - 添加 showSettingsModal 状态
  - 修改 handleSettings() 方法
  - 添加弹窗组件到模板

---

## 测试验证

### 测试场景 1：文件夹滚动
1. 创建 10+ 个自定义文件夹
2. 观察文件夹列表
3. **预期**：显示滚动条，可以滚动查看所有文件夹

### 测试场景 2：账户切换
1. 在账户 A 创建自定义文件夹"工作邮件"
2. 切换到账户 B
3. **预期**：
   - 只显示账户 B 的文件夹
   - 不显示账户 A 的"工作邮件"
4. 切换回账户 A
5. **预期**：可以看到"工作邮件"文件夹

### 测试场景 3：设置弹窗
1. 点击顶部工具栏的设置按钮
2. **预期**：打开设置弹窗，停留在当前页面
3. 修改通用设置，点击保存
4. **预期**：显示"设置已保存"提示
5. 点击弹窗外部或取消按钮
6. **预期**：弹窗关闭，返回邮件列表

### 测试场景 4：代理设置
1. 打开设置弹窗
2. 切换到"代理设置"标签
3. 启用代理，填写配置
4. 点击"测试连接"
5. **预期**：显示测试结果
6. 点击"保存设置"
7. **预期**：代理配置保存成功

---

## 技术要点

### 1. 文件存储按账户隔离
```javascript
// 旧版：全局存储
folders.json

// 新版：按账户存储
folders_account_123.json
folders_account_456.json
folders_account_789.json
```

### 2. 默认文件夹机制
```javascript
function getDefaultFolders() {
  return [
    { id: 'inbox', name: '收件箱', ... },
    { id: 'sent', name: '已发送', ... },
    { id: 'drafts', name: '草稿箱', ... },
    { id: 'trash', name: '回收站', ... },
    { id: 'starred', name: '星标邮件', ... },
  ]
}
```

**好处**：
- ✅ 新账户立即有可用的文件夹
- ✅ 文件加载失败时有后备方案
- ✅ 统一的文件夹结构

### 3. 弹窗组件最佳实践
```vue
<template>
  <a-modal
    :open="visible"           <!-- ✅ 使用 props 控制显示 -->
    @cancel="handleClose"     <!-- ✅ 关闭时通知父组件 -->
  >
  </a-modal>
</template>

<script setup>
const props = defineProps({
  visible: Boolean
})

const emit = defineEmits(['update:visible'])

function handleClose() {
  emit('update:visible', false)  // ✅ 使用 v-model 模式
}
</script>
```

### 4. 滚动条自定义
```scss
.folder-menu {
  overflow-y: auto;  // 启用滚动
  
  &::-webkit-scrollbar {
    width: 6px;  // 细窄更美观
  }
  
  &::-webkit-scrollbar-thumb {
    background: #D9D9D9;
    border-radius: 3px;
    
    &:hover {
      background: #BFBFBF;  // 交互反馈
    }
  }
}
```

---

## 总结

本次修复成功解决了主界面的三个关键问题：

1. ✅ **滚动条问题**：添加 CSS 样式启用滚动，并自定义美观的滚动条
2. ✅ **文件夹关联问题**：实现按账户隔离存储，切换账户时自动加载对应文件夹
3. ✅ **设置界面优化**：从路由页面改为弹窗，提升用户体验

**用户体验提升**：
- 🎯 文件夹管理更加清晰
- 🎯 账户切换更加流畅
- 🎯 设置修改更加便捷
- 🎯 操作上下文保持连续

**代码质量提升**：
- 📦 数据隔离更加完善
- 📦 组件复用性更强
- 📦 错误处理更完善
- 📦 日志记录更详细
