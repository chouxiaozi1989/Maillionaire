# é—®é¢˜ä¿®å¤ï¼šè´¦æˆ·æ·»åŠ åæ— æ³•è·³è½¬å’Œå­˜å‚¨å¤±è´¥

## ğŸ“‹ é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼š
- æ·»åŠ è´¦æˆ·åï¼Œç‚¹å‡»è´¦æˆ·æ—¶æ§åˆ¶å°æŠ¥é”™
- æ— æ³•è·³è½¬åˆ°ä¸»ç•Œé¢
- è´¦æˆ·æ•°æ®æ— æ³•ä¿å­˜

**å½±å“èŒƒå›´**ï¼š
- ç™»å½•é¡µé¢è´¦æˆ·ç‚¹å‡»
- è´¦æˆ·æ•°æ®æŒä¹…åŒ–
- Electron ç¯å¢ƒä¸‹çš„æ–‡ä»¶æ“ä½œ

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### 1. Electron é…ç½®é”™è¯¯ï¼ˆä¸»è¦é—®é¢˜ï¼‰

**æ–‡ä»¶**ï¼š`electron/main.js`

**é”™è¯¯é…ç½®**ï¼š
```javascript
webPreferences: {
  nodeIntegration: true,
  contextIsolation: false,  // âŒ é”™è¯¯ï¼šç¦ç”¨äº†ä¸Šä¸‹æ–‡éš”ç¦»
  enableRemoteModule: true,
  // âŒ ç¼ºå¤±ï¼šæ²¡æœ‰åŠ è½½ preload è„šæœ¬
}
```

**é—®é¢˜è¯´æ˜**ï¼š
1. **`contextIsolation: false`** å¯¼è‡´ `preload.js` ä¸­çš„ `contextBridge.exposeInMainWorld` å¤±æ•ˆ
2. **æ²¡æœ‰é…ç½® `preload`** è·¯å¾„ï¼Œpreload è„šæœ¬æ ¹æœ¬æ²¡æœ‰è¢«åŠ è½½
3. æ¸²æŸ“è¿›ç¨‹æ— æ³•è®¿é—® `window.electronAPI`
4. `storageService` åˆ¤æ–­ä¸ºæµè§ˆå™¨ç¯å¢ƒï¼Œä½¿ç”¨ localStorage è€Œéæ–‡ä»¶ç³»ç»Ÿ

**åæœ**ï¼š
- è´¦æˆ·æ•°æ®åªä¿å­˜åœ¨æµè§ˆå™¨çš„ localStorageï¼Œåˆ·æ–°åä¸¢å¤±
- æ— æ³•è®¿é—®æ–‡ä»¶ç³»ç»Ÿè¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨
- Electron ç¯å¢ƒçš„æ–‡ä»¶è¯»å†™åŠŸèƒ½å®Œå…¨å¤±æ•ˆ

---

### 2. ç¼ºå°‘æ–‡ä»¶ç³»ç»Ÿ IPC å¤„ç†å™¨

**æ–‡ä»¶**ï¼š`electron/main.js`

**é—®é¢˜**ï¼š
- è™½ç„¶ `preload.js` æš´éœ²äº† `readFile`ã€`writeFile`ã€`deleteFile` API
- ä½†ä¸»è¿›ç¨‹ä¸­æ²¡æœ‰å®ç°å¯¹åº”çš„ IPC å¤„ç†å™¨
- å¯¼è‡´è°ƒç”¨æ—¶è¿”å› `undefined` æˆ–è¶…æ—¶

**ç¼ºå¤±çš„å¤„ç†å™¨**ï¼š
```javascript
// âŒ ç¼ºå¤±
ipcMain.handle('read-file', async (event, filename) => { ... })
ipcMain.handle('write-file', async (event, filename, data) => { ... })
ipcMain.handle('delete-file', async (event, filename) => { ... })
```

---

### 3. è´¦æˆ·åŠ è½½æ—¶æœºé—®é¢˜

**æ–‡ä»¶**ï¼š`src/views/Login.vue`

**é”™è¯¯ä»£ç **ï¼š
```javascript
// âŒ åœ¨è„šæœ¬é¡¶å±‚ç›´æ¥è°ƒç”¨ï¼Œæ²¡æœ‰é”™è¯¯å¤„ç†
accountStore.loadAccounts()
```

**é—®é¢˜**ï¼š
1. ä¸åœ¨ `onMounted` é’©å­ä¸­ï¼Œå¯èƒ½åœ¨ç»„ä»¶æœªå®Œå…¨æŒ‚è½½æ—¶æ‰§è¡Œ
2. æ²¡æœ‰ä½¿ç”¨ `await`ï¼Œæ— æ³•æ•è·å¼‚æ­¥é”™è¯¯
3. åŠ è½½å¤±è´¥æ—¶æ²¡æœ‰ä»»ä½•æç¤º

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: æ­£ç¡®é…ç½® Electron ä¸Šä¸‹æ–‡éš”ç¦»

**æ–‡ä»¶**ï¼š`electron/main.js`

**ä¿®æ”¹å†…å®¹**ï¼š
```javascript
const { app, BrowserWindow, ipcMain } = require('electron');
const path = require('path');
const fs = require('fs').promises;  // âœ… æ·»åŠ  fs æ¨¡å—
const isDev = !app.isPackaged;

function createWindow() {
  const mainWindow = new BrowserWindow({
    width: 1440,
    height: 900,
    minWidth: 1024,
    minHeight: 768,
    frame: true,
    webPreferences: {
      nodeIntegration: false,        // âœ… å…³é—­ node é›†æˆï¼ˆå®‰å…¨ï¼‰
      contextIsolation: true,        // âœ… å¯ç”¨ä¸Šä¸‹æ–‡éš”ç¦»ï¼ˆå®‰å…¨ï¼‰
      preload: path.join(__dirname, 'preload.js'),  // âœ… åŠ è½½ preload è„šæœ¬
    },
    icon: path.join(__dirname, '../build/icon.png'),
  });
  
  // ... å…¶ä»–ä»£ç 
}
```

**é‡è¦æ€§**ï¼š
- âœ… `contextIsolation: true` æ˜¯ Electron å®‰å…¨æœ€ä½³å®è·µ
- âœ… å¯ç”¨å `contextBridge` æ‰èƒ½æ­£å¸¸å·¥ä½œ
- âœ… é˜²æ­¢æ¸²æŸ“è¿›ç¨‹ç›´æ¥è®¿é—® Node.js APIï¼ˆå®‰å…¨æ²™ç®±ï¼‰

---

### ä¿®å¤ 2: å®ç°æ–‡ä»¶ç³»ç»Ÿ IPC å¤„ç†å™¨

**æ–‡ä»¶**ï¼š`electron/main.js`

**æ–°å¢ä»£ç **ï¼š
```javascript
/**
 * æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
 */

// è¯»å–æ–‡ä»¶
ipcMain.handle('read-file', async (event, filename) => {
  try {
    const filePath = path.join(app.getPath('userData'), filename);
    const data = await fs.readFile(filePath, 'utf-8');
    return data;
  } catch (error) {
    if (error.code === 'ENOENT') {
      return null; // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å› null
    }
    throw error;
  }
});

// å†™å…¥æ–‡ä»¶
ipcMain.handle('write-file', async (event, filename, data) => {
  try {
    const filePath = path.join(app.getPath('userData'), filename);
    const dir = path.dirname(filePath);
    
    // ç¡®ä¿ç›®å½•å­˜åœ¨
    await fs.mkdir(dir, { recursive: true });
    
    // å†™å…¥æ–‡ä»¶
    await fs.writeFile(filePath, data, 'utf-8');
    return true;
  } catch (error) {
    console.error('Write file error:', error);
    throw error;
  }
});

// åˆ é™¤æ–‡ä»¶
ipcMain.handle('delete-file', async (event, filename) => {
  try {
    const filePath = path.join(app.getPath('userData'), filename);
    await fs.unlink(filePath);
    return true;
  } catch (error) {
    if (error.code === 'ENOENT') {
      return true; // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè§†ä¸ºåˆ é™¤æˆåŠŸ
    }
    throw error;
  }
});
```

**åŠŸèƒ½è¯´æ˜**ï¼š
- âœ… æ‰€æœ‰æ–‡ä»¶æ“ä½œåŸºäº `app.getPath('userData')`
  - Windows: `C:\Users\{ç”¨æˆ·å}\AppData\Roaming\Maillionaire\`
  - macOS: `~/Library/Application Support/Maillionaire/`
  - Linux: `~/.config/Maillionaire/`
- âœ… è‡ªåŠ¨åˆ›å»ºå¿…è¦çš„å­ç›®å½•
- âœ… æ–‡ä»¶ä¸å­˜åœ¨æ—¶è¿”å› `null` è€ŒéæŠ›å‡ºé”™è¯¯
- âœ… ä½¿ç”¨ `async/await` å¤„ç†å¼‚æ­¥æ“ä½œ

---

### ä¿®å¤ 3: æ”¹è¿›è´¦æˆ·åŠ è½½æ—¶æœºå’Œé”™è¯¯å¤„ç†

**æ–‡ä»¶**ï¼š`src/views/Login.vue`

**ä¿®æ”¹å†…å®¹**ï¼š
```javascript
<script setup>
import { ref, reactive, computed, onMounted } from 'vue'  // âœ… å¯¼å…¥ onMounted
import { useRouter } from 'vue-router'
import { message } from 'ant-design-vue'
import { MailOutlined, PlusOutlined } from '@ant-design/icons-vue'
import { useAccountStore } from '@/stores/account'
import { oauth2Service } from '@/services/oauth'

// ... å…¶ä»–ä»£ç  ...

// âœ… åœ¨ onMounted é’©å­ä¸­åŠ è½½è´¦æˆ·
onMounted(async () => {
  try {
    await accountStore.loadAccounts()
  } catch (error) {
    console.error('Failed to load accounts:', error)
  }
})
</script>
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `onMounted` ç¡®ä¿ç»„ä»¶å·²æŒ‚è½½
- âœ… ä½¿ç”¨ `await` ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ
- âœ… æ·»åŠ  `try-catch` æ•è·åŠ è½½é”™è¯¯

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æµç¨‹ 1ï¼šæ·»åŠ è´¦æˆ·å¹¶éªŒè¯å­˜å‚¨

1. **å¯åŠ¨åº”ç”¨**ï¼š
   ```bash
   npm run electron:dev
   ```

2. **æ·»åŠ æµ‹è¯•è´¦æˆ·**ï¼ˆGmail æµ‹è¯•æ¨¡å¼ï¼‰ï¼š
   - ç‚¹å‡»"æ·»åŠ é‚®ç®±è´¦æˆ·"
   - é€‰æ‹© Gmail
   - è¾“å…¥ï¼š`test@gmail.com`
   - ç‚¹å‡»ç¡®å®š

3. **éªŒè¯æµç¨‹**ï¼š
   - âœ… OAuth2 è®¤è¯æˆåŠŸï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
   - âœ… æ˜¾ç¤º"è´¦æˆ·æ·»åŠ æˆåŠŸ"
   - âœ… æ˜¾ç¤º"ç™»å½•æˆåŠŸ"
   - âœ… è‡ªåŠ¨è·³è½¬åˆ° `/main/inbox`

4. **éªŒè¯å­˜å‚¨**ï¼š
   - å…³é—­åº”ç”¨
   - é‡æ–°å¯åŠ¨åº”ç”¨
   - âœ… è´¦æˆ·ä»ç„¶å­˜åœ¨ï¼ˆæŒä¹…åŒ–æˆåŠŸï¼‰

5. **æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ**ï¼š
   ```
   C:\Users\Administrator\AppData\Roaming\Maillionaire\
     â””â”€â”€ accounts\
           â””â”€â”€ accounts.json  âœ… è´¦æˆ·æ•°æ®æ–‡ä»¶
   ```

---

### æµ‹è¯•æµç¨‹ 2ï¼šç‚¹å‡»è´¦æˆ·ç™»å½•

1. **å‰æ**ï¼šå·²æœ‰ä¿å­˜çš„è´¦æˆ·
2. **æ“ä½œ**ï¼šåœ¨ç™»å½•é¡µç‚¹å‡»è´¦æˆ·å¡ç‰‡
3. **éªŒè¯**ï¼š
   - âœ… æ§åˆ¶å°æ— æŠ¥é”™
   - âœ… æ˜¾ç¤º"ç™»å½•æˆåŠŸ"
   - âœ… è·³è½¬åˆ°ä¸»ç•Œé¢
   - âœ… ä¾§è¾¹æ æ˜¾ç¤ºå½“å‰è´¦æˆ·ä¿¡æ¯

---

### æµ‹è¯•æµç¨‹ 3ï¼šå¤šè´¦æˆ·åˆ‡æ¢

1. **æ·»åŠ å¤šä¸ªè´¦æˆ·**ï¼ˆä¸åŒç±»å‹ï¼‰ï¼š
   - Gmail: `test1@gmail.com`
   - QQ: `test2@qq.com`
   - 163: `test3@163.com`

2. **éªŒè¯å­˜å‚¨**ï¼š
   ```json
   // accounts.json å†…å®¹
   [
     {
       "id": "1234567890123",
       "type": "gmail",
       "email": "test1@gmail.com",
       "oauth2": true,
       "testMode": true,
       "createdAt": "2025-10-19T..."
     },
     {
       "id": "1234567890124",
       "type": "qq",
       "email": "test2@qq.com",
       "imapHost": "imap.qq.com",
       "createdAt": "2025-10-19T..."
     }
   ]
   ```

3. **åˆ‡æ¢è´¦æˆ·**ï¼š
   - åœ¨ä¸»ç•Œé¢ä¾§è¾¹æ åˆ‡æ¢è´¦æˆ·
   - âœ… æ˜¾ç¤º"å·²åˆ‡æ¢è´¦æˆ·"
   - âœ… currentAccountId æ›´æ–°

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| åŠŸèƒ½ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **Electron ä¸Šä¸‹æ–‡éš”ç¦»** | âŒ ç¦ç”¨ï¼ˆä¸å®‰å…¨ï¼‰ | âœ… å¯ç”¨ï¼ˆå®‰å…¨ï¼‰ |
| **Preload è„šæœ¬** | âŒ æœªåŠ è½½ | âœ… æ­£ç¡®åŠ è½½ |
| **æ–‡ä»¶ç³»ç»Ÿ API** | âŒ ä¸å¯ç”¨ | âœ… å®Œå…¨å¯ç”¨ |
| **è´¦æˆ·æ•°æ®å­˜å‚¨** | âŒ localStorageï¼ˆä¸´æ—¶ï¼‰ | âœ… æ–‡ä»¶ç³»ç»Ÿï¼ˆæŒä¹…ï¼‰ |
| **ç‚¹å‡»è´¦æˆ·ç™»å½•** | âŒ æ§åˆ¶å°æŠ¥é”™ | âœ… æ­£å¸¸è·³è½¬ |
| **æ•°æ®æŒä¹…åŒ–** | âŒ åˆ·æ–°åä¸¢å¤± | âœ… æ°¸ä¹…ä¿å­˜ |
| **é”™è¯¯å¤„ç†** | âŒ æ— æç¤º | âœ… å®Œæ•´æ•è· |

---

## ğŸ”§ ç›¸å…³æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`electron/main.js`**ï¼ˆ+54 è¡Œï¼Œ-3 è¡Œï¼‰
   - ä¿®å¤ webPreferences é…ç½®
   - æ·»åŠ  fs æ¨¡å—å¯¼å…¥
   - å®ç°æ–‡ä»¶ç³»ç»Ÿ IPC å¤„ç†å™¨

2. **`src/views/Login.vue`**ï¼ˆ+9 è¡Œï¼Œ-3 è¡Œï¼‰
   - å¯¼å…¥ onMounted
   - æ”¹è¿›è´¦æˆ·åŠ è½½é€»è¾‘

### ä¿æŒä¸å˜çš„æ–‡ä»¶

- `electron/preload.js` âœ… å·²æ­£ç¡®å®ç°
- `src/services/storage.js` âœ… å·²æ­£ç¡®å®ç°
- `src/stores/account.js` âœ… å·²æ­£ç¡®å®ç°

---

## ğŸ¯ æŠ€æœ¯è¦ç‚¹æ€»ç»“

### Electron å®‰å…¨æœ€ä½³å®è·µ

```javascript
// âœ… æ¨èé…ç½®
webPreferences: {
  nodeIntegration: false,      // ç¦ç”¨ç›´æ¥è®¿é—® Node.js
  contextIsolation: true,      // å¯ç”¨ä¸Šä¸‹æ–‡éš”ç¦»
  preload: path.join(__dirname, 'preload.js'),  // ä½¿ç”¨ preload æ¡¥æ¥
}
```

**ä¸ºä»€ä¹ˆè¦è¿™æ ·é…ç½®ï¼Ÿ**
- é˜²æ­¢æ¶æ„ç½‘é¡µç›´æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿ
- é€šè¿‡ preload è„šæœ¬ç²¾ç¡®æ§åˆ¶æš´éœ²çš„ API
- éµå¾ª"æœ€å°æƒé™åŸåˆ™"

---

### IPC é€šä¿¡æ¨¡å¼

**æ¸²æŸ“è¿›ç¨‹ â†’ ä¸»è¿›ç¨‹ï¼ˆåŒå‘ï¼‰**ï¼š
```javascript
// Renderer
const data = await window.electronAPI.readFile('accounts/accounts.json')

// Preload
contextBridge.exposeInMainWorld('electronAPI', {
  readFile: (path) => ipcRenderer.invoke('read-file', path),
})

// Main
ipcMain.handle('read-file', async (event, filename) => {
  // å®ç°æ–‡ä»¶è¯»å–
  return data
})
```

---

### æ–‡ä»¶å­˜å‚¨è·¯å¾„è§„èŒƒ

| æ•°æ®ç±»å‹ | å­˜å‚¨è·¯å¾„ |
|---------|---------|
| è´¦æˆ·åˆ—è¡¨ | `accounts/accounts.json` |
| é‚®ä»¶æ•°æ® | `emails/{accountId}/{folder}.json` |
| é€šè®¯å½• | `contacts/contacts.json` |
| é‚®ä»¶æ¨¡æ¿ | `templates/templates.json` |
| ç­¾å | `signatures/signatures.json` |
| åº”ç”¨é…ç½® | `settings/config.json` |

**åŸºç¡€è·¯å¾„**ï¼š`app.getPath('userData')`

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆä¿®å¤åï¼Œè¯·éªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š

- [ ] Electron åº”ç”¨æ­£å¸¸å¯åŠ¨
- [ ] æ·»åŠ  Gmail è´¦æˆ·ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰æˆåŠŸ
- [ ] æ·»åŠ  QQ/163 è´¦æˆ·æˆåŠŸ
- [ ] ç‚¹å‡»è´¦æˆ·èƒ½æ­£å¸¸ç™»å½•å¹¶è·³è½¬
- [ ] å…³é—­åº”ç”¨åé‡æ–°æ‰“å¼€ï¼Œè´¦æˆ·ä»ç„¶å­˜åœ¨
- [ ] æ§åˆ¶å°æ— æŠ¥é”™
- [ ] æ–‡ä»¶ç³»ç»Ÿä¸­å­˜åœ¨è´¦æˆ·æ•°æ®æ–‡ä»¶
- [ ] å¤šè´¦æˆ·åˆ‡æ¢æ­£å¸¸å·¥ä½œ

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®å¤‡ä»½åŠŸèƒ½

```javascript
// è‡ªåŠ¨å¤‡ä»½è´¦æˆ·æ•°æ®
ipcMain.handle('backup-data', async () => {
  const userDataPath = app.getPath('userData')
  const backupPath = path.join(userDataPath, 'backups')
  const timestamp = new Date().toISOString().replace(/:/g, '-')
  
  await fs.mkdir(backupPath, { recursive: true })
  // å¤åˆ¶æ‰€æœ‰æ•°æ®æ–‡ä»¶
})
```

### 2. æ•°æ®åŠ å¯†

```javascript
// ä½¿ç”¨ crypto-js åŠ å¯†æ•æ„Ÿæ•°æ®
import CryptoJS from 'crypto-js'

const encrypted = CryptoJS.AES.encrypt(
  JSON.stringify(accounts), 
  secretKey
).toString()
```

### 3. é”™è¯¯æ—¥å¿—è®°å½•

```javascript
// è®°å½•é”™è¯¯åˆ°æ–‡ä»¶
ipcMain.handle('log-error', async (event, error) => {
  const logPath = path.join(app.getPath('userData'), 'logs', 'error.log')
  await fs.appendFile(logPath, `${new Date().toISOString()} - ${error}\n`)
})
```

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº† Electron åº”ç”¨ä¸­çš„å…³é”®é—®é¢˜ï¼š

1. **å®‰å…¨æ€§æå‡**ï¼šå¯ç”¨äº†ä¸Šä¸‹æ–‡éš”ç¦»ï¼Œéµå¾ª Electron å®‰å…¨æœ€ä½³å®è·µ
2. **åŠŸèƒ½å®Œå–„**ï¼šå®ç°äº†å®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œè´¦æˆ·æ•°æ®å¯æŒä¹…åŒ–å­˜å‚¨
3. **ç”¨æˆ·ä½“éªŒæ”¹å–„**ï¼šä¿®å¤äº†ç‚¹å‡»è´¦æˆ·æŠ¥é”™çš„é—®é¢˜ï¼Œæ·»åŠ äº†é”™è¯¯å¤„ç†

ä¿®å¤åï¼Œç”¨æˆ·å¯ä»¥æ­£å¸¸æ·»åŠ è´¦æˆ·ã€ä¿å­˜æ•°æ®ã€åˆ‡æ¢è´¦æˆ·ï¼Œåº”ç”¨çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§éƒ½å¾—åˆ°äº†æ˜¾è‘—æå‡ã€‚

---

**ä¿®å¤æ—¶é—´**ï¼š2025-10-19  
**å½±å“ç‰ˆæœ¬**ï¼šv1.0.0  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡
