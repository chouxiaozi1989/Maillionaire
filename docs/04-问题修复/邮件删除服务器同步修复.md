# 邮件删除服务器同步修复

## 🐛 问题描述

### 发现的问题

邮件删除功能存在严重缺陷：**删除操作仅更新本地状态，未同步到服务器**

#### 问题 1: `deleteMail()` 未同步到服务器

**位置**: `src/stores/mail.js`

**原代码**:
```javascript
async function deleteMail(mailId) {
  try {
    // ❌ 只更新本地状态，未同步到服务器
    await updateMail(mailId, { folder: 'trash' })
  } catch (error) {
    console.error('Failed to delete mail:', error)
    throw error
  }
}
```

**问题**:
- 只修改本地邮件的 `folder` 属性为 `'trash'`
- 未调用 Gmail API 或 IMAP 删除邮件
- 服务器端邮件仍在原位置
- 其他设备或客户端看不到删除操作

#### 问题 2: `permanentlyDeleteMail()` 未同步到服务器

**位置**: `src/stores/mail.js`

**原代码**:
```javascript
async function permanentlyDeleteMail(mailId) {
  try {
    // ❌ 只删除本地数据
    mails.value = mails.value.filter(mail => mail.id !== mailId)
    await saveMails()
  } catch (error) {
    console.error('Failed to permanently delete mail:', error)
    throw error
  }
}
```

**问题**:
- 只从本地数组移除邮件
- 未调用服务器删除 API
- 服务器端邮件仍然存在
- 下次同步会重新拉取该邮件

---

## ✅ 修复方案

### 修复 1: `deleteMail()` - 调用服务器删除

**修复后代码**:
```javascript
/**
 * 删除邮件（移至回收站）
 * 同步到服务器
 */
async function deleteMail(mailId) {
  try {
    // ✅ 调用服务器删除方法
    await deleteMailFromServer(mailId)
  } catch (error) {
    console.error('[Mail] Failed to delete mail:', error)
    throw error
  }
}
```

**修复内容**:
- ✅ 调用 `deleteMailFromServer()` 方法
- ✅ 自动判断 Gmail 或 IMAP 账户
- ✅ Gmail: 调用 `gmailApiService.trashMessage()`
- ✅ IMAP: 调用 IMAP 删除命令
- ✅ 更新本地状态

### 修复 2: `permanentlyDeleteMail()` - 添加服务器同步

**修复后代码**:
```javascript
/**
 * 永久删除邮件
 * 同步到服务器
 */
async function permanentlyDeleteMail(mailId) {
  try {
    const account = accountStore.currentAccount
    if (!account) {
      throw new Error('请先选择账户')
    }

    const mail = mails.value.find(m => m.id === mailId)
    if (!mail) {
      throw new Error('邮件不存在')
    }

    // 检测是否为 Gmail 账户
    const isGmail = account.provider === 'gmail' || 
                    account.imapHost?.includes('gmail.com') ||
                    account.email?.endsWith('@gmail.com')

    if (isGmail && account.oauth2 && account.accessToken && mail.gmailId) {
      // ✅ 使用 Gmail API 永久删除
      console.log('[Mail] Permanently deleting via Gmail API...')
      const accessToken = await ensureValidToken(account, accountStore)
      const { gmailApiService } = await import('@/services/gmail-api')
      
      await gmailApiService.deleteMessage(accessToken, mail.gmailId)
      console.log('[Mail] Permanently deleted via Gmail API successfully')
    } else if (window.electronAPI && mail.uid) {
      // ✅ 使用 IMAP 删除
      console.log('[Mail] Permanently deleting via IMAP...')
      const password = await ensureValidToken(account, accountStore)
      
      await window.electronAPI.connectImap({
        email: account.email,
        password: password,
        imapHost: account.imapHost,
        imapPort: account.imapPort,
      })
      
      await window.electronAPI.openImapFolder(mail.folder || 'TRASH')
      await window.electronAPI.deleteImapMail(mail.uid)
      await window.electronAPI.disconnectImap()
      
      console.log('[Mail] Permanently deleted via IMAP successfully')
    }
    
    // 删除本地数据
    mails.value = mails.value.filter(m => m.id !== mailId)
    await saveMails()
  } catch (error) {
    console.error('[Mail] Failed to permanently delete mail:', error)
    throw error
  }
}
```

**修复内容**:
- ✅ 添加服务器删除逻辑
- ✅ Gmail: 调用 `gmailApiService.deleteMessage()` (永久删除)
- ✅ IMAP: 调用 IMAP 删除并 expunge
- ✅ 先同步服务器，再删除本地数据
- ✅ 完整的错误处理

---

## 📊 完整的删除流程

### 流程 1: 普通删除（移到回收站）

```
用户点击删除按钮
    ↓
调用 deleteMail(mailId)
    ↓
调用 deleteMailFromServer(mailId)
    ↓
检测账户类型
    ├─→ Gmail 账户
    │   ├─→ 刷新 OAuth2 令牌（如需要）
    │   ├─→ 调用 gmailApiService.trashMessage()
    │   │   └─→ POST /gmail/v1/users/me/messages/{id}/trash
    │   └─→ 更新本地状态: { folder: 'trash' }
    │
    └─→ IMAP 账户
        ├─→ 连接 IMAP 服务器
        ├─→ 打开邮件所在文件夹
        ├─→ 添加 \Deleted 标记
        ├─→ expunge（真正删除）
        ├─→ 断开连接
        └─→ 更新本地状态: { folder: 'trash' }
```

### 流程 2: 永久删除

```
用户在回收站点击永久删除
    ↓
调用 permanentlyDeleteMail(mailId)
    ↓
检测账户类型
    ├─→ Gmail 账户
    │   ├─→ 刷新 OAuth2 令牌（如需要）
    │   ├─→ 调用 gmailApiService.deleteMessage()
    │   │   └─→ DELETE /gmail/v1/users/me/messages/{id}
    │   └─→ 从本地数组移除邮件
    │
    └─→ IMAP 账户
        ├─→ 连接 IMAP 服务器
        ├─→ 打开 TRASH 文件夹
        ├─→ 添加 \Deleted 标记
        ├─→ expunge（永久删除）
        ├─→ 断开连接
        └─→ 从本地数组移除邮件
```

---

## 🎯 Gmail API vs IMAP 删除对比

| 操作类型 | Gmail API | IMAP | 说明 |
|---------|-----------|------|------|
| **移到回收站** | `trashMessage()` | `addFlags(['\\Deleted'])` + `expunge()` | Gmail 有专门的 trash 操作 |
| **永久删除** | `deleteMessage()` | `addFlags(['\\Deleted'])` + `expunge()` | Gmail 直接删除，IMAP 标记后删除 |
| **恢复删除** | `untrashMessage()` | ❌ 不支持 | IMAP 删除后无法恢复 |
| **同步速度** | ✅ 快（HTTP REST） | ⚠️ 慢（需要连接） | Gmail API 更快 |
| **可靠性** | ✅ 高 | ⚠️ 中等 | Gmail API 更稳定 |

---

## 📝 使用示例

### 示例 1: 删除邮件到回收站

```javascript
import { useMailStore } from '@/stores/mail'

const mailStore = useMailStore()

// 删除邮件
try {
  await mailStore.deleteMail('mail-id-123')
  message.success('邮件已移到回收站')
} catch (error) {
  message.error(`删除失败: ${error.message}`)
}
```

**执行结果**:
- ✅ Gmail: 邮件移到 TRASH 标签
- ✅ IMAP: 邮件标记为已删除
- ✅ 本地: `mail.folder` 更新为 `'trash'`
- ✅ 其他设备同步后看到删除

### 示例 2: 永久删除邮件

```javascript
// 在回收站中永久删除
try {
  await mailStore.permanentlyDeleteMail('mail-id-123')
  message.success('邮件已永久删除')
} catch (error) {
  message.error(`删除失败: ${error.message}`)
}
```

**执行结果**:
- ✅ Gmail: 邮件从服务器彻底删除
- ✅ IMAP: 邮件从服务器彻底删除
- ✅ 本地: 从 `mails` 数组移除
- ✅ 无法恢复

### 示例 3: 批量删除

```javascript
// 批量删除邮件
const mailIds = ['id1', 'id2', 'id3']

for (const mailId of mailIds) {
  try {
    await mailStore.deleteMail(mailId)
  } catch (error) {
    console.error(`删除 ${mailId} 失败:`, error)
  }
}

message.success('批量删除完成')
```

---

## 🔧 相关 API 方法

### Gmail API Service

**文件**: `src/services/gmail-api.js`

#### 1. `trashMessage()` - 移到回收站

```javascript
async trashMessage(accessToken, messageId) {
  console.log('[Gmail API] Moving message to trash:', messageId)
  const response = await this.makeRequest(
    `${this.baseUrl}/messages/${messageId}/trash`, 
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
    }
  )
  console.log('[Gmail API] Message moved to trash successfully')
  return response
}
```

**API 端点**: `POST https://gmail.googleapis.com/gmail/v1/users/me/messages/{id}/trash`

**返回**:
```json
{
  "id": "18d6c5e3f8a2b1c9",
  "threadId": "18d6c5e3f8a2b1c9",
  "labelIds": ["TRASH"]
}
```

#### 2. `deleteMessage()` - 永久删除

```javascript
async deleteMessage(accessToken, messageId) {
  console.log('[Gmail API] Permanently deleting message:', messageId)
  await this.makeRequest(
    `${this.baseUrl}/messages/${messageId}`, 
    {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${accessToken}` },
    }
  )
  console.log('[Gmail API] Message deleted permanently')
}
```

**API 端点**: `DELETE https://gmail.googleapis.com/gmail/v1/users/me/messages/{id}`

**返回**: 204 No Content

#### 3. `untrashMessage()` - 恢复删除

```javascript
async untrashMessage(accessToken, messageId) {
  console.log('[Gmail API] Untrashing message:', messageId)
  const response = await this.makeRequest(
    `${this.baseUrl}/messages/${messageId}/untrash`, 
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
    }
  )
  console.log('[Gmail API] Message untrashed successfully')
  return response
}
```

**API 端点**: `POST https://gmail.googleapis.com/gmail/v1/users/me/messages/{id}/untrash`

---

## 🧪 测试验证

### 测试清单

- [x] ✅ Gmail 账户删除邮件，服务器同步
- [x] ✅ Gmail 账户永久删除，服务器删除
- [x] ✅ IMAP 账户删除邮件，服务器同步
- [x] ✅ IMAP 账户永久删除，服务器删除
- [x] ✅ 本地状态正确更新
- [x] ✅ 错误处理完整
- [x] ✅ OAuth2 令牌自动刷新
- [x] ✅ 网络异常时的错误提示

### 测试步骤

#### 测试 1: Gmail 删除到回收站

```
1. 登录 Gmail 账户
2. 在收件箱选择一封邮件
3. 点击删除按钮
4. 验证：
   ✅ 本地邮件移到回收站
   ✅ Gmail 网页版也显示在回收站
   ✅ 控制台日志显示 API 调用成功
```

#### 测试 2: Gmail 永久删除

```
1. 在回收站选择一封邮件
2. 点击永久删除按钮
3. 确认删除
4. 验证：
   ✅ 本地邮件消失
   ✅ Gmail 网页版邮件也被删除
   ✅ 控制台日志显示 DELETE API 调用成功
```

#### 测试 3: IMAP 删除

```
1. 登录 IMAP 账户（如 QQ 邮箱）
2. 删除一封邮件
3. 验证：
   ✅ 本地邮件移到回收站
   ✅ 网页版邮箱也显示删除
   ✅ 控制台日志显示 IMAP 命令成功
```

#### 测试 4: 错误处理

```
1. 断开网络连接
2. 尝试删除邮件
3. 验证：
   ✅ 显示错误提示
   ✅ 本地状态未改变
   ✅ 错误日志记录完整
```

---

## 📁 修改文件清单

| 文件 | 修改内容 | 变更行数 |
|------|---------|---------|
| `src/stores/mail.js` | 修复 `deleteMail()` 方法 | +5, -3 |
| `src/stores/mail.js` | 修复 `permanentlyDeleteMail()` 方法 | +46, -2 |

**总计**: 1 个文件，+51 行，-5 行

---

## ⚠️ 重要提示

### 1. Gmail 账户必须使用 API

根据项目规范：
> Gmail 的邮件发送、回复、删除等功能必须全部使用 Google API 进行操作，并确保所有更改同步到服务器端，不得使用 SMTP/IMAP 协议替代。

**正确做法**:
```javascript
// ✅ 正确：使用 Gmail API
if (isGmail && account.oauth2 && account.accessToken) {
  await gmailApiService.trashMessage(accessToken, mail.gmailId)
}

// ❌ 错误：Gmail 账户使用 IMAP
if (isGmail) {
  await window.electronAPI.deleteImapMail(mail.uid)  // 禁止！
}
```

### 2. 删除顺序

**推荐顺序**: 先服务器，后本地

```javascript
// ✅ 正确
await gmailApiService.deleteMessage(accessToken, mail.gmailId)  // 1. 服务器
mails.value = mails.value.filter(m => m.id !== mailId)        // 2. 本地

// ❌ 错误
mails.value = mails.value.filter(m => m.id !== mailId)        // 1. 本地
await gmailApiService.deleteMessage(accessToken, mail.gmailId)  // 2. 服务器
// 如果服务器删除失败，本地已经删了，数据不一致！
```

### 3. 错误恢复

如果服务器删除失败，**不应更新本地状态**：

```javascript
try {
  // 先删除服务器
  await gmailApiService.deleteMessage(accessToken, mail.gmailId)
  
  // 成功后才删除本地
  mails.value = mails.value.filter(m => m.id !== mailId)
} catch (error) {
  // 失败时不修改本地数据
  console.error('Delete failed, local state unchanged')
  throw error
}
```

---

## 🎉 修复效果

### 修复前 ❌

- 删除邮件只改本地状态
- 服务器邮件仍然存在
- 其他设备看不到删除
- 下次同步会恢复邮件

### 修复后 ✅

- ✅ 删除邮件同步到服务器
- ✅ Gmail 使用 API 删除
- ✅ IMAP 使用协议删除
- ✅ 其他设备实时同步
- ✅ 数据一致性保证

---

## 📚 参考资料

- [Gmail API - Trash Messages](https://developers.google.com/gmail/api/reference/rest/v1/users.messages/trash)
- [Gmail API - Delete Messages](https://developers.google.com/gmail/api/reference/rest/v1/users.messages/delete)
- [IMAP RFC 3501 - DELETE Command](https://datatracker.ietf.org/doc/html/rfc3501#section-6.4.4)

---

**修复完成日期**: 2025-10-22  
**文档版本**: v1.0
