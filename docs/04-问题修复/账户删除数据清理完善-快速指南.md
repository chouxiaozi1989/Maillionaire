# 账户删除数据清理完善 - 快速指南

## 🎯 问题

删除邮箱账户后，本地存储中该账户的**自定义文件夹邮件数据未被删除**！

## ❌ 修复前

只删除系统文件夹（inbox、sent、drafts、trash、starred）的邮件：

```javascript
// 硬编码5个系统文件夹
const folders = ['inbox', 'sent', 'drafts', 'trash', 'starred']

// ❌ 自定义文件夹的邮件数据残留
```

**问题**：
- ❌ 自定义文件夹"工作邮件"的数据未删除
- ❌ 服务器同步的文件夹数据未删除
- ❌ 数据泄露风险
- ❌ 浪费存储空间

---

## ✅ 修复后

动态获取所有文件夹（包括自定义），完整删除：

```javascript
// ✅ 从配置文件读取所有文件夹
const foldersData = await this.readJSON('folders.json')
const folderIds = foldersData?.folders.map(f => f.id) || []

// ✅ 删除所有文件夹的邮件数据
for (const folderId of folderIds) {
  await this.deleteFile(`emails/${accountId}/${folderId}.json`)
}
```

**改进**：
- ✅ 删除所有系统文件夹的邮件
- ✅ 删除所有自定义文件夹的邮件
- ✅ 删除所有服务器同步文件夹的邮件
- ✅ 详细的删除日志
- ✅ 智能的错误处理

---

## 🔧 修改的文件

**文件**：[`src/services/storage.js`](file://c:\Users\Administrator\Documents\Maillionaire\src\services\storage.js#L160-L210)

**方法**：`deleteAccountData(accountId)`

**修改内容**：
- 新增：动态读取 `folders.json` 获取所有文件夹
- 修改：遍历所有文件夹ID（而非硬编码列表）
- 增强：详细的日志记录
- 优化：智能的错误处理

---

## 📋 测试验证

### 测试步骤

1. **创建测试账户**：
   ```
   添加一个 QQ 邮箱账户
   ```

2. **创建自定义文件夹**：
   ```
   主界面 → 点击"新建文件夹"
   创建"工作邮件"和"个人邮件"
   ```

3. **接收邮件**：
   ```
   在各个文件夹中接收一些邮件
   ```

4. **删除账户**：
   ```
   设置 → 账户管理 → 删除账户
   ```

5. **检查日志**：
   ```
   控制台应显示：
   [Storage] Found 7 folders to clean: [...]
   [Storage] ✓ Deleted emails/qq_xxxx/inbox.json
   [Storage] ✓ Deleted emails/qq_xxxx/work.json       ← 自定义文件夹
   [Storage] ✓ Deleted emails/qq_xxxx/personal.json   ← 自定义文件夹
   [Storage] Successfully deleted 7 email data files
   ```

### 预期结果

**修复前**：
```
emails/qq_xxxx/inbox.json        ✓ 已删除
emails/qq_xxxx/sent.json         ✓ 已删除
emails/qq_xxxx/work.json         ✗ 残留 ← 问题！
emails/qq_xxxx/personal.json     ✗ 残留 ← 问题！
```

**修复后**：
```
emails/qq_xxxx/inbox.json        ✓ 已删除
emails/qq_xxxx/sent.json         ✓ 已删除
emails/qq_xxxx/work.json         ✓ 已删除 ← 修复！
emails/qq_xxxx/personal.json     ✓ 已删除 ← 修复！
```

---

## 📊 影响范围

### 直接影响
- ✅ `src/services/storage.js` - `deleteAccountData()` 方法

### 无需修改
- ⭕ `src/stores/account.js` - 调用层无需修改
- ⭕ `src/views/Settings.vue` - UI层无需修改
- ⭕ `src/views/Login.vue` - UI层无需修改

---

## ⚠️ 重要提示

### 1. 删除不可逆

删除账户会永久删除所有邮件数据：
- 收件箱、已发送、草稿箱、回收站
- 所有自定义文件夹
- 所有服务器同步的文件夹

**建议**：在删除前提示用户确认

### 2. 日志追踪

删除时会输出详细日志：
```
[Storage] Starting to delete all data for account xxx...
[Storage] Found N folders to clean: [...]
[Storage] ✓ Deleted emails/xxx/folder1.json
[Storage] ✓ Deleted emails/xxx/folder2.json
...
[Storage] Successfully deleted N email data files
[Storage] ✓ Account xxx data deletion completed successfully
```

### 3. 空文件夹处理

如果某个文件夹还没有邮件（文件不存在），删除操作会自动跳过，不会报错。

---

## 🎯 修复效果

| 指标 | 修复前 | 修复后 |
|------|--------|--------|
| 系统文件夹 | ✓ 删除 | ✓ 删除 |
| 自定义文件夹 | ✗ 残留 | ✓ 删除 |
| 服务器同步文件夹 | ✗ 残留 | ✓ 删除 |
| 日志详细度 | 简单 | 详细 |
| 错误处理 | 基础 | 智能 |
| 数据安全 | 有风险 | 安全 |

---

## 🔗 相关文档

- 详细文档：[账户删除数据清理完善.md](./账户删除数据清理完善.md)
- 相关功能：[账户删除功能增强.md](./账户删除功能增强.md)

---

**修复时间**：2025-10-22  
**文档版本**：1.0.0
