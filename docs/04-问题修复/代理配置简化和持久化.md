# 代理配置简化和持久化修复

## 更新日期

2025-10-19

## 问题描述

### 问题 1：代理协议选项过多

**现象**：
- 代理设置界面提供了 SOCKS5、SOCKS4、HTTP、HTTPS 四个选项
- 用户容易混淆，不知道该选哪个
- SOCKS 代理配置相对复杂

**用户反馈**：
- "不知道该选哪个协议"
- "SOCKS 是什么？"
- "能不能简化一下？"

### 问题 2：代理配置未持久化

**错误日志**：
```
[IMAP] Connecting to imap.gmail.com:993
[IMAP] Proxy not enabled, using direct connection
[IMAP] Connection error: Error: connect ETIMEDOUT 173.194.203.108:993
```

**问题分析**：
1. 用户在设置界面保存了代理配置
2. 重启应用后，代理配置丢失
3. IMAP 服务显示"Proxy not enabled"
4. 直接连接 Gmail 超时

**根本原因**：
- 前端使用 `localStorage` 保存配置
- 主进程的 `proxyConfig` 变量初始为 `null`
- 应用启动时没有加载已保存的配置
- 导致 IMAP/SMTP 服务无法使用代理

## 解决方案

### 1. 简化代理协议选项

#### 修改前

```vue
<a-select-option value="socks5">SOCKS5</a-select-option>
<a-select-option value="socks4">SOCKS4</a-select-option>
<a-select-option value="http">HTTP</a-select-option>
<a-select-option value="https">HTTPS</a-select-option>
```

**问题**：
- 4 个选项，用户不知道选哪个
- SOCKS 协议对普通用户不友好

#### 修改后

```vue
<a-select-option value="http">HTTP</a-select-option>
<a-select-option value="https">HTTPS</a-select-option>
```

**改进**：
- ✅ 只保留 HTTP/HTTPS 两个选项
- ✅ 更直观，用户更容易理解
- ✅ 与常见代理工具一致

#### 修改默认协议

**文件**：`src/config/proxy.js`

```javascript
// 修改前
export const DEFAULT_PROXY_CONFIG = {
  enabled: false,
  protocol: 'socks5',  // ❌ 默认 SOCKS5
  host: '127.0.0.1',
  port: 7890,
  // ...
}

// 修改后
export const DEFAULT_PROXY_CONFIG = {
  enabled: false,
  protocol: 'http',  // ✅ 默认 HTTP
  host: '127.0.0.1',
  port: 7890,
  // ...
}
```

### 2. 实现代理配置持久化

#### A. 保存配置到文件

**文件**：`electron/main.js`

```javascript
// 设置代理配置
ipcMain.handle('set-proxy-config', async (event, config) => {
  try {
    proxyConfig = config;
    
    // ✅ 保存到文件
    const configPath = path.join(app.getPath('userData'), 'proxy-config.json');
    await fs.writeFile(configPath, JSON.stringify(config, null, 2), 'utf-8');
    console.log('[Proxy] Config saved to:', configPath);
    
    // 应用代理到服务
    if (imapService) {
      imapService.setProxyConfig(config);
    }
    if (smtpService) {
      smtpService.setProxyConfig(config);
    }
    
    // ...
  }
});
```

**保存位置**：
- Windows: `C:\Users\{用户名}\AppData\Roaming\Maillionaire\proxy-config.json`
- macOS: `~/Library/Application Support/Maillionaire/proxy-config.json`
- Linux: `~/.config/Maillionaire/proxy-config.json`

#### B. 应用启动时加载配置

```javascript
app.whenReady().then(async () => {
  createWindow();
  
  // ✅ 加载保存的代理配置
  try {
    const configPath = path.join(app.getPath('userData'), 'proxy-config.json');
    const configData = await fs.readFile(configPath, 'utf-8');
    proxyConfig = JSON.parse(configData);
    console.log('[Proxy] Loaded saved config:', proxyConfig?.enabled ? 'enabled' : 'disabled');
    
    // 应用到服务
    if (proxyConfig) {
      if (imapService) {
        imapService.setProxyConfig(proxyConfig);
      }
      if (smtpService) {
        smtpService.setProxyConfig(proxyConfig);
      }
      
      // 设置 Electron session 代理
      if (proxyConfig.enabled) {
        const { protocol, host, port } = proxyConfig;
        await session.defaultSession.setProxy({
          proxyRules: `${protocol}://${host}:${port}`,
          proxyBypassRules: 'localhost,127.0.0.1'
        });
        console.log('[Proxy] Proxy enabled on startup:', `${protocol}://${host}:${port}`);
      }
    }
  } catch (error) {
    // 配置文件不存在或解析失败，使用默认配置
    console.log('[Proxy] No saved config found, using defaults');
    proxyConfig = {
      enabled: false,
      protocol: 'http',
      host: '127.0.0.1',
      port: 7890,
      auth: { enabled: false, username: '', password: '' }
    };
  }
});
```

#### C. 配置加载流程

```
应用启动
    ↓
读取 proxy-config.json
    ↓
配置存在? ──→ 是 ──→ 解析 JSON
    │                    ↓
    │              应用到 IMAP/SMTP 服务
    │                    ↓
    │              设置 Electron session 代理
    │                    ↓
    │                  完成 ✅
    ↓
   否
    ↓
使用默认配置
    ↓
  完成 ✅
```

## 技术细节

### 1. 配置文件格式

**文件**：`proxy-config.json`

```json
{
  "enabled": true,
  "protocol": "http",
  "host": "127.0.0.1",
  "port": 7890,
  "auth": {
    "enabled": true,
    "username": "user",
    "password": "pass"
  }
}
```

**字段说明**：
- `enabled`: 是否启用代理
- `protocol`: 代理协议（http/https）
- `host`: 代理服务器地址
- `port`: 代理服务器端口
- `auth.enabled`: 是否启用认证
- `auth.username`: 认证用户名
- `auth.password`: 认证密码

### 2. 双重存储机制

#### 前端存储（localStorage）

**用途**：
- 界面状态恢复
- 快速读取配置

**位置**：
- 浏览器 localStorage
- 键名：`proxy_config`

#### 后端存储（文件）

**用途**：
- 持久化存储
- 跨进程共享
- 应用启动时加载

**位置**：
- 用户数据目录
- 文件名：`proxy-config.json`

### 3. 配置同步流程

```
用户修改设置
    ↓
保存到 localStorage (前端)
    ↓
通过 IPC 发送到主进程
    ↓
保存到 proxy-config.json (后端)
    ↓
应用到 IMAP/SMTP 服务
    ↓
设置 Electron session 代理
    ↓
完成 ✅
```

### 4. HTTP vs HTTPS 代理

| 特性 | HTTP 代理 | HTTPS 代理 |
|------|----------|-----------|
| **加密** | 客户端到代理：未加密 | 客户端到代理：加密 |
| **性能** | 更快 | 稍慢 |
| **安全** | 较低 | 较高 |
| **兼容性** | 广泛支持 | 广泛支持 |
| **推荐场景** | 内网环境 | 公网环境 |

**说明**：
- 无论使用 HTTP 还是 HTTPS 代理，IMAP/SMTP 流量本身都是加密的（TLS）
- HTTP 代理更快，适合内网或可信环境
- HTTPS 代理更安全，适合公网或不可信环境

## 测试验证

### 测试场景 1：新用户首次启动

**操作**：
1. 首次启动应用（无配置文件）

**预期**：
```
[Proxy] No saved config found, using defaults
```

**结果**：✅ 使用默认配置（HTTP 代理，未启用）

### 测试场景 2：保存配置并重启

**操作**：
1. 在设置界面启用代理
2. 配置为 `http://127.0.0.1:7890`
3. 保存设置
4. 重启应用

**预期日志**：
```
[Proxy] Config saved to: C:\Users\...\AppData\Roaming\Maillionaire\proxy-config.json
[Proxy] Loaded saved config: enabled
[Proxy] Proxy enabled on startup: http://127.0.0.1:7890
```

**验证**：
1. 检查配置文件存在 ✅
2. IMAP 服务使用代理 ✅
3. Gmail 连接成功 ✅

### 测试场景 3：同步 Gmail 文件夹

**操作**：
1. 启用代理
2. 点击同步文件夹

**修复前日志**：
```
[IMAP] Proxy not enabled, using direct connection ❌
[IMAP] Connection error: ETIMEDOUT
```

**修复后日志**：
```
[IMAP] Loaded saved config: enabled ✅
[IMAP] Creating proxy socket: http://127.0.0.1:7890 ✅
[IMAP] Using HTTP/HTTPS proxy with CONNECT method ✅
[IMAP] HTTP CONNECT successful, tunnel established ✅
[IMAP] Connection ready ✅
```

### 测试场景 4：禁用代理

**操作**：
1. 在设置界面禁用代理
2. 保存设置
3. 重启应用

**预期**：
```
[Proxy] Loaded saved config: disabled
[IMAP] Proxy not enabled, using direct connection
```

**结果**：✅ 使用直连，无代理

## 用户体验改进

### 简化前

**代理协议选择**：
```
┌─────────────────────┐
│ SOCKS5  ← 什么是这个？│
│ SOCKS4  ← 这个又是啥？│
│ HTTP    ← 选这个？    │
│ HTTPS   ← 还是这个？  │
└─────────────────────┘
```

**用户困惑**：
- 不知道 SOCKS 是什么
- 不知道该选哪个
- 配置复杂

### 简化后

**代理协议选择**：
```
┌─────────────────────┐
│ HTTP    ← 内网用这个  │
│ HTTPS   ← 公网用这个  │
└─────────────────────┘
```

**用户体验**：
- ✅ 选项清晰
- ✅ 易于理解
- ✅ 配置简单

### 配置持久化改进

**修复前**：
```
用户：保存代理设置 → 重启应用 → 代理失效 → 😡 又要重新配置
```

**修复后**：
```
用户：保存代理设置 → 重启应用 → 代理自动生效 → 😊 太方便了
```

## 最佳实践

### 1. 代理配置推荐

**内网环境**：
```json
{
  "enabled": true,
  "protocol": "http",
  "host": "127.0.0.1",
  "port": 7890,
  "auth": { "enabled": false }
}
```

**公网环境**：
```json
{
  "enabled": true,
  "protocol": "https",
  "host": "proxy.example.com",
  "port": 8080,
  "auth": {
    "enabled": true,
    "username": "user",
    "password": "pass"
  }
}
```

### 2. 故障排查

#### 代理未生效

**症状**：
```
[IMAP] Proxy not enabled, using direct connection
```

**检查清单**：
1. ✅ 代理是否启用（`enabled: true`）
2. ✅ 配置文件是否存在
3. ✅ 配置是否保存成功
4. ✅ 应用是否重启

**解决方法**：
```bash
# Windows
type %APPDATA%\Maillionaire\proxy-config.json

# macOS/Linux
cat ~/Library/Application\ Support/Maillionaire/proxy-config.json
```

#### 配置丢失

**症状**：重启应用后代理失效

**原因**：
1. 配置文件未创建
2. 配置文件损坏
3. 读取权限问题

**解决方法**：
1. 重新保存配置
2. 检查文件权限
3. 查看应用日志

### 3. 迁移旧配置

如果之前使用 SOCKS 代理：

**旧配置**：
```json
{
  "protocol": "socks5",
  "host": "127.0.0.1",
  "port": 7890
}
```

**迁移方法**：
1. 打开设置界面
2. 协议改为 "HTTP"
3. 保存配置
4. 测试连接

**注意**：
- ⚠️ 代理服务器必须支持 HTTP CONNECT 方法
- ⚠️ 如果代理只支持 SOCKS，需要更换代理

## 注意事项

### 1. 配置文件安全

**敏感信息**：
- 代理认证密码以明文存储在配置文件中
- 建议使用文件系统权限保护

**改进方向**：
- 使用加密存储密码
- 集成系统密钥链

### 2. 协议兼容性

**HTTP/HTTPS 代理要求**：
- 必须支持 HTTP CONNECT 方法
- 必须允许 993 端口（IMAP over TLS）
- 必须允许 465/587 端口（SMTP）

**不兼容的代理**：
- 仅支持 HTTP GET/POST 的 Web 代理
- 限制端口的防火墙代理

### 3. 性能考虑

**配置加载时机**：
- 应用启动时加载（异步）
- 不会阻塞窗口创建
- 配置错误不影响应用启动

**内存占用**：
- 配置文件很小（< 1KB）
- 不会影响性能

## 相关文档

- [代理配置功能实现](../03-功能实现/代理配置功能实现.md)
- [IMAP 支持 HTTP 代理](./IMAP支持HTTP代理.md)
- [代理 TLS 连接错误修复](./代理TLS连接错误修复.md)

## 更新历史

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2025-10-19 | 1.0.0 | 初始版本，简化代理协议选项并实现配置持久化 |
