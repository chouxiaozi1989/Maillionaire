# 打包后应用无法加载资源问题修复

## 问题描述

**症状**：
- Windows 平台打包后的 `.exe` 文件运行时界面空白
- 开发者工具控制台显示错误：`Failed to load resource: net::ERR_FILE_NOT_FOUND`
- 应用无法正常加载 HTML、CSS、JavaScript 等资源文件

**影响版本**：v1.2.0 之前的版本

## 问题原因

### 1. Vite 配置问题
- `vite.config.js` 中的 `base` 配置依赖环境变量 `ELECTRON`
- 打包时如果环境变量未设置，会使用绝对路径 `/` 而非相对路径 `./`
- Electron 打包后使用 `file://` 协议加载本地文件，绝对路径会导致找不到资源

### 2. 资源路径解析
- 打包后的目录结构：
  ```
  resources/
  └── app.asar/
      ├── dist/          # Web 资源
      └── electron/      # Electron 代码
  ```
- 使用绝对路径时，浏览器会尝试从文件系统根目录查找资源
- 正确的做法是使用相对于 `index.html` 的相对路径

## 修复方案

### 1. 修复 vite.config.js

**修改前**：
```javascript
export default defineConfig({
  // ...
  base: process.env.ELECTRON === 'true' ? './' : '/',
  // ...
})
```

**修改后**：
```javascript
export default defineConfig({
  // ...
  // 使用相对路径，确保 Electron 打包后能正确加载资源
  base: './',
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    emptyOutDir: true,
    // 确保生成的路径使用相对路径
    rollupOptions: {
      output: {
        manualChunks: undefined,
      },
    },
  },
  // ...
})
```

**改进点**：
- 移除环境变量依赖，直接使用相对路径
- 添加 `rollupOptions` 优化打包输出
- 确保所有资源引用使用相对路径

### 2. 优化 electron/main.js

**添加日志和错误处理**：
```javascript
function createWindow() {
  // ...
  if (isDev) {
    mainWindow.loadURL('http://localhost:5173');
    mainWindow.webContents.openDevTools();
  } else {
    // 使用 protocol 加载本地文件，确保路径正确
    const indexPath = path.join(__dirname, '../dist/index.html');
    console.log('[Main] Loading index.html from:', indexPath);
    mainWindow.loadFile(indexPath);
  }

  // 监听加载失败事件
  mainWindow.webContents.on('did-fail-load', (event, errorCode, errorDescription) => {
    console.error('[Main] Failed to load:', errorCode, errorDescription);
  });
}
```

**改进点**：
- 添加资源加载路径日志，便于排查问题
- 添加 `did-fail-load` 事件监听，及时发现加载失败
- 使用 `path.join` 确保路径跨平台兼容

### 3. 优化 package.json 打包配置

**添加详细的 electron-builder 配置**：
```json
{
  "build": {
    "appId": "com.maillionaire.app",
    "productName": "Maillionaire",
    "directories": {
      "output": "dist-electron",
      "buildResources": "build"
    },
    "files": [
      "dist/**/*",
      "electron/**/*",
      "package.json",
      "!electron/node_modules",
      "!**/*.{ts,tsx}",
      "!**/*.map"
    ],
    "extraResources": [
      {
        "from": "dist",
        "to": "dist",
        "filter": ["**/*"]
      }
    ],
    "win": {
      "target": ["nsis"],
      "icon": "build/icon.ico",
      "artifactName": "${productName} Setup ${version}.${ext}"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true
    }
  }
}
```

**改进点**：
- 添加 `buildResources` 目录配置
- 使用 `extraResources` 确保 dist 目录完整打包
- 排除不必要的文件（`.map`、`.ts`等）
- 添加 NSIS 安装器详细配置

## 验证修复

### 1. 清理旧的构建文件

```bash
# Windows PowerShell
Remove-Item -Recurse -Force dist, dist-electron

# macOS/Linux
rm -rf dist dist-electron
```

### 2. 重新构建 Web 资源

```bash
npm run build
```

**检查构建结果**：
- `dist/index.html` 存在
- `dist/assets/` 目录包含 JS 和 CSS 文件
- 打开 `dist/index.html`，检查资源引用是否使用相对路径：
  ```html
  <script type="module" crossorigin src="./assets/index-abc123.js"></script>
  <link rel="stylesheet" href="./assets/index-def456.css">
  ```

### 3. 打包 Windows 应用

```bash
npm run package:win
```

### 4. 测试解压版本（快速测试）

```bash
# 运行解压版本
.\dist-electron\win-unpacked\Maillionaire.exe
```

**检查点**：
- ✅ 应用窗口正常打开
- ✅ 界面正常显示（不是空白）
- ✅ 可以正常使用各项功能
- ✅ 控制台无 ERR_FILE_NOT_FOUND 错误

### 5. 测试安装包（完整测试）

```bash
# 运行安装包
.\dist-electron\Maillionaire Setup 1.2.0.exe
```

**安装并测试**：
1. 完成安装流程
2. 从开始菜单或桌面快捷方式启动应用
3. 验证所有功能正常

## 调试技巧

### 1. 查看控制台日志

打包后的应用默认不显示控制台。如需查看日志：

**方法 1：修改 main.js（临时）**
```javascript
if (isDev) {
  mainWindow.loadURL('http://localhost:5173');
  mainWindow.webContents.openDevTools();
} else {
  const indexPath = path.join(__dirname, '../dist/index.html');
  console.log('[Main] Loading index.html from:', indexPath);
  mainWindow.loadFile(indexPath);
  // 临时打开开发者工具
  mainWindow.webContents.openDevTools();
}
```

**方法 2：使用日志文件**
```javascript
const log = require('electron-log');
log.transports.file.level = 'info';
log.info('[Main] Loading index.html from:', indexPath);
```

### 2. 检查打包内容

**方法 1：查看 asar 文件内容**
```bash
# 安装 asar 工具
npm install -g asar

# 解压 asar 文件
asar extract dist-electron/win-unpacked/resources/app.asar extracted-app

# 查看目录结构
tree extracted-app
```

**方法 2：使用 electron-builder 的调试模式**
```bash
# 设置环境变量
set DEBUG=electron-builder

# 重新打包
npm run package:win
```

### 3. 常见问题排查

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 界面空白，无报错 | dist 目录未打包进去 | 检查 package.json 的 files 配置 |
| ERR_FILE_NOT_FOUND | 路径错误，使用了绝对路径 | 检查 vite.config.js 的 base 配置 |
| 样式丢失 | CSS 文件路径错误 | 检查构建后的 index.html 中的资源引用 |
| 部分资源加载失败 | 资源文件被排除 | 检查 electron-builder 的 files 配置 |

## 影响分析

### 修复前后对比

#### 修复前
- ❌ 打包后应用无法使用
- ❌ 界面空白
- ❌ 控制台报错

#### 修复后
- ✅ 打包后应用正常运行
- ✅ 界面完整显示
- ✅ 所有功能正常
- ✅ 无资源加载错误

### 兼容性

- ✅ 不影响开发模式（`npm run electron:dev`）
- ✅ 不影响 Web 开发（`npm run dev`）
- ✅ 支持 Windows/macOS/Linux 三平台
- ✅ 向后兼容，不影响已有代码

## 后续优化建议

### 1. 添加自动化测试

```bash
# 在 CI/CD 中添加打包测试
npm run build
npm run package:win
# 自动验证打包结果
```

### 2. 使用 electron-builder 的验证功能

```json
{
  "build": {
    "afterPack": "./scripts/verify-pack.js"
  }
}
```

### 3. 监控打包大小

```bash
# 分析打包产物
npm run build -- --report
```

## 相关资源

- [Vite 配置文档](https://vitejs.dev/config/)
- [electron-builder 配置](https://www.electron.build/configuration/configuration)
- [Electron 打包指南](https://www.electronjs.org/docs/latest/tutorial/application-distribution)
- [问题修复 PR](https://github.com/chouxiaozi1989/Maillionaire/commit/b245549)

## 联系支持

如果修复后仍有问题：

- 提交 Issue: https://github.com/chouxiaozi1989/Maillionaire/issues
- 邮箱: yi.cai1989@gmail.com
- 提供信息：
  - 操作系统版本
  - Node.js 版本
  - 完整的控制台日志
  - 打包日志

---

**修复版本**: v1.2.0+
**最后更新**: 2025-11-07
