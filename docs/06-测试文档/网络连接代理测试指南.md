# 网络连接代理测试指南

> 测试日期：2025-10-19  
> 版本：v1.1.0  
> 测试目标：验证所有网络连接是否正确使用系统代理

---

## 🎯 测试目标

验证以下功能是否正确使用代理：
1. ✅ 文件夹同步
2. ✅ 邮件发送
3. ✅ 账户编辑
4. ✅ 账户添加
5. ✅ 邮件同步
6. ✅ OAuth2 认证

---

## 🔧 准备工作

### 1. 启动代理软件

**推荐使用 Clash：**
```
- 启动 Clash
- 端口：7890（默认）
- 协议：SOCKS5
- 确保代理正常工作
```

**或使用 V2Ray：**
```
- 启动 V2Ray
- SOCKS 端口：1080
- 记录端口号
```

### 2. 配置应用代理

1. 启动 Maillionaire
2. 进入"设置" → "代理设置"
3. 配置如下：
   ```
   启用代理：✅ 开启
   协议：SOCKS5
   地址：127.0.0.1
   端口：7890
   认证：❌ 关闭
   ```
4. 点击"测试连接"验证
5. 点击"保存设置"
6. **重启应用**

### 3. 打开开发者工具

**Electron 模式：**
```bash
npm run electron:dev
```

在应用中按 `Ctrl+Shift+I`（Windows）或 `Cmd+Option+I`（Mac）打开控制台

---

## 📋 测试用例

### 测试 1：代理配置验证

**步骤：**
1. 重启应用后查看控制台输出

**预期结果：**
```
[Proxy] Proxy enabled: socks5://127.0.0.1:7890
[IMAP] Proxy config updated: enabled
[SMTP] Proxy config updated: enabled
```

**截图：** `test-screenshots/proxy-config-loaded.png`

✅ 通过 ⬜ 失败

---

### 测试 2：邮件同步（IMAP 代理）

**步骤：**
1. 选择一个已添加的账户
2. 进入"收件箱"
3. 点击刷新或同步按钮
4. 观察控制台输出

**预期结果：**
```
[Mail] Fetching mails from INBOX...
[IMAP] Using proxy for connection
IMAP connection ready
[Mail] Found XX mails
[Mail] Fetched XX mails
```

**验证点：**
- ✅ 显示"Using proxy for connection"
- ✅ 邮件成功同步
- ✅ 无连接错误

✅ 通过 ⬜ 失败

---

### 测试 3：文件夹同步（IMAP 代理）

**步骤：**
1. 在邮件界面
2. 点击"同步文件夹"或刷新文件夹列表
3. 观察控制台输出

**预期结果：**
```
[Mail] Server folders: [...]
[IMAP] Using proxy for connection
IMAP connection ready
```

**验证点：**
- ✅ 显示"Using proxy for connection"
- ✅ 文件夹列表更新
- ✅ 无连接错误

✅ 通过 ⬜ 失败

---

### 测试 4：邮件发送（SMTP 代理）

**步骤：**
1. 点击"写邮件"
2. 填写收件人、主题、内容
3. 点击"发送"
4. 观察控制台输出

**预期结果：**
```
[SMTP] Using proxy for connection
Mail sent: <message-id>
```

**验证点：**
- ✅ 显示"Using proxy for connection"
- ✅ 邮件发送成功
- ✅ 无 SMTP 错误

✅ 通过 ⬜ 失败

---

### 测试 5：账户添加（IMAP/SMTP 代理）

**步骤：**
1. 点击"添加账户"
2. 选择"其他邮箱"（IMAP/SMTP）
3. 填写邮箱信息：
   ```
   邮箱：test@example.com
   密码：******
   IMAP：imap.example.com:993
   SMTP：smtp.example.com:465
   ```
4. 点击"验证连接"或"添加"
5. 观察控制台输出

**预期结果：**
```
[Account] IMAP verification...
[IMAP] Using proxy for connection
[Account] IMAP connection verified
[Account] SMTP verification...
[SMTP] Using proxy for connection
[Account] SMTP connection verified
```

**验证点：**
- ✅ IMAP 显示使用代理
- ✅ SMTP 显示使用代理
- ✅ 验证成功或正确显示错误

✅ 通过 ⬜ 失败

---

### 测试 6：账户同步（IMAP/SMTP 代理）

**步骤：**
1. 选择一个已添加的账户
2. 点击"同步账户"或"重新验证"
3. 观察控制台输出

**预期结果：**
```
[Account] Sync account...
[IMAP] Using proxy for connection
[Account] IMAP connection verified
[SMTP] Using proxy for connection
[Account] SMTP connection verified
```

**验证点：**
- ✅ IMAP 和 SMTP 都显示使用代理
- ✅ 同步成功

✅ 通过 ⬜ 失败

---

### 测试 7：Gmail OAuth2 认证（OAuth2 代理）

**步骤：**
1. 点击"添加账户"
2. 选择"Gmail"
3. 点击"使用 Google 登录"
4. 完成 OAuth2 授权流程
5. 观察控制台输出

**预期结果：**
```
[OAuth2] Production Mode: Starting gmail authentication...
OAuth2 callback received
[OAuth2] Exchanging token via Electron IPC (with proxy support)
[OAuth2] Using proxy: socks5://127.0.0.1:7890
```

**验证点：**
- ✅ 显示"Using Electron IPC (with proxy support)"
- ✅ 显示"Using proxy: socks5://..."
- ✅ Token 交换成功
- ✅ 账户添加成功

✅ 通过 ⬜ 失败

---

### 测试 8：Outlook OAuth2 认证（OAuth2 代理）

**步骤：**
1. 点击"添加账户"
2. 选择"Outlook"
3. 点击"使用 Microsoft 登录"
4. 完成 OAuth2 授权流程
5. 观察控制台输出

**预期结果：**
```
[OAuth2] Production Mode: Starting outlook authentication...
OAuth2 callback received
[OAuth2] Exchanging token via Electron IPC (with proxy support)
[OAuth2] Using proxy: socks5://127.0.0.1:7890
```

**验证点：**
- ✅ 显示"Using Electron IPC (with proxy support)"
- ✅ 显示"Using proxy: socks5://..."
- ✅ Token 交换成功
- ✅ 账户添加成功

✅ 通过 ⬜ 失败

---

### 测试 9：代理关闭后的行为

**步骤：**
1. 进入"设置" → "代理设置"
2. 关闭"启用代理"
3. 保存并重启应用
4. 尝试同步邮件
5. 观察控制台输出

**预期结果：**
```
[Proxy] Proxy disabled
[IMAP] Proxy config updated: disabled
[SMTP] Proxy config updated: disabled
```

**验证点：**
- ✅ 不显示"Using proxy"
- ✅ 直接连接成功（如果网络环境允许）
- ✅ 无代理相关错误

✅ 通过 ⬜ 失败

---

### 测试 10：代理切换协议

**步骤：**
1. 测试不同协议：
   - SOCKS5
   - SOCKS4
   - HTTP（如果代理支持）
   - HTTPS（如果代理支持）
2. 每次修改后重启应用
3. 测试邮件同步

**预期结果：**

**SOCKS5：**
```
[Proxy] Proxy enabled: socks5://127.0.0.1:7890
[IMAP] Using proxy for connection
```

**HTTP：**
```
[Proxy] Proxy enabled: http://127.0.0.1:7890
[SMTP] Using proxy for connection
```

**验证点：**
- ✅ 所有协议都能正常工作
- ✅ 控制台显示正确的协议

✅ 通过 ⬜ 失败

---

## 📊 测试结果记录表

| 测试用例 | 状态 | 备注 | 截图 |
|---------|------|------|------|
| 1. 代理配置验证 | ⬜ | | |
| 2. 邮件同步 | ⬜ | | |
| 3. 文件夹同步 | ⬜ | | |
| 4. 邮件发送 | ⬜ | | |
| 5. 账户添加 | ⬜ | | |
| 6. 账户同步 | ⬜ | | |
| 7. Gmail OAuth2 | ⬜ | 需要配置 OAuth2 | |
| 8. Outlook OAuth2 | ⬜ | 需要配置 OAuth2 | |
| 9. 代理关闭 | ⬜ | | |
| 10. 协议切换 | ⬜ | | |

**状态说明：**
- ⬜ 未测试
- ✅ 通过
- ❌ 失败
- ⚠️ 部分通过

---

## 🐛 常见问题

### 问题 1：控制台没有显示代理信息

**可能原因：**
1. 代理配置未保存
2. 应用未重启
3. 未在 Electron 模式运行

**解决方法：**
1. 检查代理设置是否保存
2. 重启应用
3. 确保使用 `npm run electron:dev`

---

### 问题 2：显示"Using proxy"但连接失败

**可能原因：**
1. Clash 未运行
2. 端口配置错误
3. 代理服务器不可用

**解决方法：**
1. 检查 Clash 是否运行
2. 验证端口号（默认 7890）
3. 在设置中测试代理连接

---

### 问题 3：OAuth2 未显示代理信息

**可能原因：**
1. 在浏览器开发模式
2. Electron 环境未正确初始化

**解决方法：**
1. 使用 `npm run electron:dev`
2. 检查 `window.electronAPI` 是否存在

---

### 问题 4：IMAP/SMTP 连接超时

**可能原因：**
1. 代理无法访问邮件服务器
2. 防火墙阻止
3. 邮件服务器配置错误

**解决方法：**
1. 测试代理是否可以访问 Google/QQ 邮件服务器
2. 临时关闭防火墙测试
3. 检查 IMAP/SMTP 地址和端口

---

## 📝 测试报告模板

```markdown
## 网络连接代理测试报告

**测试日期：** 2025-10-19  
**测试人员：** XXX  
**应用版本：** v1.1.0  
**代理软件：** Clash / V2Ray  

### 测试环境
- 操作系统：Windows 11 / macOS / Linux
- Node.js 版本：v16.x
- Electron 版本：26.2.1
- 代理协议：SOCKS5
- 代理地址：127.0.0.1:7890

### 测试结果摘要
- 总测试用例：10 个
- 通过：X 个
- 失败：X 个
- 跳过：X 个

### 详细结果
1. 代理配置验证：✅ 通过
2. 邮件同步：✅ 通过
3. 文件夹同步：✅ 通过
4. 邮件发送：✅ 通过
5. 账户添加：✅ 通过
6. 账户同步：✅ 通过
7. Gmail OAuth2：✅ 通过
8. Outlook OAuth2：⬜ 跳过（未配置）
9. 代理关闭：✅ 通过
10. 协议切换：✅ 通过

### 发现的问题
1. 无

### 建议
1. 所有网络连接已正确使用系统代理
2. 代理配置功能工作正常

### 总结
所有功能的网络连接均已正确使用系统代理配置，测试通过。

**测试结论：** ✅ 通过验证
```

---

## ✅ 验收标准

测试通过需满足以下条件：

### 必要条件（Must Have）

1. ✅ **代理启用后所有 IMAP 连接显示使用代理**
   - 控制台输出：`[IMAP] Using proxy for connection`

2. ✅ **代理启用后所有 SMTP 连接显示使用代理**
   - 控制台输出：`[SMTP] Using proxy for connection`

3. ✅ **OAuth2 Token 交换使用 Electron IPC 和代理**
   - 控制台输出：`[OAuth2] Using Electron IPC (with proxy support)`
   - 控制台输出：`[OAuth2] Using proxy: socks5://...`

4. ✅ **代理配置保存并在重启后生效**
   - 重启后自动加载代理配置
   - 控制台输出：`[Proxy] Proxy enabled: ...`

5. ✅ **代理关闭后不显示使用代理**
   - 控制台不输出"Using proxy"相关信息

### 可选条件（Nice to Have）

1. ⚠️ **支持多种代理协议**
   - SOCKS5 ✅
   - SOCKS4 ✅
   - HTTP ✅
   - HTTPS ✅

2. ⚠️ **代理认证功能**
   - 用户名密码认证工作正常

3. ⚠️ **代理连接测试**
   - 测试功能准确反映代理状态

---

**测试完成后，请填写测试报告并提交！** ✅
