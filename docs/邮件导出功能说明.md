# 邮件导出功能说明

## 功能概述

Maillionaire 现在支持将邮件批量导出为 CSV 格式，同时将附件打包为 ZIP 文件。**导出过程提供实时进度反馈**，让用户清楚了解导出状态。

## 主要特性

### 1. CSV 导出
- 导出邮件的所有关键信息到 CSV 文件
- 包含字段：
  - ID、账户ID、文件夹
  - 发件人、收件人、抄送
  - 主题、日期、预览
  - 正文（纯文本）
  - 附件信息（是否有附件、附件数量、附件名称）
  - 状态（已读、星标）
- 使用 UTF-8 编码，带 BOM，可在 Excel 中正确打开

### 2. 附件打包
- 将所有选中邮件的附件打包到一个 ZIP 文件中
- 按邮件 ID 和主题创建文件夹，便于管理
- 支持 Gmail 和 IMAP 两种协议的附件下载
- 自动处理文件名中的非法字符

### 3. 实时进度显示 ✨ 新增
- **进度弹窗**：显示详细的导出进度
- **百分比进度条**：直观显示完成度
- **步骤提示**：显示当前正在执行的操作（CSV导出/附件打包）
- **附件计数**：显示已处理和总数（如：5/20）
- **实时消息**：显示当前处理的文件名

## 使用方法

### 在收件箱页面使用

1. **进入多选模式**
   - 点击左上角的"多选"按钮

2. **选择要导出的邮件**
   - 勾选需要导出的邮件
   - 或点击"全选"按钮选择所有邮件

3. **点击导出按钮**
   - 在工具栏中找到蓝色的"导出"按钮
   - 点击后会弹出文件夹选择对话框

4. **选择导出目录**
   - 选择要保存导出文件的目录
   - 确认后开始导出

5. **查看导出进度**
   - 系统会弹出进度窗口
   - 显示当前步骤和完成百分比
   - 如果有附件，会显示附件处理进度（如：正在处理附件 5/20: document.pdf）
   - 不能关闭进度窗口（防止误操作中断导出）

6. **完成导出**
   - 进度达到 100% 后自动关闭进度窗口
   - 显示成功消息，包含导出的邮件数量和是否包含附件

### 导出结果

导出会生成两个文件（如果有附件）：

1. **CSV 文件**: `emails_export_YYYY-MM-DDTHH-mm-ss.csv`
   - 包含所有邮件的详细信息
   - 可用 Excel、WPS 等软件打开

2. **ZIP 文件**: `attachments_YYYY-MM-DDTHH-mm-ss.zip`（如果邮件含有附件）
   - 包含所有邮件的附件
   - 按照 `邮件ID_主题/附件名` 的结构组织

## 技术架构

### 前端
- **UI**: Inbox.vue 中的导出按钮和进度弹窗
- **Store**: mail.js 中的 `exportMails()` 方法
- **进度监听**: 通过 `window.electronAPI.onExportProgress()` 监听进度事件

### 后端（Electron 主进程）
- **导出服务**: `electron/services/export-service.js`
  - CSV 写入（使用 csv-writer）
  - ZIP 打包（使用 archiver）
  - HTML 清理和文件名净化
  - **进度回调**：支持 `onProgress` 回调函数，实时报告进度

- **IPC 处理**: `electron/main.js`
  - `export-mails` 处理器
  - **进度事件发送**：通过 `event.sender.send('export-progress', progress)` 发送进度
  - Gmail 附件获取
  - IMAP 附件获取

- **Preload API**: `electron/preload.js`
  - `exportMails()` - 导出邮件
  - **`onExportProgress(callback)`** - 监听导出进度（返回清理函数）

### Gmail API
- `src/services/gmail-api.js` 中新增 `getAttachment()` 方法
- 支持通过 attachmentId 获取附件内容

### IMAP
- `electron/services/imap-main.js` 中新增 `getMailAttachments()` 方法
- 通过 UID 重新解析邮件获取完整附件内容

## 进度事件格式

```javascript
{
  step: 'csv' | 'attachments' | 'complete',  // 当前步骤
  message: '正在导出CSV文件...',              // 提示消息
  percent: 50,                                // 完成百分比 (0-100)
  current: 5,                                 // 当前处理数（可选，仅附件阶段）
  total: 20                                   // 总数（可选，仅附件阶段）
}
```

## 依赖包

新增的依赖包：
- `csv-writer`: CSV 文件生成
- `archiver`: ZIP 文件打包

## 注意事项

1. **附件下载**
   - Gmail 账户：通过 Gmail API 下载附件，需要有效的访问令牌
   - IMAP 账户：需要连接到 IMAP 服务器重新获取附件内容

2. **性能考虑**
   - 导出大量邮件或大附件时可能需要较长时间
   - 进度条会实时显示处理进度
   - 建议一次导出不超过 100 封邮件

3. **文件大小**
   - ZIP 文件使用最高压缩级别（level 9）
   - 大量附件可能产生较大的 ZIP 文件

4. **错误处理**
   - 如果某个附件下载失败，会跳过该附件并继续处理其他附件
   - 所有错误都会在控制台输出日志
   - 不会影响其他附件的下载

5. **用户体验**
   - 导出过程中不能关闭进度窗口（`closable: false`, `maskClosable: false`）
   - 进度条会根据步骤动态更新
   - 100% 完成后自动关闭窗口并显示成功消息

## 文件位置

### 核心文件
- `electron/services/export-service.js` - 导出服务（带进度回调）
- `electron/main.js` - IPC 处理器（第727-853行，含进度事件发送）
- `electron/preload.js` - API 暴露（第62-70行，含进度监听）
- `src/stores/mail.js` - Store 方法（第1711-1748行）
- `src/views/mail/Inbox.vue` - UI 实现（含进度弹窗，第138-157行，第284-358行）

### 修改文件
- `src/services/gmail-api.js` - 添加 `getAttachment()` 方法
- `electron/services/imap-main.js` - 添加 `getMailAttachments()` 方法

## 进度条实现详情

### 1. 服务层（export-service.js）
- `exportMails()` 接收 `options.onProgress` 回调
- CSV 导出完成后报告 50% 进度
- `exportAttachments()` 接收 `onProgress` 回调
- 每处理一个附件更新一次进度
- 最终报告 100% 完成

### 2. IPC 层（main.js）
- 定义 `onProgress` 回调函数
- 通过 `event.sender.send('export-progress', progress)` 发送事件到渲染进程

### 3. Preload 层（preload.js）
- `onExportProgress(callback)` 注册 IPC 监听器
- 返回清理函数用于移除监听器

### 4. UI 层（Inbox.vue）
- 显示模态窗口 (`a-modal`)
- 使用 `a-progress` 组件显示进度条
- 显示实时消息和附件计数
- 完成后自动关闭并显示成功提示

## 后续优化建议

1. **取消功能**
   - 添加"取消"按钮允许用户中止导出
   - 实现导出过程的中断机制

2. **导出选项**
   - 允许用户选择是否导出附件
   - 允许用户选择导出字段
   - 支持自定义 CSV 分隔符

3. **批量导出**
   - 支持导出所有文件夹的邮件
   - 支持按日期范围导出

4. **格式支持**
   - 支持导出为 EML 格式（保留原始邮件格式）
   - 支持导出为 PDF（邮件正文）

5. **云同步**
   - 支持直接导出到云存储（如 OneDrive、Google Drive）

6. **断点续传**
   - 如果导出失败，支持从上次位置继续

## 测试建议

1. **功能测试**
   - 测试导出不同数量的邮件（1封、10封、100封）
   - 测试导出有附件和无附件的邮件
   - 测试 Gmail 和 IMAP 账户
   - **测试进度条是否正确显示**

2. **边界测试**
   - 测试附件名包含特殊字符的邮件
   - 测试邮件主题和正文包含 HTML 标签的邮件
   - 测试大附件（>10MB）的邮件
   - **测试大量附件时进度条的性能**

3. **错误测试**
   - 测试网络断开时的导出
   - 测试 Token 过期时的导出
   - 测试磁盘空间不足时的导出
   - **测试导出过程中的错误处理和进度显示**

4. **用户体验测试**
   - 验证进度条动画流畅
   - 验证进度消息清晰易懂
   - 验证完成后的反馈及时准确
   - 验证不能关闭进度窗口（防止误操作）
