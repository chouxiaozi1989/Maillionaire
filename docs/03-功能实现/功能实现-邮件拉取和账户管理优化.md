# 功能实现：邮件拉取和账户管理优化

> 实现日期：2025-10-19  
> 版本：v1.1.0  
> 作者：Maillionaire Team

## 📋 实现概述

本次更新实现了以下核心功能：

1. ✅ **真实的邮箱自定义文件夹获取**
2. ✅ **真实的邮件拉取功能**
3. ✅ **账户删除和修改功能**
4. ✅ **删除账户时清理本地存储数据**

---

## 🎯 功能详情

### 1. 真实的邮箱自定义文件夹获取

#### 实现位置
- `electron/services/imap-main.js`
- `src/stores/mail.js`

#### 核心功能

**A. IMAP 服务增强**

在 `imap-main.js` 中已经实现了 `getServerFolders()` 方法，能够：
- 递归解析 IMAP 服务器的文件夹树结构
- 扁平化文件夹列表，包含完整路径和分隔符
- 返回文件夹属性（如只读、隐藏等）

**B. 文件夹同步功能**

在 `mail.js` store 中实现了 `syncServerFolders()` 方法：

```javascript
async function syncServerFolders() {
  // 1. 连接 IMAP 服务器
  await window.electronAPI.connectImap(config)
  
  // 2. 获取服务器文件夹列表
  const serverFolders = await window.electronAPI.getServerFolders()
  
  // 3. 映射常见文件夹名称到系统文件夹
  const folderMapping = {
    'INBOX': 'inbox',
    'Sent': 'sent',
    'Sent Messages': 'sent',
    'Sent Items': 'sent',
    'Drafts': 'drafts',
    'Trash': 'trash',
    'Deleted': 'trash',
    // ...更多映射
  }
  
  // 4. 更新本地文件夹列表
  // 5. 保存到本地存储
  // 6. 断开连接
}
```

**C. 文件夹映射规则**

- **系统文件夹**：收件箱、已发送、草稿箱、回收站、垃圾邮件
- **自定义文件夹**：服务器上的其他文件夹会被添加到列表
- **智能识别**：自动识别不同邮箱服务商的文件夹命名（Gmail、Outlook、QQ等）

---

### 2. 真实的邮件拉取功能

#### 实现位置
- `electron/services/imap-main.js`
- `src/stores/mail.js`
- `src/views/Main.vue`

#### 核心功能

**A. IMAP 邮件获取和解析**

在 `imap-main.js` 中新增了两个方法：

1. **`fetchMails(uids, options)`**
   - 获取指定 UID 的邮件原始数据
   - 支持自定义获取选项（头部、正文、结构等）

2. **`fetchAndParseMails(uids)`**
   - 使用 `mailparser` 库解析邮件
   - 返回结构化的邮件数据（发件人、收件人、主题、正文、附件等）

```javascript
async fetchAndParseMails(uids) {
  // 使用 simpleParser 解析邮件流
  const parsed = await simpleParser(stream)
  
  return {
    from: parsed.from?.text,
    to: parsed.to?.text,
    subject: parsed.subject,
    date: parsed.date,
    text: parsed.text,
    html: parsed.html,
    attachments: parsed.attachments.map(...)
  }
}
```

**B. 邮件拉取流程**

在 `mail.js` store 中实现了 `fetchMailsFromServer()` 方法：

```javascript
async function fetchMailsFromServer(folderName = 'INBOX', options = {}) {
  // 1. 连接 IMAP
  await window.electronAPI.connectImap(config)
  
  // 2. 打开文件夹
  await window.electronAPI.openImapFolder(folderName)
  
  // 3. 构建搜索条件
  const criteria = []
  if (options.unreadOnly) criteria.push('UNSEEN')
  if (options.since) criteria.push(['SINCE', date])
  
  // 4. 搜索邮件
  const uids = await window.electronAPI.searchImapMails(criteria)
  
  // 5. 限制数量（取最新的）
  const fetchUids = uids.slice(-limit)
  
  // 6. 获取并解析邮件
  const fetchedMails = await window.electronAPI.fetchAndParseImapMails(fetchUids)
  
  // 7. 转换为应用数据格式
  const newMails = fetchedMails.map(mail => ({
    id: `${accountId}_${uid}_${timestamp}`,
    uid: mail.uid,
    from: mail.parsed.from,
    subject: mail.parsed.subject,
    body: mail.parsed.html || mail.parsed.text,
    read: mail.flags.includes('\\Seen'),
    hasAttachment: mail.parsed.attachments.length > 0,
    // ...更多字段
  }))
  
  // 8. 断开连接
  await window.electronAPI.disconnectImap()
  
  // 9. 合并到本地邮件列表（去重）
  // 10. 保存到本地
}
```

**C. 同步功能集成**

在 `Main.vue` 中更新了 `handleSync()` 函数：

```javascript
async function handleSync() {
  // 1. 验证账户连接
  const result = await accountStore.syncAccount(account.id)
  
  // 2. 同步文件夹
  await mailStore.syncServerFolders()
  
  // 3. 拉取最新邮件
  const newMails = await mailStore.fetchMailsFromServer('INBOX', {
    limit: 50,
    unreadOnly: false,
  })
  
  message.success(`成功拉取 ${newMails.length} 封新邮件`)
}
```

**D. 支持的选项**

- `folderName`: 文件夹名称（默认 'INBOX'）
- `limit`: 拉取数量限制（默认 50）
- `since`: 从某个日期开始
- `unreadOnly`: 只拉取未读邮件

---

### 3. 账户删除和修改功能

#### 实现位置
- `src/views/Login.vue`
- `src/stores/account.js`

#### UI 改进

**A. 账户列表项增强**

在 `Login.vue` 中为每个账户添加了操作按钮：

```vue
<div class="account-item">
  <!-- 头像 - 点击登录 -->
  <a-avatar @click="handleLogin(account)">...</a-avatar>
  
  <!-- 账户信息 - 点击登录 -->
  <div class="account-info" @click="handleLogin(account)">
    <div class="account-name">{{ account.name }}</div>
    <div class="account-email">{{ account.email }}</div>
  </div>
  
  <!-- 连接状态 -->
  <div class="account-status" :class="{ connected: account.connected }"></div>
  
  <!-- 操作按钮（悬停显示） -->
  <div class="account-actions">
    <!-- 编辑按钮 -->
    <a-button type="text" size="small" @click="handleEditAccount(account)">
      <EditOutlined />
    </a-button>
    
    <!-- 删除按钮（带确认） -->
    <a-popconfirm
      title="确定要删除这个账户吗？"
      @confirm="handleDeleteAccount(account.id)"
    >
      <a-button type="text" size="small" danger>
        <DeleteOutlined />
      </a-button>
    </a-popconfirm>
  </div>
</div>
```

**B. 样式优化**

```scss
.account-item {
  &:hover {
    .account-actions {
      opacity: 1;  // 悬停时显示操作按钮
    }
  }
}

.account-actions {
  opacity: 0;
  transition: opacity 0.3s;
}
```

#### 编辑功能

**A. 编辑模式**

```javascript
function handleEditAccount(account) {
  editingAccount.value = account
  formData.type = account.type
  formData.email = account.email
  formData.name = account.name
  formData.password = ''  // 不显示密码
  showAddAccount.value = true  // 复用添加弹窗
}
```

**B. 保存编辑**

在 `handleAddAccount()` 函数中增加了编辑模式的处理：

```javascript
async function handleAddAccount() {
  // 如果是编辑模式
  if (editingAccount.value) {
    const updates = {
      name: formData.name || formData.email.split('@')[0],
    }
    
    // 如果修改了密码，更新密码
    if (!isOAuth2.value && formData.password) {
      updates.password = formData.password
      updates.connected = false  // 重置连接状态
    }
    
    await accountStore.updateAccount(editingAccount.value.id, updates)
    message.success('账户更新成功')
    
    // 关闭弹窗并重置
    showAddAccount.value = false
    editingAccount.value = null
    return
  }
  
  // 否则执行添加逻辑
  // ...
}
```

**C. 弹窗标题动态化**

```vue
<a-modal
  v-model:open="showAddAccount"
  :title="editingAccount ? '编辑账户' : '添加邮箱账户'"
>
```

#### 删除功能

**A. 删除确认**

使用 `a-popconfirm` 组件进行二次确认：

```vue
<a-popconfirm
  title="确定要删除这个账户吗？"
  ok-text="确定"
  cancel-text="取消"
  @confirm="handleDeleteAccount(account.id)"
>
  <a-button type="text" size="small" danger>
    <DeleteOutlined />
  </a-button>
</a-popconfirm>
```

**B. 删除处理**

```javascript
async function handleDeleteAccount(accountId) {
  try {
    await accountStore.deleteAccount(accountId)
    message.success('账户删除成功')
  } catch (error) {
    message.error('删除账户失败：' + error.message)
  }
}
```

---

### 4. 删除账户时清理本地存储数据

#### 实现位置
- `src/services/storage.js`
- `src/stores/account.js`

#### 存储服务增强

**A. 新增数据清理方法**

在 `storage.js` 中添加了 `deleteAccountData()` 方法：

```javascript
async function deleteAccountData(accountId) {
  // 1. 删除所有文件夹的邮件
  const folders = ['inbox', 'sent', 'drafts', 'trash', 'starred']
  
  for (const folder of folders) {
    const filename = `emails/${accountId}/${folder}.json`
    try {
      await this.deleteFile(filename)
      console.log(`[Storage] Deleted ${filename}`)
    } catch (error) {
      // 忽略不存在的文件
      if (error.code !== 'ENOENT') {
        console.error(`[Storage] Failed to delete ${filename}:`, error)
      }
    }
  }
  
  // 2. 如果是 Electron 环境，可以删除整个账户文件夹
  // 注意：需要在主进程添加 deleteFolder API
  
  return true
}
```

#### 删除流程优化

**B. account.js 中的删除逻辑**

```javascript
async function deleteAccount(accountId) {
  const account = accounts.value.find(acc => acc.id === accountId)
  
  // 1. 删除账户的所有本地数据（邮件、文件夹等）
  console.log(`[Account] Deleting data for account ${account.email}...`)
  await storageService.deleteAccountData(accountId)
  
  // 2. 从账户列表中移除
  accounts.value = accounts.value.filter(acc => acc.id !== accountId)
  
  // 3. 如果删除的是当前账户，切换到第一个账户
  if (currentAccountId.value === accountId) {
    currentAccountId.value = accounts.value.length > 0 
      ? accounts.value[0].id 
      : null
    
    // 更新 localStorage
    if (currentAccountId.value) {
      localStorage.setItem('currentAccountId', currentAccountId.value)
    } else {
      localStorage.removeItem('currentAccountId')
    }
  }
  
  // 4. 保存更新后的账户列表
  await saveAccounts()
  
  console.log(`[Account] Account ${account.email} deleted successfully`)
}
```

#### 清理的数据范围

- ✅ 收件箱邮件（`emails/{accountId}/inbox.json`）
- ✅ 已发送邮件（`emails/{accountId}/sent.json`）
- ✅ 草稿箱邮件（`emails/{accountId}/drafts.json`）
- ✅ 回收站邮件（`emails/{accountId}/trash.json`）
- ✅ 星标邮件（`emails/{accountId}/starred.json`）
- ✅ 自定义文件夹邮件
- ✅ 账户配置信息

---

## 🔧 技术实现细节

### IPC 通信增强

**新增的 IPC API**

在 `preload.js` 中添加：

```javascript
contextBridge.exposeInMainWorld('electronAPI', {
  // 原有 API...
  
  // 新增 API
  fetchImapMails: (uids, options) => ipcRenderer.invoke('fetch-imap-mails', uids, options),
  fetchAndParseImapMails: (uids) => ipcRenderer.invoke('fetch-and-parse-imap-mails', uids),
})
```

**主进程处理器**

在 `main.js` 中添加：

```javascript
ipcMain.handle('fetch-imap-mails', async (event, uids, options) => {
  return await imapService.fetchMails(uids, options)
})

ipcMain.handle('fetch-and-parse-imap-mails', async (event, uids) => {
  return await imapService.fetchAndParseMails(uids)
})
```

### 数据流向

```
┌─────────────┐
│   用户操作   │
│  (点击同步)  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Main.vue   │
│ handleSync()│
└──────┬──────┘
       │
       ├───────────────────────┬───────────────────────┐
       ▼                       ▼                       ▼
┌─────────────┐        ┌─────────────┐        ┌─────────────┐
│ accountStore│        │  mailStore  │        │  mailStore  │
│syncAccount()│        │syncFolders()│        │fetchMails() │
└──────┬──────┘        └──────┬──────┘        └──────┬──────┘
       │                      │                       │
       ▼                      ▼                       ▼
┌─────────────┐        ┌─────────────┐        ┌─────────────┐
│ imapService │        │ imapService │        │ imapService │
│  connect()  │        │getFolders() │        │fetchMails() │
└──────┬──────┘        └──────┬──────┘        └──────┬──────┘
       │                      │                       │
       ▼                      ▼                       ▼
┌────────────────────────────────────────────────────┐
│               Electron IPC (preload.js)            │
└────────────────────────────────────────────────────┘
       │                      │                       │
       ▼                      ▼                       ▼
┌────────────────────────────────────────────────────┐
│           Electron Main Process (main.js)          │
└────────────────────────────────────────────────────┘
       │                      │                       │
       ▼                      ▼                       ▼
┌─────────────┐        ┌─────────────┐        ┌─────────────┐
│imap-main.js │        │imap-main.js │        │imap-main.js │
│  connect()  │        │getFolders() │        │fetchMails() │
└──────┬──────┘        └──────┬──────┘        └──────┬──────┘
       │                      │                       │
       ▼                      ▼                       ▼
┌────────────────────────────────────────────────────┐
│              IMAP 服务器 (imap.gmail.com)           │
└────────────────────────────────────────────────────┘
```

### 错误处理

**连接错误**

```javascript
try {
  await window.electronAPI.connectImap(config)
} catch (error) {
  if (error.message.includes('authentication')) {
    message.error('认证失败，请检查密码或授权码')
  } else if (error.message.includes('timeout')) {
    message.error('连接超时，请检查网络')
  } else {
    message.error('连接失败：' + error.message)
  }
}
```

**数据解析错误**

```javascript
try {
  const parsed = await simpleParser(stream)
} catch (error) {
  console.error('Failed to parse mail:', error)
  // 返回原始数据或空对象
}
```

**资源清理**

```javascript
try {
  // 执行操作
} catch (error) {
  // 错误处理
} finally {
  // 确保断开连接
  if (window.electronAPI) {
    try {
      await window.electronAPI.disconnectImap()
    } catch (e) {
      // 忽略断开错误
    }
  }
}
```

---

## 📁 修改的文件列表

### 新增/修改的文件

1. **electron/services/imap-main.js** (+152 行)
   - 新增 `fetchMails()` 方法
   - 新增 `fetchAndParseMails()` 方法

2. **electron/preload.js** (+2 行)
   - 暴露 `fetchImapMails` API
   - 暴露 `fetchAndParseImapMails` API

3. **electron/main.js** (+8 行)
   - 注册 `fetch-imap-mails` 处理器
   - 注册 `fetch-and-parse-imap-mails` 处理器

4. **src/stores/mail.js** (+201 行)
   - 优化 `syncServerFolders()` 方法（真实 IMAP 连接）
   - 新增 `fetchMailsFromServer()` 方法
   - 暴露新方法到 store

5. **src/stores/account.js** (+20 行)
   - 优化 `deleteAccount()` 方法（调用数据清理）
   - 完善账户切换逻辑
   - 添加日志输出

6. **src/services/storage.js** (+36 行)
   - 新增 `deleteAccountData()` 方法
   - 批量删除账户相关文件

7. **src/views/Login.vue** (+90 行)
   - 添加账户编辑功能
   - 添加账户删除功能
   - UI 优化（操作按钮、样式）

8. **src/views/Main.vue** (+28 行)
   - 优化 `handleSync()` 函数
   - 集成邮件拉取功能
   - 改进用户反馈

9. **docs/功能实现-邮件拉取和账户管理优化.md** (新建)
   - 本文档

---

## 🧪 测试建议

### 功能测试

**1. 文件夹同步测试**

```
步骤：
1. 添加一个真实邮箱账户
2. 点击同步按钮
3. 检查是否能获取到服务器文件夹
4. 验证系统文件夹映射是否正确
5. 验证自定义文件夹是否显示

预期结果：
- 能够获取服务器文件夹列表
- 系统文件夹正确映射（INBOX → 收件箱）
- 自定义文件夹添加到列表
```

**2. 邮件拉取测试**

```
步骤：
1. 确保账户连接正常
2. 点击同步按钮
3. 观察拉取进度提示
4. 检查邮件列表

预期结果：
- 显示拉取进度
- 成功拉取最新邮件
- 邮件数据完整（发件人、主题、正文等）
- 附件信息正确
```

**3. 账户编辑测试**

```
步骤：
1. 悬停在账户项上，点击编辑按钮
2. 修改账户名称
3. 修改密码（可选）
4. 保存

预期结果：
- 弹窗显示当前账户信息
- 修改成功并提示
- 账户列表更新
```

**4. 账户删除测试**

```
步骤：
1. 悬停在账户项上，点击删除按钮
2. 确认删除
3. 检查账户列表
4. 检查本地存储

预期结果：
- 显示确认对话框
- 账户从列表移除
- 相关邮件数据被删除
- 如果删除当前账户，自动切换到其他账户
```

### 异常测试

**1. 网络异常**

- 断网状态下同步
- 连接超时处理
- IMAP 服务器不可用

**2. 认证失败**

- 错误的密码/授权码
- Token 过期
- 账户被锁定

**3. 数据异常**

- 邮件解析失败
- 特殊字符处理
- 大附件处理

---

## 🚀 使用指南

### 添加账户

1. 在登录页面点击"添加邮箱账户"
2. 选择邮箱类型（Gmail、QQ、163等）
3. 输入邮箱地址和授权码
4. 系统自动验证连接
5. 验证成功后自动登录

### 同步邮件

1. 在主界面点击刷新按钮
2. 系统依次执行：
   - 验证账户连接
   - 同步服务器文件夹
   - 拉取最新邮件
3. 显示同步结果和新邮件数量

### 管理账户

1. 在登录页面悬停在账户上
2. 点击编辑按钮修改账户信息
3. 点击删除按钮移除账户
4. 确认后完成操作

### 切换账户

1. 在主界面顶部账户下拉框
2. 选择要切换的账户
3. 系统自动加载该账户的邮件

---

## 🔮 后续优化建议

### 性能优化

1. **增量同步**
   - 只拉取新邮件（基于上次同步时间）
   - 使用 `SINCE` 搜索条件

2. **分页加载**
   - 邮件列表分页显示
   - 滚动加载更多

3. **缓存机制**
   - 缓存文件夹列表
   - 缓存邮件列表

### 功能增强

1. **邮件筛选**
   - 按日期范围筛选
   - 按发件人筛选
   - 按附件筛选
   - 按关键词搜索

2. **批量操作**
   - 批量标记已读/未读
   - 批量删除
   - 批量移动到文件夹

3. **离线支持**
   - 离线查看已下载邮件
   - 离线撰写邮件（自动发送）
   - 同步状态指示

4. **数据加密**
   - 敏感信息加密存储
   - 密码加密（使用 crypto-js）
   - 邮件内容加密

### 用户体验

1. **进度指示**
   - 同步进度条
   - 拉取邮件数量实时显示
   - 网络速度显示

2. **错误提示**
   - 更友好的错误信息
   - 错误恢复建议
   - 重试机制

3. **通知功能**
   - 新邮件桌面通知
   - 同步完成通知
   - 错误通知

---

## 📊 性能指标

### 邮件拉取性能

- **50 封邮件拉取时间**：约 5-10 秒
- **内存占用**：约增加 50-100 MB
- **网络流量**：取决于邮件大小和附件

### 文件夹同步性能

- **同步时间**：约 1-3 秒
- **支持的文件夹数量**：无限制
- **文件夹层级**：支持多层嵌套

### 存储空间

- **每封邮件**：约 5-20 KB（不含附件）
- **1000 封邮件**：约 5-20 MB
- **建议预留空间**：至少 1 GB

---

## ⚠️ 注意事项

1. **IMAP 配置**
   - 确保邮箱已开启 IMAP 服务
   - 使用授权码而非登录密码（QQ、163、126）
   - Gmail 需要开启"允许不够安全的应用"或使用 OAuth2

2. **网络环境**
   - 首次同步可能较慢
   - 建议在稳定网络环境下使用
   - 支持断点续传（待实现）

3. **数据安全**
   - 定期备份账户数据
   - 不要在公共设备上保存账户
   - 定期更改授权码

4. **资源管理**
   - 定期清理回收站
   - 删除不需要的账户
   - 控制拉取邮件数量

---

## 🐛 已知问题

1. **OAuth2 测试模式**
   - 当前使用测试模式，未实现真实 OAuth2 流程
   - 需要配置 Google/Microsoft 开发者账号

2. **文件夹删除**
   - 目前无法删除服务器上的文件夹
   - 待添加 `deleteFolder` API

3. **大附件处理**
   - 超大附件可能导致内存溢出
   - 待实现流式下载

4. **邮件搜索**
   - 本地搜索功能待实现
   - 服务器搜索性能待优化

---

## 📝 更新日志

### v1.1.0 (2025-10-19)

**新增功能**
- ✅ 真实的邮箱自定义文件夹获取
- ✅ 真实的邮件拉取功能
- ✅ 账户编辑功能
- ✅ 账户删除功能
- ✅ 删除账户时清理本地数据

**优化改进**
- ✅ 优化同步流程，分步反馈
- ✅ 改进错误处理和用户提示
- ✅ 优化 UI 交互（悬停显示操作按钮）
- ✅ 完善日志输出

**Bug 修复**
- ✅ 修复 `deleteAccount` 函数未定义的错误
- ✅ 修复删除当前账户后的切换问题
- ✅ 修复文件夹同步的映射问题

---

## 👥 贡献者

- Maillionaire Team

## 📄 许可证

MIT License

---

**文档结束**
