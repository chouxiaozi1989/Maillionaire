# 功能实现：账户连接验证和同步

## 📋 实现内容

将账户添加和同步操作接入正式环境，实现真实的 IMAP/SMTP 连接验证和账户同步功能。

---

## 🎯 实现目标

### 账户添加验证
- ✅ 添加账户时自动验证 IMAP 连接
- ✅ 添加账户时自动验证 SMTP 连接
- ✅ 显示连接验证结果
- ✅ 保存验证状态到账户信息

### 账户同步
- ✅ 支持手动同步单个账户
- ✅ 支持同步所有账户
- ✅ 同步账户连接状态
- ✅ 同步文件夹列表

### 兼容性
- ✅ 支持 OAuth2 测试模式（跳过验证）
- ✅ 支持 IMAP/SMTP 普通认证
- ✅ 向后兼容旧的 addAccount 方法

---

## 📝 修改的文件

### 1. `src/stores/account.js`

#### 新增功能

##### A. 验证账户连接
```javascript
/**
 * 验证账户连接
 * 测试 IMAP 和 SMTP 连接是否正常
 */
async function verifyAccount(account) {
  const results = {
    imap: false,
    smtp: false,
    errors: [],
  }
  
  // OAuth2 测试模式跳过验证
  if (account.oauth2 && account.testMode) {
    return { imap: true, smtp: true, testMode: true }
  }
  
  // 验证 IMAP 连接
  try {
    await imapService.connect({
      email: account.email,
      password: account.password || account.accessToken,
      imapHost: account.imapHost,
      imapPort: account.imapPort,
    })
    results.imap = true
    await imapService.disconnect()
  } catch (error) {
    results.errors.push(`IMAP: ${error.message}`)
  }
  
  // 验证 SMTP 连接
  try {
    await smtpService.verify({
      email: account.email,
      password: account.password || account.accessToken,
      smtpHost: account.smtpHost,
      smtpPort: account.smtpPort,
    })
    results.smtp = true
  } catch (error) {
    results.errors.push(`SMTP: ${error.message}`)
  }
  
  return results
}
```

**特点**：
- ✅ 分别验证 IMAP 和 SMTP
- ✅ 记录详细错误信息
- ✅ 支持 OAuth2 测试模式
- ✅ 验证后自动断开 IMAP 连接

##### B. 带验证的添加账户
```javascript
/**
 * 添加账户（带连接验证）
 */
async function addAccountWithVerify(account, skipVerify = false) {
  const newAccount = {
    id: Date.now().toString(),
    ...account,
    connected: false,
    createdAt: new Date().toISOString(),
  }
  
  // 如果不跳过验证，尝试连接
  if (!skipVerify) {
    const verifyResult = await verifyAccount(newAccount)
    newAccount.connected = verifyResult.imap && verifyResult.smtp
    newAccount.verifyResult = verifyResult
    newAccount.lastVerifiedAt = new Date().toISOString()
  }
  
  accounts.value.push(newAccount)
  await saveAccounts()
  
  return newAccount
}
```

**验证结果结构**：
```javascript
{
  connected: true,  // 是否连接成功
  verifyResult: {
    imap: true,     // IMAP 连接状态
    smtp: true,     // SMTP 连接状态
    errors: [],     // 错误信息列表
    testMode: false // 是否为测试模式
  },
  lastVerifiedAt: "2025-10-19T10:30:00.000Z"
}
```

##### C. 同步账户
```javascript
/**
 * 同步账户
 * 重新验证账户连接并更新状态
 */
async function syncAccount(accountId) {
  const account = accounts.value.find(acc => acc.id === accountId)
  if (!account) {
    throw new Error('账户不存在')
  }
  
  // 验证连接
  const verifyResult = await verifyAccount(account)
  
  // 更新账户信息
  await updateAccount(accountId, {
    connected: verifyResult.imap && verifyResult.smtp,
    verifyResult,
    lastSyncedAt: new Date().toISOString(),
  })
  
  return verifyResult
}
```

##### D. 同步所有账户
```javascript
/**
 * 同步所有账户
 */
async function syncAllAccounts() {
  const results = []
  
  for (const account of accounts.value) {
    try {
      const result = await syncAccount(account.id)
      results.push({
        accountId: account.id,
        email: account.email,
        success: result.imap && result.smtp,
        result,
      })
    } catch (error) {
      results.push({
        accountId: account.id,
        email: account.email,
        success: false,
        error: error.message,
      })
    }
  }
  
  return results
}
```

##### E. 断开账户连接
```javascript
/**
 * 断开账户连接
 */
async function disconnectAccount(accountId) {
  await updateAccount(accountId, {
    connected: false,
    disconnectedAt: new Date().toISOString(),
  })
}
```

##### F. 兼容性方法
```javascript
/**
 * 添加账户（兼容方法，默认不验证）
 */
async function addAccount(account) {
  return await addAccountWithVerify(account, true)
}
```

**导出的 API**：
```javascript
return {
  accounts,
  currentAccountId,
  currentAccount,
  loadAccounts,
  addAccount,              // 兼容方法
  addAccountWithVerify,    // 带验证
  verifyAccount,           // 验证账户
  syncAccount,             // 同步单个账户
  syncAllAccounts,         // 同步所有账户
  updateAccount,
  deleteAccount,
  disconnectAccount,       // 断开连接
  switchAccount,
  logout,
}
```

---

### 2. `src/views/Login.vue`

#### 修改的添加账户流程

```javascript
async function handleAddAccount() {
  await formRef.value.validate()
  
  const config = emailConfigs[formData.type]
  let account
  let skipVerify = false  // 是否跳过验证
  
  if (isOAuth2.value) {
    // OAuth2 认证流程
    const result = await oauth2Service.authenticate(formData.type, formData.email)
    
    account = {
      type: formData.type,
      email: formData.email,
      name: formData.name || formData.email.split('@')[0],
      ...config,
      accessToken: result.accessToken,
      refreshToken: result.refreshToken,
      connected: true,
      oauth2: true,
    }
    
    // OAuth2 测试模式，跳过验证
    if (result.testMode) {
      account.testMode = true
      skipVerify = true
    }
  } else {
    // IMAP/SMTP 认证
    account = {
      type: formData.type,
      email: formData.email,
      password: formData.password,
      name: formData.name || formData.email.split('@')[0],
      ...config,
      connected: false,
    }
  }
  
  // 添加账户并验证连接
  const loadingMsg = message.loading('正在验证账户连接...', 0)
  
  try {
    const newAccount = await accountStore.addAccountWithVerify(account, skipVerify)
    loadingMsg()
    
    // 检查验证结果
    if (!skipVerify && newAccount.verifyResult) {
      const { imap, smtp, errors } = newAccount.verifyResult
      
      if (imap && smtp) {
        message.success('账户添加成功，连接验证通过')
      } else {
        const errorMsg = errors.join('; ')
        message.warning(`账户已添加，但连接验证失败: ${errorMsg}`)
      }
    } else {
      message.success('账户添加成功')
    }
    
    // 自动登录新添加的账户
    await handleLogin(newAccount)
  } catch (error) {
    loadingMsg()
    throw error
  }
}
```

**改进点**：
- ✅ 添加 `skipVerify` 标志
- ✅ OAuth2 测试模式跳过验证
- ✅ 显示验证进度提示
- ✅ 根据验证结果显示不同消息
- ✅ 保留自动登录功能

---

### 3. `src/views/Main.vue`

#### 修改的同步功能

```javascript
/**
 * 同步邮件
 */
async function handleSync() {
  try {
    syncing.value = true
    const account = accountStore.currentAccount
    
    if (!account) {
      message.error('请先选择一个账户')
      return
    }
    
    // 同步账户连接
    const loadingMsg = message.loading('正在同步账户...', 0)
    
    try {
      const result = await accountStore.syncAccount(account.id)
      loadingMsg()
      
      if (result.imap && result.smtp) {
        message.success('账户同步成功')
        
        // 同步文件夹
        await mailStore.syncServerFolders()
        
        // TODO: 同步邮件
        // await mailStore.syncMails()
      } else {
        const errorMsg = result.errors?.join('; ') || '未知错误'
        message.error(`同步失败: ${errorMsg}`)
      }
    } catch (error) {
      loadingMsg()
      throw error
    }
  } catch (error) {
    message.error('同步失败：' + error.message)
  } finally {
    syncing.value = false
  }
}
```

**同步流程**：
1. 验证当前账户
2. 同步账户连接状态
3. 如果连接成功，同步文件夹
4. （未来）同步邮件列表

---

## 🔧 技术实现

### IMAP/SMTP 服务调用

#### IMAP 连接验证
```javascript
// 渲染进程（Vue 组件）
const account = {
  email: 'test@qq.com',
  password: 'authcode123',
  imapHost: 'imap.qq.com',
  imapPort: 993,
}

// 调用验证
await imapService.connect(account)
// 成功：连接建立
// 失败：抛出错误

await imapService.disconnect()
```

#### SMTP 连接验证
```javascript
// 渲染进程
const account = {
  email: 'test@qq.com',
  password: 'authcode123',
  smtpHost: 'smtp.qq.com',
  smtpPort: 465,
}

// 调用验证
await smtpService.verify(account)
// 成功：返回 true
// 失败：抛出错误
```

### IPC 通信流程

```
┌─────────────────────────────────────┐
│      渲染进程（Vue 组件）             │
│  await imapService.connect(config)  │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  src/services/imap.js (IPC 调用)    │
│  window.electronAPI.connectImap()   │
└──────────────┬──────────────────────┘
               ↓ IPC
┌─────────────────────────────────────┐
│     Electron 主进程                  │
│  ipcMain.handle('connect-imap')     │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  electron/services/imap-main.js     │
│  真实的 IMAP 库操作                  │
└─────────────────────────────────────┘
```

---

## 📊 账户状态管理

### 账户数据结构

```javascript
{
  // 基本信息
  id: "1729382400000",
  type: "qq",
  email: "test@qq.com",
  name: "测试账户",
  
  // 配置信息
  imapHost: "imap.qq.com",
  imapPort: 993,
  smtpHost: "smtp.qq.com",
  smtpPort: 465,
  
  // 认证信息
  password: "encrypted_password",  // IMAP/SMTP
  // 或
  accessToken: "...",              // OAuth2
  refreshToken: "...",
  oauth2: true,
  
  // 连接状态
  connected: true,                 // 当前连接状态
  verifyResult: {                  // 验证结果
    imap: true,
    smtp: true,
    errors: [],
    testMode: false
  },
  
  // 时间戳
  createdAt: "2025-10-19T10:00:00.000Z",
  lastVerifiedAt: "2025-10-19T10:30:00.000Z",
  lastSyncedAt: "2025-10-19T10:35:00.000Z",
  disconnectedAt: null
}
```

### 状态流转

```
添加账户
  ↓
验证连接（可选）
  ↓
connected = true/false
  ↓
保存账户
  ↓
登录使用
  ↓
定期同步
  ↓
更新 connected 状态
```

---

## 🧪 测试场景

### 场景 1: 添加 QQ 邮箱（正确授权码）

**操作**：
1. 点击"添加邮箱账户"
2. 选择"QQ邮箱"
3. 输入邮箱：`your@qq.com`
4. 输入授权码：`正确的授权码`
5. 点击确定

**预期结果**：
```
1. 显示"正在验证账户连接..."
2. IMAP 连接测试：成功 ✅
3. SMTP 连接测试：成功 ✅
4. 显示"账户添加成功，连接验证通过"
5. 账户状态：
   - connected: true
   - verifyResult.imap: true
   - verifyResult.smtp: true
6. 自动登录并跳转到主界面
```

### 场景 2: 添加 QQ 邮箱（错误授权码）

**操作**：
1. 添加 QQ 邮箱
2. 输入错误的授权码

**预期结果**：
```
1. 显示"正在验证账户连接..."
2. IMAP 连接测试：失败 ❌
3. SMTP 连接测试：失败 ❌
4. 显示"账户已添加，但连接验证失败: IMAP: Authentication failed; SMTP: Invalid login"
5. 账户状态：
   - connected: false
   - verifyResult.imap: false
   - verifyResult.smtp: false
   - verifyResult.errors: ["IMAP: ...", "SMTP: ..."]
6. 仍然可以登录（但无法收发邮件）
```

### 场景 3: Gmail OAuth2 测试模式

**操作**：
1. 添加 Gmail 账户
2. 未配置真实 Client ID（使用测试模式）

**预期结果**：
```
1. OAuth2 认证返回模拟令牌
2. skipVerify = true（跳过连接验证）
3. 显示"账户添加成功"
4. 账户状态：
   - connected: true
   - oauth2: true
   - testMode: true
   - verifyResult: undefined（未验证）
5. 自动登录并跳转
```

### 场景 4: 手动同步账户

**操作**：
1. 进入主界面
2. 点击顶部的"同步"按钮

**预期结果**：
```
1. 显示"正在同步账户..."
2. 重新验证 IMAP/SMTP 连接
3. 更新账户 connected 状态
4. 如果成功，同步文件夹列表
5. 显示"账户同步成功"
6. 更新 lastSyncedAt 时间戳
```

### 场景 5: 163 邮箱（部分失败）

**操作**：
1. 添加 163 邮箱
2. IMAP 授权码正确，但 SMTP 配置错误

**预期结果**：
```
1. IMAP 连接测试：成功 ✅
2. SMTP 连接测试：失败 ❌
3. 显示"账户已添加，但连接验证失败: SMTP: Connection refused"
4. 账户状态：
   - connected: false（任一失败则为 false）
   - verifyResult.imap: true
   - verifyResult.smtp: false
   - verifyResult.errors: ["SMTP: ..."]
5. 可以接收邮件，但无法发送
```

---

## 🛡️ 安全考虑

### 1. 密码存储

**当前实现**：
```javascript
// 账户对象中直接存储密码（未加密）
{
  password: "user_password"
}
```

**建议改进**：
```javascript
import CryptoJS from 'crypto-js'

// 存储前加密
const encryptedPassword = CryptoJS.AES.encrypt(
  password,
  secretKey
).toString()

// 使用前解密
const decryptedPassword = CryptoJS.AES.decrypt(
  encryptedPassword,
  secretKey
).toString(CryptoJS.enc.Utf8)
```

### 2. OAuth2 令牌

**当前实现**：
```javascript
{
  accessToken: "token_value",
  refreshToken: "refresh_value",
  expiresAt: 1729382400000
}
```

**令牌刷新**（未实现）：
```javascript
// 检查令牌是否过期
if (Date.now() > account.expiresAt) {
  // 使用 refresh token 获取新的 access token
  const newTokens = await oauth2Service.refreshToken(
    account.type,
    account.refreshToken
  )
  
  // 更新账户
  await accountStore.updateAccount(account.id, {
    accessToken: newTokens.accessToken,
    expiresAt: newTokens.expiresAt,
  })
}
```

---

## 📈 性能优化

### 1. 并行验证

**当前实现**（串行）：
```javascript
// IMAP
await imapService.connect(...)
// SMTP
await smtpService.verify(...)
```

**优化建议**（并行）：
```javascript
const [imapResult, smtpResult] = await Promise.allSettled([
  imapService.connect(...),
  smtpService.verify(...),
])
```

### 2. 连接池

**问题**：
- 每次验证都建立新连接
- 连接建立耗时较长

**建议**：
```javascript
// 主进程维护连接池
class ImapMainService {
  constructor() {
    this.connections = new Map()  // accountId -> connection
  }
  
  async getConnection(accountId, config) {
    if (this.connections.has(accountId)) {
      return this.connections.get(accountId)
    }
    
    const connection = new Imap(config)
    await connection.connect()
    this.connections.set(accountId, connection)
    return connection
  }
}
```

### 3. 缓存验证结果

```javascript
// 验证结果缓存 5 分钟
const VERIFY_CACHE_DURATION = 5 * 60 * 1000

async function verifyAccount(account) {
  const now = Date.now()
  const lastVerified = new Date(account.lastVerifiedAt || 0).getTime()
  
  // 如果 5 分钟内验证过，直接返回缓存结果
  if (now - lastVerified < VERIFY_CACHE_DURATION && account.verifyResult) {
    console.log('[Account] Using cached verify result')
    return account.verifyResult
  }
  
  // 执行新的验证
  return await performVerify(account)
}
```

---

## 🔄 未来扩展

### 1. 邮件同步

```javascript
/**
 * 同步邮件（待实现）
 */
async function syncMails(folderId = 'inbox') {
  const account = accountStore.currentAccount
  
  // 连接 IMAP
  await imapService.connect(account)
  
  // 打开文件夹
  await imapService.openFolder(folderId)
  
  // 搜索邮件
  const uids = await imapService.searchMails(['ALL'])
  
  // 获取邮件
  const mails = await imapService.fetchMails(uids, {
    fetchBody: true
  })
  
  // 保存到本地
  for (const mail of mails) {
    await mailStore.addMail({
      uid: mail.uid,
      subject: mail.headers.subject,
      from: mail.headers.from,
      to: mail.headers.to,
      date: mail.headers.date,
      body: mail.body,
    })
  }
  
  await imapService.disconnect()
}
```

### 2. 增量同步

```javascript
/**
 * 增量同步（只同步新邮件）
 */
async function syncNewMails(folderId = 'inbox') {
  const lastSync = await getLastSyncUid(folderId)
  
  // 只搜索 UID 大于 lastSync 的邮件
  const uids = await imapService.searchMails([
    ['UID', `${lastSync + 1}:*`]
  ])
  
  // ... 同步逻辑
}
```

### 3. 后台自动同步

```javascript
// 每 5 分钟自动同步
setInterval(async () => {
  if (accountStore.currentAccount?.connected) {
    await syncMails()
  }
}, 5 * 60 * 1000)
```

---

## ⚠️ 已知限制

### 1. 同步性能

**问题**：
- 大量邮件同步时可能耗时较长
- 可能阻塞 UI 线程

**解决方案**：
- 使用 Web Worker 进行后台同步
- 或在主进程中执行同步操作

### 2. 错误处理

**当前实现**：
- 连接失败时只记录错误消息
- 用户无法看到详细的错误原因

**改进方向**：
- 提供更友好的错误提示
- 区分不同类型的错误（网络、认证、配置）
- 提供修复建议

### 3. 测试模式

**限制**：
- OAuth2 测试模式无法实际收发邮件
- IMAP/SMTP 测试模式未实现

**改进**：
```javascript
// IMAP/SMTP 测试模式
if (account.testMode && !account.oauth2) {
  // 使用模拟的 IMAP/SMTP 服务
  return mockImapService.connect(account)
}
```

---

## ✅ 总结

### 实现成果

✅ **账户验证**：
- 添加账户时自动验证连接
- 支持 IMAP 和 SMTP 分别验证
- 记录详细的验证结果

✅ **账户同步**：
- 手动同步单个账户
- 支持同步所有账户
- 更新连接状态

✅ **兼容性**：
- OAuth2 测试模式跳过验证
- 向后兼容旧方法
- 支持多种邮箱类型

### 使用流程

```bash
# 1. 添加账户
用户填写邮箱信息 → 验证连接 → 保存账户 → 自动登录

# 2. 同步账户
点击同步按钮 → 重新验证连接 → 更新状态 → 同步文件夹

# 3. 查看状态
账户列表中显示连接状态（绿点/灰点）
```

### 下一步计划

- [ ] 实现邮件列表同步
- [ ] 实现增量同步
- [ ] 添加后台自动同步
- [ ] 改进错误提示
- [ ] 添加密码加密
- [ ] 实现 OAuth2 令牌自动刷新

---

**实现时间**：2025-10-19  
**版本**：v1.0.0  
**状态**：✅ 核心功能已完成
