# 文件夹联动与账户管理优化实现文档

## 📋 需求概述

本次优化涉及三个功能改进：

1. **邮箱文件夹列表账户联动**：文件夹列表应该随选中账户进行联动显示
2. **账户管理界面优化**：新增账户时使用弹窗而非跳转登录页
3. **登录页代理设置入口**：在登录页添加网络代理设置界面

---

## 🎯 需求1：文件夹列表账户联动

### 问题描述

- **现象**：切换账户时，文件夹列表不会更新，仍显示之前账户的文件夹
- **期望**：选中不同账户时，文件夹列表应自动刷新为该账户的文件夹

### 实现方案

在主界面（`Main.vue`）的账户切换方法中，增加重新加载文件夹和邮件的逻辑。

### 代码实现

**文件**：`src/views/Main.vue`

修改 `handleAccountChange()` 方法：

```javascript
/**
 * 账户切换
 */
async function handleAccountChange(accountId) {
  try {
    // 1. 切换账户
    accountStore.switchAccount(accountId)
    
    // 2. 重新加载该账户的文件夹列表
    await mailStore.loadFolders()
    
    // 3. 重新加载邮件（默认加载收件箱）
    await mailStore.loadMails('inbox')
    
    // 4. 重置选中的文件夹为收件箱
    selectedFolders.value = ['inbox']
    
    message.success('已切换账户')
  } catch (error) {
    console.error('Switch account failed:', error)
    message.error('切换账户失败：' + error.message)
  }
}
```

### 功能流程

```
用户点击账户 → 切换账户状态 → 重新加载文件夹 → 重新加载邮件 → 重置选中项 → 提示成功
```

### 技术要点

1. **顺序执行**：必须等待 `loadFolders()` 完成后再加载邮件
2. **状态重置**：切换账户后重置选中的文件夹为 `inbox`
3. **错误处理**：提供清晰的错误提示

---

## 🎯 需求2：账户管理界面优化

### 问题描述

- **现象**：点击"添加账户"按钮跳转到登录页，体验不连贯
- **期望**：在当前页面打开弹窗添加账户，无需页面跳转

### 实现方案

创建独立的账户表单弹窗组件 `AccountFormModal.vue`，在设置页面中使用。

### 1. 创建账户表单组件

**文件**：`src/components/account/AccountFormModal.vue`

```vue
<template>
  <a-modal
    v-model:open="modalVisible"
    :title="isEditMode ? '编辑账户' : '添加邮箱账户'"
    :width="600"
    @ok="handleSubmit"
    @cancel="handleCancel"
  >
    <a-form
      ref="formRef"
      :model="formData"
      :rules="rules"
      layout="vertical"
    >
      <!-- 邮箱类型 -->
      <a-form-item label="邮箱类型" name="type">
        <a-select v-model:value="formData.type" @change="handleTypeChange">
          <a-select-option value="gmail">Gmail</a-select-option>
          <a-select-option value="outlook">Outlook/Hotmail</a-select-option>
          <a-select-option value="qq">QQ邮箱</a-select-option>
          <a-select-option value="163">163邮箱</a-select-option>
          <a-select-option value="126">126邮箱</a-select-option>
        </a-select>
      </a-form-item>
      
      <!-- 邮箱地址 -->
      <a-form-item label="邮箱地址" name="email">
        <a-input 
          v-model:value="formData.email" 
          placeholder="example@email.com"
          :disabled="isEditMode"
        />
      </a-form-item>
      
      <!-- 授权码/密码 -->
      <a-form-item v-if="!isOAuth2" label="授权码/密码" name="password">
        <a-input-password 
          v-model:value="formData.password" 
          placeholder="请输入授权码或密码" 
        />
      </a-form-item>
      
      <!-- 授权码提示（针对QQ、163、126邮箱） -->
      <a-alert
        v-if="formData.type === 'qq' || formData.type === '163' || formData.type === '126'"
        message="请使用授权码而非登录密码"
        type="warning"
        show-icon
        class="auth-code-alert"
      >
        <template #description>
          <div>
            <p><strong>获取授权码步骤：</strong></p>
            <ol style="margin: 8px 0; padding-left: 20px;">
              <li>登录邮箱网页版</li>
              <li>进入「设置」→「账户」</li>
              <li>找到「POP3/IMAP/SMTP服务」</li>
              <li>开启「IMAP/SMTP服务」</li>
              <li>生成授权码并保存（16位字符）</li>
              <li>在上方输入框中填写授权码</li>
            </ol>
            <p style="color: #ff4d4f; margin-bottom: 0;">
              注意：授权码不是邮箱登录密码！
            </p>
          </div>
        </template>
      </a-alert>
    </a-form>
  </a-modal>
</template>

<script setup>
import { ref, reactive, computed, watch, h } from 'vue'
import { message, Modal } from 'ant-design-vue'
import { useAccountStore } from '@/stores/account'
import { oauth2Service } from '@/services/oauth'

const props = defineProps({
  visible: { type: Boolean, default: false },
  account: { type: Object, default: null },  // 编辑模式时传入
})

const emit = defineEmits(['update:visible', 'success'])

const accountStore = useAccountStore()
const formRef = ref(null)
const modalVisible = computed({
  get: () => props.visible,
  set: (val) => emit('update:visible', val),
})

// 是否编辑模式
const isEditMode = computed(() => !!props.account)

// 表单数据
const formData = reactive({
  type: 'gmail',
  email: '',
  password: '',
  name: '',
})

// 邮箱配置
const emailConfigs = {
  gmail: {
    imapHost: 'imap.gmail.com',
    imapPort: 993,
    smtpHost: 'smtp.gmail.com',
    smtpPort: 465,
    oauth2: true,
  },
  outlook: {
    imapHost: 'outlook.office365.com',
    imapPort: 993,
    smtpHost: 'smtp.office365.com',
    smtpPort: 587,
    oauth2: true,
  },
  qq: {
    imapHost: 'imap.qq.com',
    imapPort: 993,
    smtpHost: 'smtp.qq.com',
    smtpPort: 465,
  },
  '163': {
    imapHost: 'imap.163.com',
    imapPort: 993,
    smtpHost: 'smtp.163.com',
    smtpPort: 465,
  },
  '126': {
    imapHost: 'imap.126.com',
    imapPort: 993,
    smtpHost: 'smtp.126.com',
    smtpPort: 465,
  },
}

// 是否使用OAuth2
const isOAuth2 = computed(() => {
  return formData.type === 'gmail' || formData.type === 'outlook'
})

// 表单验证规则
const rules = {
  type: [{ required: true, message: '请选择邮箱类型' }],
  email: [
    { required: true, message: '请输入邮箱地址' },
    { type: 'email', message: '请输入有效的邮箱地址' },
  ],
  password: [{ 
    required: !isOAuth2.value, 
    message: '请输入授权码或密码' 
  }],
}

// 监听账户变化（编辑模式）
watch(() => props.account, (account) => {
  if (account) {
    formData.type = account.type
    formData.email = account.email
    formData.name = account.name
    formData.password = ''  // 不显示密码
  }
}, { immediate: true })

// 监听弹窗关闭，重置表单
watch(() => props.visible, (visible) => {
  if (!visible && !props.account) {
    resetForm()
  }
})

function handleTypeChange() {
  formData.password = ''
}

function resetForm() {
  formData.type = 'gmail'
  formData.email = ''
  formData.password = ''
  formData.name = ''
  formRef.value?.resetFields()
}

function handleCancel() {
  modalVisible.value = false
  resetForm()
}

async function handleSubmit() {
  try {
    await formRef.value.validate()
    
    const config = emailConfigs[formData.type]
    let account
    let skipVerify = false
    
    // 编辑模式
    if (isEditMode.value) {
      const updates = {
        name: formData.name || formData.email.split('@')[0],
      }
      
      if (!isOAuth2.value && formData.password) {
        updates.password = formData.password
        updates.connected = false
      }
      
      await accountStore.updateAccount(props.account.id, updates)
      message.success('账户更新成功')
      modalVisible.value = false
      emit('success')
      return
    }
    
    // OAuth2 认证流程
    if (isOAuth2.value) {
      message.loading('正在进行 OAuth2 认证...', 0)
      
      try {
        const result = await oauth2Service.authenticate(formData.type, formData.email)
        message.destroy()
        
        if (!result.success) {
          message.error('认证失败：' + result.error)
          return
        }
        
        account = {
          type: formData.type,
          email: formData.email,
          name: formData.name || formData.email.split('@')[0],
          ...config,
          accessToken: result.accessToken,
          refreshToken: result.refreshToken,
          expiresAt: result.expiresAt,
          connected: true,
          oauth2: true,
        }
        
        skipVerify = true
        if (result.testMode) {
          account.testMode = true
        }
        
        message.success('OAuth2 认证成功')
      } catch (error) {
        message.destroy()
        message.error('OAuth2 认证失败，请使用测试模式')
        
        account = {
          type: formData.type,
          email: formData.email,
          name: formData.name || formData.email.split('@')[0],
          ...config,
          connected: false,
          oauth2: true,
          testMode: true,
        }
        skipVerify = true
      }
    } else {
      // IMAP/SMTP 认证
      account = {
        type: formData.type,
        email: formData.email,
        password: formData.password,
        name: formData.name || formData.email.split('@')[0],
        ...config,
        connected: false,
      }
    }
    
    // 添加账户并验证连接
    const loadingMsg = message.loading('正在验证账户连接...', 0)
    
    try {
      const newAccount = await accountStore.addAccountWithVerify(account, skipVerify)
      loadingMsg()
      
      // 检查验证结果
      if (!skipVerify && newAccount.verifyResult) {
        const { imap, smtp, errors } = newAccount.verifyResult
        
        if (imap && smtp) {
          message.success('账户添加成功，连接验证通过')
        } else {
          // 详细错误诊断
          let errorDetails = []
          
          if (!imap) {
            errorDetails.push('IMAP连接失败')
            errorDetails.push('请检查：')
            errorDetails.push('1. 是否已在邮箱网页版开启IMAP服务')
            errorDetails.push('2. 是否使用授权码（非登录密码）')
            errorDetails.push('3. 授权码是否正确')
          }
          
          if (!smtp) {
            if (errorDetails.length > 0) errorDetails.push('')
            errorDetails.push('SMTP连接失败')
            errorDetails.push('请检查：')
            errorDetails.push('1. 是否已在邮箱网页版开启SMTP服务')
            errorDetails.push('2. 是否使用授权码（非登录密码）')
          }
          
          const errorMsg = errors.join('; ')
          
          // 用户确认是否继续
          const confirmed = await new Promise((resolve) => {
            message.destroy()
            Modal.confirm({
              title: '连接验证失败',
              width: 500,
              content: h('div', [
                h('p', { 
                  style: 'color: #ff4d4f; margin-bottom: 12px; font-weight: 500;' 
                }, `错误信息：${errorMsg}`),
                h('div', { 
                  style: 'margin: 12px 0; padding: 12px; background: #fafafa; border-radius: 4px;' 
                }, errorDetails.map(detail => 
                  h('div', { 
                    style: detail.startsWith('IMAP') || detail.startsWith('SMTP') 
                      ? 'margin-top: 8px; font-weight: 500; color: #262626;' 
                      : 'margin-left: 16px; margin-top: 4px; color: #595959; font-size: 13px;'
                  }, detail)
                )),
                h('p', { 
                  style: 'color: #8c8c8c; margin-top: 12px; margin-bottom: 0;' 
                }, '是否仍然添加此账户？您可以稍后在设置中修复连接问题。'),
              ]),
              okText: '仍然添加',
              cancelText: '取消',
              onOk: () => resolve(true),
              onCancel: () => resolve(false),
            })
          })
          
          if (!confirmed) {
            await accountStore.deleteAccount(newAccount.id)
            return
          }
        }
      } else {
        message.success('账户添加成功')
      }
      
      modalVisible.value = false
      emit('success', newAccount)
      resetForm()
    } catch (error) {
      loadingMsg()
      throw error
    }
  } catch (error) {
    console.error('Submit account failed:', error)
    message.error('提交失败：' + error.message)
  }
}
</script>

<style lang="scss" scoped>
.auth-code-alert {
  margin-top: 12px;
  
  :deep(.ant-alert-description) {
    p {
      margin-bottom: 8px;
    }
    
    ol {
      margin: 8px 0;
      padding-left: 20px;
      
      li {
        margin-bottom: 4px;
        color: #595959;
      }
    }
  }
}
</style>
```

### 2. 在设置页面中使用

**文件**：`src/views/Settings.vue`

```vue
<script setup>
import AccountFormModal from '@/components/account/AccountFormModal.vue'

const accountFormVisible = ref(false)
const currentAccount = ref(null)

// 添加账户
function handleAddAccount() {
  currentAccount.value = null
  accountFormVisible.value = true  // 打开弹窗而非跳转
}

// 编辑账户
function handleEditAccount(account) {
  currentAccount.value = account
  accountFormVisible.value = true
}

// 账户提交成功
async function handleAccountSubmit(account) {
  // 如果是新添加的账户，切换到该账户
  if (account && !currentAccount.value) {
    accountStore.switchAccount(account.id)
    message.success('已切换到新账户')
  }
}
</script>

<template>
  <!-- ... -->
  
  <!-- 账户表单弹窗 -->
  <AccountFormModal
    v-model:visible="accountFormVisible"
    :account="currentAccount"
    @success="handleAccountSubmit"
  />
</template>
```

### 功能流程

```
用户点击"添加账户" → 打开弹窗 → 填写表单 → 验证连接 → 
  → 成功：添加账户 → 关闭弹窗 → 切换到新账户
  → 失败：显示错误诊断 → 用户确认是否继续
```

### 技术要点

1. **组件复用**：同时支持添加和编辑模式
2. **OAuth2支持**：Gmail/Outlook 使用 OAuth2 认证
3. **错误诊断**：提供详细的连接失败原因和解决方案
4. **用户确认**：验证失败时询问是否仍要添加账户

---

## 🎯 需求3：登录页代理设置入口

### 问题描述

- **现象**：用户在登录页无法配置代理，需要进入主界面后才能设置
- **期望**：在登录页提供代理设置入口，方便用户在首次使用时配置

### 实现方案

在登录页添加代理设置按钮和弹窗，参考设置页面的代理配置表单。

### 代码实现

**文件**：`src/views/Login.vue`

#### 1. 导入依赖

```javascript
import { GlobalOutlined } from '@ant-design/icons-vue'
import proxyConfig from '@/config/proxy'
```

#### 2. 添加状态和方法

```javascript
// 代理设置弹窗
const showProxySettings = ref(false)
const proxySettings = ref(proxyConfig.getConfig())
const testingProxy = ref(false)
const testUrl = ref('https://www.google.com')

// 保存代理设置
async function handleSaveProxySettings() {
  try {
    const success = await proxyConfig.saveConfig(proxySettings.value)
    if (success) {
      message.success('代理设置已保存')
      showProxySettings.value = false
    } else {
      message.error('保存失败')
    }
  } catch (error) {
    console.error('Save proxy config error:', error)
    message.error(`保存失败：${error.message}`)
  }
}

// 测试代理连接
async function handleTestProxy() {
  if (!proxySettings.value.enabled) {
    message.warning('请先启用代理')
    return
  }
  
  if (!testUrl.value || !testUrl.value.trim()) {
    message.warning('请输入测试 URL')
    return
  }
  
  try {
    new URL(testUrl.value)
  } catch (error) {
    message.warning('请输入有效的 URL（如 https://www.google.com）')
    return
  }
  
  testingProxy.value = true
  try {
    const result = await proxyConfig.testConnection(testUrl.value)
    if (result.success) {
      message.success(`代理连接测试成功 (${result.status || 200})`)
    } else {
      message.error(`连接失败：${result.message}`)
    }
  } catch (error) {
    message.error(`测试失败：${error.message}`)
  } finally {
    testingProxy.value = false
  }
}

// 重置代理设置
async function handleResetProxy() {
  try {
    await proxyConfig.resetConfig()
    proxySettings.value = proxyConfig.getConfig()
    message.success('已重置为默认设置')
  } catch (error) {
    console.error('Reset proxy config error:', error)
    message.error(`重置失败：${error.message}`)
  }
}

// 获取代理URL显示
function getProxyUrl() {
  const { protocol, host, port, auth } = proxySettings.value
  if (auth.enabled && auth.username) {
    return `${protocol}://${auth.username}:***@${host}:${port}`
  }
  return `${protocol}://${host}:${port}`
}
```

#### 3. 添加入口按钮

```vue
<template>
  <div class="login-page">
    <div class="login-container">
      <!-- ... 其他内容 ... -->
      
      <!-- 添加账户按钮 -->
      <a-button
        type="dashed"
        size="large"
        block
        class="add-account-btn"
        @click="showAddAccount = true"
      >
        <template #icon>
          <PlusOutlined />
        </template>
        添加邮箱账户
      </a-button>

      <!-- 代理设置入口 -->
      <a-button
        type="text"
        size="small"
        class="proxy-settings-btn"
        @click="showProxySettings = true"
      >
        <template #icon>
          <GlobalOutlined />
        </template>
        网络代理设置
      </a-button>
      
      <!-- ... -->
    </div>
  </div>
</template>
```

#### 4. 添加代理设置弹窗

```vue
<!-- 代理设置弹窗 -->
<a-modal
  v-model:open="showProxySettings"
  title="网络代理设置"
  :width="600"
  :footer="null"
>
  <a-form layout="horizontal" :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
    <!-- 启用代理 -->
    <a-form-item label="启用代理">
      <a-switch v-model:checked="proxySettings.enabled" />
      <span style="margin-left: 8px; color: #8C8C8C;">
        启用后所有网络请求将通过代理服务器
      </span>
    </a-form-item>

    <!-- 代理协议 -->
    <a-form-item label="代理协议">
      <a-select 
        v-model:value="proxySettings.protocol" 
        style="width: 200px"
        :disabled="!proxySettings.enabled"
      >
        <a-select-option value="http">HTTP</a-select-option>
        <a-select-option value="https">HTTPS</a-select-option>
      </a-select>
      <div style="margin-top: 4px; color: #8C8C8C; font-size: 12px;">
        💡 提示：推荐使用 HTTP 协议（HTTPS 可能遇到 TLS 证书问题）
      </div>
    </a-form-item>

    <!-- 服务器地址 -->
    <a-form-item label="服务器地址">
      <a-input 
        v-model:value="proxySettings.host" 
        placeholder="127.0.0.1"
        style="width: 300px"
        :disabled="!proxySettings.enabled"
      />
    </a-form-item>

    <!-- 端口 -->
    <a-form-item label="端口">
      <a-input-number 
        v-model:value="proxySettings.port" 
        :min="1" 
        :max="65535"
        placeholder="7890"
        style="width: 200px"
        :disabled="!proxySettings.enabled"
      />
    </a-form-item>

    <!-- 认证 -->
    <a-form-item label="认证">
      <a-switch 
        v-model:checked="proxySettings.auth.enabled" 
        :disabled="!proxySettings.enabled"
      />
      <span style="margin-left: 8px; color: #8C8C8C;">
        如果代理服务器需要身份验证，请启用
      </span>
    </a-form-item>

    <!-- 用户名 -->
    <a-form-item 
      v-if="proxySettings.auth.enabled" 
      label="用户名"
    >
      <a-input 
        v-model:value="proxySettings.auth.username" 
        placeholder="输入用户名"
        style="width: 300px"
        :disabled="!proxySettings.enabled"
      />
    </a-form-item>

    <!-- 密码 -->
    <a-form-item 
      v-if="proxySettings.auth.enabled" 
      label="密码"
    >
      <a-input-password 
        v-model:value="proxySettings.auth.password" 
        placeholder="输入密码"
        style="width: 300px"
        :disabled="!proxySettings.enabled"
      />
    </a-form-item>

    <a-divider style="margin: 24px 0" />

    <!-- 测试 URL -->
    <a-form-item label="测试 URL">
      <a-input 
        v-model:value="testUrl" 
        placeholder="https://www.google.com"
        style="width: 400px"
      >
        <template #addonAfter>
          <a-button 
            type="link" 
            size="small" 
            @click="testUrl = 'https://www.google.com'"
            style="padding: 0 8px"
          >
            重置
          </a-button>
        </template>
      </a-input>
      <div style="margin-top: 4px; color: #8C8C8C; font-size: 12px;">
        用于测试代理连接的 URL，支持 HTTP 和 HTTPS 协议
        <br/>
        💡 提示：如果 HTTPS 测试失败（TLS 错误），请使用 HTTP URL（如 
        <span style="color: #1890FF;">http://www.baidu.com</span>）
      </div>
    </a-form-item>

    <!-- 操作按钮 -->
    <a-form-item :wrapper-col="{ offset: 6 }">
      <a-space>
        <a-button type="primary" @click="handleSaveProxySettings">
          保存设置
        </a-button>
        <a-button @click="handleTestProxy" :loading="testingProxy">
          测试连接
        </a-button>
        <a-button @click="handleResetProxy">
          重置为默认
        </a-button>
      </a-space>
    </a-form-item>

    <!-- 当前代理信息 -->
    <a-alert
      v-if="proxySettings.enabled"
      message="代理配置信息"
      type="info"
      show-icon
      style="margin-top: 16px"
    >
      <template #description>
        <p><strong>当前代理：</strong> {{ getProxyUrl() }}</p>
        <p style="margin-top: 8px; color: #8C8C8C;">
          注意：修改代理设置后需要重启应用才能全面生效
        </p>
      </template>
    </a-alert>
  </a-form>
</a-modal>
```

#### 5. 添加样式

```scss
.proxy-settings-btn {
  margin-top: 16px;
  width: 100%;
  color: #8C8C8C;
  
  &:hover {
    color: var(--primary-color);
  }
}
```

### 功能流程

```
用户点击"网络代理设置" → 打开弹窗 → 配置代理参数 → 测试连接 → 保存设置 → 关闭弹窗
```

### 技术要点

1. **协议选择**：支持 HTTP/HTTPS 协议
2. **认证支持**：可选的用户名/密码认证
3. **连接测试**：提供测试 URL 验证代理配置
4. **错误处理**：TLS 证书问题的友好提示
5. **配置持久化**：使用 `proxyConfig` 模块保存配置

---

## 📊 修改文件清单

### 新增文件

1. **`src/components/account/AccountFormModal.vue`**（362行）
   - 账户添加/编辑弹窗组件
   - 支持 OAuth2 和 IMAP/SMTP 认证
   - 包含详细的错误诊断和用户确认

### 修改文件

1. **`src/views/Main.vue`**
   - 修改 `handleAccountChange()` 方法
   - 增加文件夹和邮件的重新加载逻辑
   - 重置选中状态

2. **`src/views/Settings.vue`**
   - 导入 `AccountFormModal` 组件
   - 修改 `handleAddAccount()` 使用弹窗而非跳转
   - 修改 `handleEditAccount()` 使用弹窗
   - 添加 `handleAccountSubmit()` 方法

3. **`src/views/Login.vue`**
   - 导入 `GlobalOutlined` 图标和 `proxyConfig`
   - 添加代理设置相关状态和方法
   - 添加代理设置入口按钮
   - 添加代理设置弹窗 UI
   - 添加样式

---

## ✅ 测试要点

### 需求1：文件夹列表账户联动

- [ ] 添加多个不同类型的邮箱账户
- [ ] 切换账户时，文件夹列表是否正确更新
- [ ] 切换账户后，邮件列表是否自动刷新为收件箱
- [ ] 错误场景：账户切换失败时的提示

### 需求2：账户管理界面优化

- [ ] 点击"添加账户"按钮，弹窗是否正常显示
- [ ] 填写表单后提交，账户是否正确添加
- [ ] OAuth2 认证流程是否正常（Gmail/Outlook）
- [ ] IMAP/SMTP 认证流程是否正常（QQ/163/126）
- [ ] 授权码提示是否正确显示
- [ ] 连接验证失败时，错误诊断是否详细
- [ ] 用户取消添加时，账户是否正确删除
- [ ] 编辑账户功能是否正常
- [ ] 弹窗关闭后，表单是否正确重置

### 需求3：登录页代理设置

- [ ] 代理设置入口按钮是否显示
- [ ] 点击按钮，代理设置弹窗是否正常打开
- [ ] 启用/禁用代理功能是否正常
- [ ] 协议选择（HTTP/HTTPS）是否正常
- [ ] 认证功能是否正常（用户名/密码）
- [ ] 测试连接功能是否正常
- [ ] 保存设置功能是否正常
- [ ] 重置为默认功能是否正常
- [ ] 当前代理信息显示是否正确
- [ ] TLS 错误提示是否友好

---

## 🎨 用户体验改进

### 1. 文件夹列表联动

**改进前**：
- 切换账户时，文件夹列表不更新
- 用户需要手动刷新或重启应用

**改进后**：
- 切换账户时，自动加载对应文件夹
- 自动刷新邮件列表
- 重置选中状态
- 提供清晰的成功/失败提示

### 2. 账户管理界面

**改进前**：
- 点击"添加账户"跳转到登录页
- 页面跳转体验不连贯
- 添加账户后需要手动返回

**改进后**：
- 使用弹窗添加账户，无页面跳转
- 统一的添加/编辑体验
- 详细的错误诊断和解决方案
- 添加成功后自动切换到新账户

### 3. 登录页代理设置

**改进前**：
- 登录页无法配置代理
- 用户需要登录后才能设置
- 首次使用体验不佳

**改进后**：
- 登录页提供代理设置入口
- 完整的代理配置功能
- 连接测试功能
- 友好的错误提示

---

## 📝 注意事项

1. **账户切换性能**
   - 文件夹和邮件加载可能需要时间
   - 建议显示加载状态
   - 考虑添加缓存机制

2. **代理设置生效**
   - 修改代理设置后建议重启应用
   - HTTP 协议比 HTTPS 更稳定
   - TLS 证书问题可能导致连接失败

3. **错误处理**
   - 所有异步操作都需要错误处理
   - 提供清晰的错误提示
   - 关键操作需要用户确认

4. **表单验证**
   - 邮箱地址格式验证
   - 授权码/密码必填验证
   - URL 格式验证

---

## 🔄 后续优化建议

1. **文件夹列表缓存**
   - 缓存每个账户的文件夹列表
   - 减少不必要的服务器请求
   - 提升切换速度

2. **账户验证优化**
   - 支持异步验证（后台进行）
   - 验证失败时提供重试选项
   - 保存验证历史记录

3. **代理设置增强**
   - 支持 SOCKS5 协议
   - 支持代理规则配置
   - 支持自动检测代理

4. **批量账户导入**
   - 支持 CSV 文件导入
   - 批量验证账户连接
   - 导入进度提示

---

## 📚 相关文档

- [邮件已读和星标操作服务器同步修复](./邮件已读和星标操作服务器同步修复.md)
- [批量操作功能实现](./批量操作功能实现.md)
- [QQ邮箱添加问题排查与修复](../04-问题修复/QQ邮箱添加问题排查与修复.md)
- [账户管理添加账户按钮修复](../04-问题修复/账户管理添加账户按钮修复.md)

---

**创建时间**：2025-10-22  
**修改时间**：2025-10-22  
**文档版本**：1.0.0
