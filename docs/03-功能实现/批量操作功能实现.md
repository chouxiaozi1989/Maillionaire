# 批量操作功能实现

## 功能概述

为主界面（收件箱、已发送等邮件列表页面）添加批量已读和删除操作功能，提升用户处理大量邮件的效率。

## 功能特性

### 1. 多选模式
- 点击「多选」按钮进入多选模式
- 多选模式下，每个邮件项显示复选框
- 再次点击「取消多选」退出多选模式并清空选中项

### 2. 邮件选择
- **单选**：点击邮件项或复选框选中/取消选中
- **全选**：点击「全选」按钮选中当前页所有邮件
- **反选**：全选状态下再次点击「全选」清空所有选中项
- **选中计数**：实时显示已选中的邮件数量

### 3. 批量操作
- **批量标记为已读**：一键将所有选中的邮件标记为已读
- **批量删除**：一键将所有选中的邮件移至回收站
- 操作前有二次确认（删除操作）
- 操作后显示成功提示并清空选中项

### 4. 服务器同步
- 批量标记已读：调用 Gmail API 或 IMAP 协议同步到服务器
- 批量删除：调用 Gmail API 或 IMAP 协议同步到服务器
- 使用 `Promise.all` 并发执行，提升批量操作性能

## 技术实现

### 1. Store 层实现（`src/stores/mail.js`）

#### 新增状态
```javascript
const selectedMailIds = ref([])  // 已选中的邮件ID列表
```

#### 选择相关方法
```javascript
/**
 * 选择邮件
 */
function selectMail(mailId) {
  if (!selectedMailIds.value.includes(mailId)) {
    selectedMailIds.value.push(mailId)
  }
}

/**
 * 取消选择
 */
function unselectMail(mailId) {
  selectedMailIds.value = selectedMailIds.value.filter(id => id !== mailId)
}

/**
 * 清空选择
 */
function clearSelection() {
  selectedMailIds.value = []
}

/**
 * 全选当前文件夹的邮件
 */
function selectAll() {
  selectedMailIds.value = currentMails.value.map(m => m.id)
}

/**
 * 反选
 */
function invertSelection() {
  const currentIds = currentMails.value.map(m => m.id)
  selectedMailIds.value = currentIds.filter(id => !selectedMailIds.value.includes(id))
}
```

#### 批量操作方法
```javascript
/**
 * 批量标记为已读
 * @param {string[]} mailIds - 邮件ID列表
 * @returns {Promise<void>}
 */
async function batchMarkAsRead(mailIds) {
  if (!mailIds || mailIds.length === 0) {
    return
  }

  try {
    console.log(`[Mail] Batch marking ${mailIds.length} mails as read...`)
    
    // 并发标记为已读
    const promises = mailIds.map(mailId => markAsReadOnServer(mailId, true))
    await Promise.all(promises)
    
    console.log('[Mail] Batch mark as read completed')
  } catch (error) {
    console.error('[Mail] Failed to batch mark as read:', error)
    throw error
  }
}

/**
 * 批量删除邮件
 * @param {string[]} mailIds - 邮件ID列表
 * @returns {Promise<void>}
 */
async function batchDelete(mailIds) {
  if (!mailIds || mailIds.length === 0) {
    return
  }

  try {
    console.log(`[Mail] Batch deleting ${mailIds.length} mails...`)
    
    // 并发删除（移至回收站）
    const promises = mailIds.map(mailId => deleteMailFromServer(mailId))
    await Promise.all(promises)
    
    console.log('[Mail] Batch delete completed')
  } catch (error) {
    console.error('[Mail] Failed to batch delete:', error)
    throw error
  }
}
```

#### 导出方法
```javascript
return {
  // ... 其他导出
  selectMail,
  unselectMail,
  clearSelection,
  // 批量操作方法
  batchMarkAsRead,
  batchDelete,
  selectAll,
  invertSelection,
}
```

### 2. 组件层实现（`src/components/mail/MailItem.vue`）

#### 新增 Props
```javascript
const props = defineProps({
  mail: {
    type: Object,
    required: true,
  },
  selected: {
    type: Boolean,
    default: false,
  },
  selectable: {
    type: Boolean,  // 是否显示复选框（多选模式）
    default: false,
  },
})
```

#### 新增 Emit
```javascript
const emit = defineEmits(['click', 'star', 'delete', 'select'])
```

#### 模板修改
```vue
<template>
  <div
    class="mail-item"
    :class="{ unread: !mail.read, selected: isSelected }"
    @click="handleClick"
  >
    <!-- 多选框 -->
    <a-checkbox
      v-if="selectable"
      :checked="isSelected"
      @click.stop
      @change="handleSelectChange"
      class="mail-checkbox"
    />

    <!-- 未读标记 -->
    <div v-if="!mail.read" class="unread-dot"></div>

    <!-- 邮件内容 -->
    <div class="mail-content">
      <!-- ... 其他内容 -->
    </div>

    <!-- 操作按钮 -->
    <div class="mail-actions" @click.stop>
      <!-- ... 星标、删除按钮 -->
    </div>
  </div>
</template>
```

#### 交互逻辑
```javascript
/**
 * 点击邮件
 */
function handleClick() {
  if (props.selectable) {
    // 多选模式下，点击切换选中状态
    handleSelectChange(!isSelected.value)
  } else {
    // 正常模式下，打开详情
    emit('click', props.mail)
  }
}

/**
 * 选中状态改变
 */
function handleSelectChange(checked) {
  emit('select', props.mail, checked)
}
```

#### 样式
```scss
.mail-checkbox {
  margin-top: 4px;
  flex-shrink: 0;
}
```

### 3. 页面层实现（`src/views/mail/Inbox.vue`）

#### 状态管理
```javascript
const isSelectMode = ref(false)  // 多选模式

// 计算属性
const selectedMailIds = computed(() => mailStore.selectedMailIds)
const selectedCount = computed(() => selectedMailIds.value.length)
```

#### 工具栏 UI
```vue
<div class="toolbar">
  <div class="toolbar-left">
    <!-- 多选模式切换 -->
    <a-button
      :type="isSelectMode ? 'primary' : 'default'"
      @click="toggleSelectMode"
    >
      <template #icon>
        <CheckSquareOutlined v-if="isSelectMode" />
        <BorderOutlined v-else />
      </template>
      {{ isSelectMode ? '取消多选' : '多选' }}
    </a-button>

    <!-- 批量操作按钮（仅在多选模式且有选中项时显示） -->
    <template v-if="isSelectMode && selectedCount > 0">
      <a-divider type="vertical" />

      <a-space>
        <a-button @click="handleSelectAll">
          全选 ({{ selectedCount }}/{{ mails.length }})
        </a-button>

        <a-button @click="handleBatchMarkAsRead">
          <template #icon>
            <CheckOutlined />
          </template>
          标为已读
        </a-button>

        <a-popconfirm
          title="确定要删除选中的邮件吗？"
          ok-text="确定"
          cancel-text="取消"
          @confirm="handleBatchDelete"
        >
          <a-button danger>
            <template #icon>
              <DeleteOutlined />
            </template>
            删除
          </a-button>
        </a-popconfirm>
      </a-space>
    </template>

    <!-- 筛选条件 -->
    <!-- ... -->
  </div>
</div>
```

#### 邮件列表
```vue
<MailItem
  v-for="mail in mails"
  :key="mail.id"
  :mail="mail"
  :selected="selectedMailIds.includes(mail.id)"
  :selectable="isSelectMode"
  @click="handleMailClick(mail)"
  @select="handleMailSelect"
  @star="handleToggleStar(mail)"
  @delete="handleDeleteMail(mail)"
/>
```

#### 交互方法
```javascript
/**
 * 切换多选模式
 */
function toggleSelectMode() {
  isSelectMode.value = !isSelectMode.value
  if (!isSelectMode.value) {
    // 退出多选模式时清空选中项
    mailStore.clearSelection()
  }
}

/**
 * 处理邮件选中
 */
function handleMailSelect(mail, checked) {
  if (checked) {
    mailStore.selectMail(mail.id)
  } else {
    mailStore.unselectMail(mail.id)
  }
}

/**
 * 全选/反选
 */
function handleSelectAll() {
  if (selectedCount.value === mails.value.length) {
    // 已全选，清空选中
    mailStore.clearSelection()
  } else {
    // 未全选，全选
    mailStore.selectAll()
  }
}

/**
 * 批量标记为已读
 */
async function handleBatchMarkAsRead() {
  if (selectedCount.value === 0) {
    message.warning('请先选择邮件')
    return
  }

  try {
    loading.value = true
    await mailStore.batchMarkAsRead(selectedMailIds.value)
    message.success(`已将 ${selectedCount.value} 封邮件标记为已读`)
    mailStore.clearSelection()
  } catch (error) {
    message.error('批量标记失败：' + error.message)
  } finally {
    loading.value = false
  }
}

/**
 * 批量删除
 */
async function handleBatchDelete() {
  if (selectedCount.value === 0) {
    message.warning('请先选择邮件')
    return
  }

  try {
    loading.value = true
    await mailStore.batchDelete(selectedMailIds.value)
    message.success(`已将 ${selectedCount.value} 封邮件移至回收站`)
    mailStore.clearSelection()
  } catch (error) {
    message.error('批量删除失败：' + error.message)
  } finally {
    loading.value = false
  }
}

/**
 * 邮件点击
 */
function handleMailClick(mail) {
  // 多选模式下不打开详情
  if (isSelectMode.value) {
    return
  }

  selectedMail.value = mail
  showDetailModal.value = true
  
  // 标记为已读
  if (!mail.read) {
    mailStore.markAsRead(mail.id)
  }
}
```

#### 样式调整
```scss
.toolbar {
  min-height: 56px;
  padding: 12px 16px;
  border-bottom: 1px solid #F0F0F0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;  // 工具栏项过多时换行
  gap: 8px;
}

.toolbar-left {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;  // 左侧工具栏项过多时换行
}
```

## 使用流程

### 批量标记已读
1. 点击「多选」按钮进入多选模式
2. 点击邮件项或复选框选中需要标记的邮件
3. 点击「标为已读」按钮
4. 系统并发调用服务器 API 标记所有选中邮件
5. 显示成功提示并清空选中项

### 批量删除
1. 点击「多选」按钮进入多选模式
2. 点击邮件项或复选框选中需要删除的邮件
3. 点击「删除」按钮
4. 确认删除操作
5. 系统并发调用服务器 API 删除所有选中邮件
6. 显示成功提示并清空选中项

## 性能优化

### 1. 并发执行
使用 `Promise.all` 并发执行多个邮件操作，而不是串行执行：

```javascript
// ❌ 串行执行（慢）
for (const mailId of mailIds) {
  await markAsReadOnServer(mailId)
}

// ✅ 并发执行（快）
const promises = mailIds.map(mailId => markAsReadOnServer(mailId))
await Promise.all(promises)
```

### 2. 错误处理
如果某个邮件操作失败，不影响其他邮件的操作：

```javascript
// 使用 Promise.allSettled 处理部分失败的情况（可选）
const results = await Promise.allSettled(promises)
const failed = results.filter(r => r.status === 'rejected')
if (failed.length > 0) {
  message.warning(`成功 ${results.length - failed.length} 封，失败 ${failed.length} 封`)
}
```

### 3. UI 响应
- 批量操作时显示 loading 状态
- 操作完成后立即更新 UI
- 显示操作结果提示

## 扩展功能

### 未来可添加的功能
1. **批量移动**：批量移动邮件到指定文件夹
2. **批量加星标**：批量添加/移除星标
3. **批量标记未读**：将已读邮件批量标记为未读
4. **批量归档**：批量归档邮件
5. **批量应用标签**：为多封邮件批量添加 Gmail 标签
6. **选择范围**：Shift + 点击选择连续范围
7. **快捷键支持**：
   - `Ctrl/Cmd + A`：全选
   - `Delete`：删除选中邮件
   - `R`：标记选中邮件为已读

## 注意事项

1. **多选模式**：进入多选模式后，点击邮件不会打开详情，只会切换选中状态
2. **退出清空**：退出多选模式时自动清空选中项
3. **服务器同步**：所有批量操作都会同步到服务器（Gmail API 或 IMAP）
4. **操作确认**：删除操作有二次确认，防止误操作
5. **空选提示**：未选中任何邮件时操作会有友好提示

## 测试建议

1. **功能测试**：
   - 测试多选模式的进入和退出
   - 测试单选、全选、反选功能
   - 测试批量标记已读功能
   - 测试批量删除功能

2. **边界测试**：
   - 空列表时的多选模式
   - 未选中任何邮件时的批量操作
   - 全选大量邮件（如 100 封）的性能

3. **服务器同步测试**：
   - Gmail 账户：验证 API 调用是否正确
   - IMAP 账户：验证 IMAP 命令是否正确
   - 在网页版邮箱中验证更改是否同步

4. **用户体验测试**：
   - 批量操作的响应速度
   - Loading 状态显示是否友好
   - 操作提示信息是否清晰

## 相关文件

- `src/stores/mail.js` - 邮件状态管理，批量操作方法
- `src/components/mail/MailItem.vue` - 邮件项组件，支持多选
- `src/views/mail/Inbox.vue` - 收件箱页面，批量操作 UI
- `src/services/gmail-api.js` - Gmail API 服务
- `src/services/imap.js` - IMAP 服务

## 总结

批量操作功能显著提升了用户处理大量邮件的效率：
- ✅ 直观的多选模式切换
- ✅ 灵活的邮件选择方式
- ✅ 强大的批量操作能力
- ✅ 完整的服务器同步
- ✅ 友好的用户体验

通过并发执行和错误处理，确保了批量操作的性能和稳定性。
