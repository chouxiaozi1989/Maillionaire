# 代理配置功能实现

> 实现日期：2025-10-19  
> 版本：v1.1.0  
> 功能：系统代理配置

---

## 📋 功能概述

为 Maillionaire 添加系统代理配置功能，允许用户通过代理服务器进行所有网络连接，支持 SOCKS 和 HTTP/HTTPS 代理协议。

---

## 🎯 功能特性

### 支持的代理类型

1. **SOCKS5** - 推荐，支持 TCP/UDP
2. **SOCKS4** - 仅支持 TCP
3. **HTTP** - HTTP 代理
4. **HTTPS** - HTTPS 代理

### 默认配置

```javascript
{
  enabled: false,           // 默认关闭
  protocol: 'socks5',      // 默认使用 SOCKS5
  host: '127.0.0.1',       // 默认本地地址
  port: 7890,              // 默认端口 7890
  auth: {
    enabled: false,        // 默认不启用认证
    username: '',
    password: '',
  }
}
```

### 主要功能

- ✅ 启用/禁用代理
- ✅ 配置代理协议（SOCKS5/SOCKS4/HTTP/HTTPS）
- ✅ 配置代理服务器地址和端口
- ✅ 可选的用户名密码认证
- ✅ 测试代理连接
- ✅ 重置为默认配置
- ✅ 配置持久化保存

---

## 📁 新增文件

### 1. src/config/proxy.js

**代理配置管理模块**

**主要功能：**

```javascript
class ProxyConfig {
  // 加载配置
  loadConfig()
  
  // 保存配置
  saveConfig(config)
  
  // 获取配置
  getConfig()
  
  // 重置配置
  resetConfig()
  
  // 获取代理 URL（用于 axios）
  getProxyUrl()
  
  // 获取 Electron 代理配置
  getElectronProxyConfig()
  
  // 测试代理连接
  async testConnection()
}
```

**使用示例：**

```javascript
import proxyConfig from '@/config/proxy'

// 获取配置
const config = proxyConfig.getConfig()

// 保存配置
proxyConfig.saveConfig({
  enabled: true,
  protocol: 'socks5',
  host: '127.0.0.1',
  port: 7890,
})

// 获取代理 URL
const proxyUrl = proxyConfig.getProxyUrl()
// 返回: 'socks5://127.0.0.1:7890'

// 测试连接
const result = await proxyConfig.testConnection()
```

---

## 🖥️ 界面修改

### Settings.vue 更新

**新增菜单项：**

```vue
<a-menu-item key="proxy">
  <template #icon>
    <GlobalOutlined />
  </template>
  代理设置
</a-menu-item>
```

**代理设置面板：**

包含以下配置项：

1. **启用代理** - 开关
2. **代理协议** - 下拉选择（SOCKS5/SOCKS4/HTTP/HTTPS）
3. **服务器地址** - 文本输入
4. **端口** - 数字输入（1-65535）
5. **认证** - 开关
6. **用户名** - 文本输入（认证启用时）
7. **密码** - 密码输入（认证启用时）

**操作按钮：**

- **保存设置** - 保存代理配置
- **测试连接** - 测试代理是否可用
- **重置为默认** - 恢复默认配置

**配置信息提示：**

```vue
<a-alert type="info">
  <template #description>
    <p><strong>当前代理：</strong> socks5://127.0.0.1:7890</p>
    <p>注意：修改代理设置后需要重启应用才能全面生效</p>
  </template>
</a-alert>
```

---

## 🔧 技术实现

### 配置存储

**存储位置：** `localStorage`

**存储键：** `proxy_config`

**数据格式：**

```json
{
  "enabled": true,
  "protocol": "socks5",
  "host": "127.0.0.1",
  "port": 7890,
  "auth": {
    "enabled": false,
    "username": "",
    "password": ""
  }
}
```

### Axios 集成（未来）

**在 HTTP 请求中使用代理：**

```javascript
// src/utils/request.js
import axios from 'axios'
import proxyConfig from '@/config/proxy'

const request = axios.create({
  timeout: 30000,
})

// 配置代理
const proxyUrl = proxyConfig.getProxyUrl()
if (proxyUrl) {
  const url = new URL(proxyUrl)
  request.defaults.proxy = {
    protocol: url.protocol.replace(':', ''),
    host: url.hostname,
    port: parseInt(url.port),
    auth: url.username ? {
      username: url.username,
      password: url.password,
    } : undefined,
  }
}
```

### Electron 集成（推荐）

**在 Electron 主进程中配置代理：**

```javascript
// electron/main.js
const { app, session } = require('electron')

// 设置代理
function setProxy(proxyConfig) {
  if (!proxyConfig.enabled) {
    session.defaultSession.setProxy({ mode: 'direct' })
    return
  }
  
  const { protocol, host, port } = proxyConfig
  const proxyRules = `${protocol}://${host}:${port}`
  
  session.defaultSession.setProxy({
    mode: 'fixed_servers',
    proxyRules: proxyRules,
    proxyBypassRules: 'localhost,127.0.0.1',
  })
}

// 监听渲染进程的代理配置更新
ipcMain.handle('set-proxy-config', async (event, config) => {
  setProxy(config)
  return { success: true }
})
```

**在 preload.js 中暴露接口：**

```javascript
// electron/preload.js
const { contextBridge, ipcRenderer } = require('electron')

contextBridge.exposeInMainWorld('electron', {
  // 设置代理配置
  setProxyConfig: (config) => ipcRenderer.invoke('set-proxy-config', config),
  
  // 测试代理连接
  testProxy: (config) => ipcRenderer.invoke('test-proxy', config),
})
```

---

## 🔐 安全考虑

### 密码存储

**当前实现：**
- 密码存储在 `localStorage` 中（明文）

**推荐改进：**

```javascript
import CryptoJS from 'crypto-js'

// 加密存储
function saveConfig(config) {
  const encrypted = {
    ...config,
    auth: {
      ...config.auth,
      password: config.auth.password 
        ? CryptoJS.AES.encrypt(config.auth.password, SECRET_KEY).toString()
        : '',
    }
  }
  localStorage.setItem('proxy_config', JSON.stringify(encrypted))
}

// 解密读取
function loadConfig() {
  const saved = localStorage.getItem('proxy_config')
  if (saved) {
    const config = JSON.parse(saved)
    if (config.auth.password) {
      config.auth.password = CryptoJS.AES
        .decrypt(config.auth.password, SECRET_KEY)
        .toString(CryptoJS.enc.Utf8)
    }
    return config
  }
}
```

### 验证输入

**端口验证：**
```javascript
if (port < 1 || port > 65535) {
  throw new Error('端口必须在 1-65535 之间')
}
```

**地址验证：**
```javascript
const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/
const hostnamePattern = /^[a-zA-Z0-9.-]+$/

if (!ipPattern.test(host) && !hostnamePattern.test(host)) {
  throw new Error('无效的主机地址')
}
```

---

## 🧪 测试方法

### 1. 基本配置测试

**测试步骤：**
```
1. 打开设置 → 代理设置
2. 启用代理
3. 配置：
   - 协议：SOCKS5
   - 地址：127.0.0.1
   - 端口：7890
4. 点击"保存设置"
5. 刷新页面，验证配置是否保留
```

**预期结果：**
- ✅ 配置成功保存
- ✅ 刷新后配置保留
- ✅ 显示当前代理信息

### 2. 认证功能测试

**测试步骤：**
```
1. 启用代理
2. 启用认证
3. 输入用户名和密码
4. 保存配置
```

**预期结果：**
- ✅ 认证信息保存成功
- ✅ 密码字段显示为密码格式
- ✅ 配置信息不显示真实密码

### 3. 代理连接测试

**测试步骤：**
```
1. 配置本地代理（如 Clash、V2Ray）
2. 在设置中配置相应的地址和端口
3. 点击"测试连接"按钮
```

**预期结果：**
- ✅ 代理可用时显示"连接成功"
- ✅ 代理不可用时显示错误信息
- ✅ 测试过程显示加载状态

### 4. 重置功能测试

**测试步骤：**
```
1. 修改代理配置
2. 点击"重置为默认"
3. 验证配置是否恢复
```

**预期结果：**
- ✅ 恢复为默认配置：
  - enabled: false
  - protocol: 'socks5'
  - host: '127.0.0.1'
  - port: 7890
  - auth.enabled: false

---

## 📊 配置示例

### 示例 1：本地 Clash 代理

```json
{
  "enabled": true,
  "protocol": "socks5",
  "host": "127.0.0.1",
  "port": 7890,
  "auth": {
    "enabled": false
  }
}
```

### 示例 2：HTTP 代理（带认证）

```json
{
  "enabled": true,
  "protocol": "http",
  "host": "proxy.company.com",
  "port": 8080,
  "auth": {
    "enabled": true,
    "username": "user",
    "password": "pass123"
  }
}
```

### 示例 3：SOCKS4 代理

```json
{
  "enabled": true,
  "protocol": "socks4",
  "host": "127.0.0.1",
  "port": 1080,
  "auth": {
    "enabled": false
  }
}
```

---

## 🔮 后续计划

### 短期（1周内）
- [ ] 在 Electron 主进程实现代理配置
- [ ] 实现 IPC 通信（渲染进程 → 主进程）
- [ ] 完善代理连接测试功能

### 中期（1个月内）
- [ ] 密码加密存储
- [ ] 支持 PAC 自动代理配置
- [ ] 支持代理规则（绕过列表）

### 长期（3个月内）
- [ ] 支持多个代理配置切换
- [ ] 代理性能监控
- [ ] 自动检测最优代理

---

## 📝 使用说明

### 对于用户

**配置代理：**

1. 打开"设置" → "代理设置"
2. 启用代理开关
3. 选择代理协议（推荐 SOCKS5）
4. 输入代理服务器地址和端口
5. 如需认证，启用认证并输入用户名密码
6. 点击"保存设置"
7. 建议点击"测试连接"验证配置
8. **重启应用**使代理全面生效

**常见代理软件配置：**

| 软件 | 协议 | 默认端口 |
|------|------|---------|
| Clash | SOCKS5 | 7890 |
| V2Ray | SOCKS5 | 1080 |
| Shadowsocks | SOCKS5 | 1080 |
| HTTP Proxy | HTTP | 8080 |

### 对于开发者

**使用代理配置：**

```javascript
import proxyConfig from '@/config/proxy'

// 获取代理 URL
const proxyUrl = proxyConfig.getProxyUrl()

// 在 axios 请求中使用
axios.get('https://api.example.com', {
  proxy: {
    host: '127.0.0.1',
    port: 7890,
    protocol: 'socks5',
  }
})
```

---

## ✅ 验收清单

- [x] 创建 `src/config/proxy.js` 配置管理
- [x] 添加代理设置界面
- [x] 实现配置保存和加载
- [x] 实现配置重置功能
- [x] 添加测试连接功能
- [x] 添加配置信息提示
- [x] 创建功能文档
- [ ] Electron 主进程集成
- [ ] 密码加密存储
- [ ] 完善测试功能

---

## 📞 常见问题

### Q: 为什么修改代理后需要重启？

A: 某些网络连接在应用启动时建立，需要重启才能使用新的代理配置。

### Q: 支持哪些代理协议？

A: 支持 SOCKS5、SOCKS4、HTTP、HTTPS 四种协议，推荐使用 SOCKS5。

### Q: 代理密码安全吗？

A: 当前版本密码明文存储在 localStorage。后续版本将实现加密存储。

### Q: 如何测试代理是否工作？

A: 点击"测试连接"按钮，系统会尝试通过代理访问 Google 来验证连接。

---

**代理配置功能实现完成！🎉**

用户现在可以在设置中配置系统代理，支持各种代理软件和协议。

