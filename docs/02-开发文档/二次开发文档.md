# Maillionaire - 二次开发文档

## 📚 目录

1. [开发环境搭建](#开发环境搭建)
2. [项目架构](#项目架构)
3. [核心模块说明](#核心模块说明)
4. [开发指南](#开发指南)
5. [扩展功能](#扩展功能)
6. [调试技巧](#调试技巧)
7. [常见问题](#常见问题)

---

## 开发环境搭建

### 1. 前置要求

- **Node.js**: >= 16.x
- **npm**: >= 8.x 或 **yarn**: >= 1.22.x
- **Git**: 最新版本
- **编辑器**: VS Code（推荐）

### 2. 克隆项目

```bash
git clone https://github.com/maillionaire/maillionaire.git
cd maillionaire
```

### 3. 安装依赖

```bash
npm install
```

### 4. 启动开发服务器

```bash
# Web开发模式
npm run dev

# Electron开发模式
npm run electron:dev
```

### 5. VS Code推荐插件

- **Volar** - Vue 3官方插件
- **ESLint** - 代码规范检查
- **Prettier** - 代码格式化
- **Path Intellisense** - 路径自动完成
- **Auto Rename Tag** - 标签自动重命名

---

## 项目架构

### 技术栈

```
┌─────────────────────────────────────────┐
│         Electron (Desktop Shell)         │
├─────────────────────────────────────────┤
│  Vue 3 + Vite (Frontend Framework)      │
│  - Composition API                       │
│  - <script setup> syntax                 │
├─────────────────────────────────────────┤
│  Ant Design Vue (UI Components)         │
├─────────────────────────────────────────┤
│  Pinia (State Management)                │
│  - app store                             │
│  - account store                         │
│  - mail store                            │
│  - contact store                         │
├─────────────────────────────────────────┤
│  Services Layer                          │
│  - Storage Service (Local File Storage) │
│  - IMAP Service (Receive Mails)         │
│  - SMTP Service (Send Mails)            │
│  - OAuth Service (Authentication)       │
└─────────────────────────────────────────┘
```

### 目录结构详解

```
src/
├── assets/              # 静态资源
│   ├── images/          # 图片资源
│   ├── fonts/           # 字体文件
│   └── icons/           # 图标文件
│
├── components/          # 可复用组件
│   ├── common/          # 通用组件
│   │   ├── Button.vue
│   │   ├── Modal.vue
│   │   └── Loading.vue
│   ├── mail/            # 邮件相关组件
│   │   ├── MailList.vue
│   │   ├── MailItem.vue
│   │   └── MailDetail.vue
│   └── editor/          # 富文本编辑器
│       └── RichEditor.vue
│
├── views/               # 页面视图
│   ├── Login.vue        # 登录页
│   ├── Main.vue         # 主界面布局
│   ├── Contacts.vue     # 通讯录
│   ├── Settings.vue     # 设置页面
│   └── mail/            # 邮件页面
│
├── stores/              # Pinia状态管理
│   ├── app.js           # 应用全局状态
│   ├── account.js       # 账户管理
│   ├── mail.js          # 邮件管理
│   └── contact.js       # 通讯录管理
│
├── services/            # 业务逻辑服务
│   ├── storage.js       # 本地存储
│   ├── imap.js          # IMAP收件
│   ├── smtp.js          # SMTP发件
│   └── oauth.js         # OAuth2认证
│
├── router/              # 路由配置
│   └── index.js
│
├── utils/               # 工具函数
│   ├── date.js          # 日期处理
│   ├── validation.js    # 表单验证
│   └── crypto.js        # 加密解密
│
├── styles/              # 样式文件
│   ├── index.scss       # 全局样式
│   ├── variables.scss   # SCSS变量
│   └── mixins.scss      # SCSS混入
│
├── App.vue              # 根组件
└── main.js              # 应用入口
```

---

## 核心模块说明

### 1. Electron主进程 (electron/main.js)

**职责**:
- 创建和管理窗口
- IPC通信处理
- 系统级API调用

**关键代码**:
```javascript
// 创建主窗口
function createWindow() {
  const mainWindow = new BrowserWindow({
    width: 1440,
    height: 900,
    webPreferences: {
      nodeIntegration: true,
      contextIsolation: false,
    },
  })
}

// IPC通信示例
ipcMain.handle('get-app-path', () => {
  return app.getPath('userData')
})
```

**扩展点**:
- 添加新的IPC通信通道
- 实现系统托盘功能
- 添加全局快捷键

### 2. Pinia状态管理

#### App Store (stores/app.js)

**状态**:
```javascript
{
  appDataPath: string,      // 应用数据路径
  loading: boolean,          // 全局加载状态
  sidebarCollapsed: boolean, // 侧边栏折叠状态
  theme: string,             // 主题模式
}
```

**方法**:
- `init()` - 初始化应用
- `toggleSidebar()` - 切换侧边栏
- `toggleTheme()` - 切换主题

#### Account Store (stores/account.js)

**状态**:
```javascript
{
  accounts: Array,           // 账户列表
  currentAccountId: string,  // 当前账户ID
}
```

**方法**:
- `loadAccounts()` - 加载账户列表
- `addAccount(account)` - 添加账户
- `updateAccount(id, updates)` - 更新账户
- `deleteAccount(id)` - 删除账户
- `switchAccount(id)` - 切换账户

#### Mail Store (stores/mail.js)

**状态**:
```javascript
{
  mails: Array,              // 邮件列表
  currentFolder: string,     // 当前文件夹
  filter: Object,            // 筛选条件
}
```

**方法**:
- `loadMails(folder)` - 加载邮件
- `addMail(mail)` - 添加邮件
- `deleteMail(id)` - 删除邮件
- `markAsRead(id)` - 标记已读
- `toggleFlag(id)` - 切换星标

### 3. 服务层 (services/)

#### Storage Service

**功能**: 本地文件存储
**支持环境**: Electron文件系统 / 浏览器localStorage

```javascript
// 读取JSON
await storageService.readJSON('accounts/accounts.json')

// 写入JSON
await storageService.writeJSON('accounts/accounts.json', data)
```

#### IMAP Service

**功能**: IMAP协议收取邮件

```javascript
// 连接IMAP
await imapService.connect(config)

// 获取邮件列表
const mails = await imapService.fetchMails(uids)

// 标记已读
await imapService.markAsRead(uid)
```

#### SMTP Service

**功能**: SMTP协议发送邮件

```javascript
// 发送邮件
await smtpService.sendHtmlMail(config, {
  to: 'receiver@example.com',
  subject: 'Hello',
  html: '<p>Content</p>',
})
```

---

## 开发指南

### 1. 添加新页面

#### 步骤1: 创建Vue组件

```vue
<!-- src/views/NewPage.vue -->
<template>
  <div class="new-page">
    <h1>新页面</h1>
  </div>
</template>

<script setup>
import { ref } from 'vue'

const data = ref(null)
</script>

<style lang="scss" scoped>
.new-page {
  padding: 24px;
}
</style>
```

#### 步骤2: 添加路由

```javascript
// src/router/index.js
{
  path: '/new-page',
  name: 'NewPage',
  component: () => import('@/views/NewPage.vue'),
  meta: { title: '新页面' },
}
```

#### 步骤3: 添加导航链接

```vue
<router-link to="/new-page">新页面</router-link>
```

### 2. 创建新的Store

```javascript
// src/stores/newStore.js
import { defineStore } from 'pinia'
import { ref } from 'vue'

export const useNewStore = defineStore('newStore', () => {
  const data = ref([])
  
  function loadData() {
    // 加载数据逻辑
  }
  
  return {
    data,
    loadData,
  }
})
```

### 3. 添加新的Service

```javascript
// src/services/newService.js
class NewService {
  async fetchData() {
    // 实现逻辑
  }
}

export const newService = new NewService()
```

### 4. 使用Ant Design组件

```vue
<template>
  <a-button type="primary" @click="handleClick">
    点击我
  </a-button>
  
  <a-modal v-model:open="visible" title="标题">
    <p>内容</p>
  </a-modal>
</template>

<script setup>
import { ref } from 'vue'

const visible = ref(false)

function handleClick() {
  visible.value = true
}
</script>
```

---

## 扩展功能

### 1. 添加新的邮箱服务商

#### 步骤1: 添加配置

```javascript
// src/views/Login.vue
const emailConfigs = {
  newmail: {
    imapHost: 'imap.newmail.com',
    imapPort: 993,
    smtpHost: 'smtp.newmail.com',
    smtpPort: 465,
    oauth2: false,
  },
}
```

#### 步骤2: 添加选项

```vue
<a-select-option value="newmail">新邮箱</a-select-option>
```

### 2. 实现OAuth2认证

```javascript
// src/services/oauth.js
class OAuth2Service {
  async authenticateGmail() {
    // 实现Gmail OAuth2流程
    // 1. 获取授权URL
    // 2. 打开浏览器窗口
    // 3. 接收回调
    // 4. 交换token
  }
}
```

### 3. 添加邮件搜索功能

```javascript
// src/stores/mail.js
function searchMails(keyword) {
  return mails.value.filter(mail => 
    mail.subject.includes(keyword) ||
    mail.from.includes(keyword) ||
    mail.body.includes(keyword)
  )
}
```

### 4. 实现邮件草稿自动保存

```vue
<script setup>
import { watch, debounce } from 'vue'

const draftContent = ref('')

// 防抖自动保存
const saveDraft = debounce(async () => {
  await mailStore.saveDraft(draftContent.value)
}, 1000)

watch(draftContent, saveDraft)
</script>
```

---

## 调试技巧

### 1. Vue Devtools

安装Vue Devtools浏览器扩展，可以：
- 查看组件树
- 检查Pinia状态
- 追踪事件

### 2. Electron调试

```javascript
// electron/main.js
if (isDev) {
  mainWindow.webContents.openDevTools()
}
```

### 3. 日志输出

```javascript
// 开发环境日志
if (import.meta.env.DEV) {
  console.log('Debug info:', data)
}
```

### 4. 网络请求调试

```javascript
// 拦截axios请求
axios.interceptors.request.use(config => {
  console.log('Request:', config)
  return config
})
```

---

## 常见问题

### 1. IMAP连接失败

**问题**: `Error: Connection timeout`

**解决方案**:
- 检查防火墙设置
- 确认邮箱已开启IMAP服务
- 验证服务器地址和端口

### 2. 邮件发送失败

**问题**: `Error: Invalid login`

**解决方案**:
- 使用授权码而非密码（QQ、163、126）
- 检查SMTP配置是否正确

### 3. 本地存储失败

**问题**: `Cannot write file`

**解决方案**:
- 检查应用数据目录权限
- 确保磁盘空间充足

### 4. Electron白屏

**问题**: 启动后显示白屏

**解决方案**:
```javascript
// 确保等待Vite服务器启动
mainWindow.loadURL('http://localhost:5173')

// 或检查生产环境路径
mainWindow.loadFile(path.join(__dirname, '../dist/index.html'))
```

---

## 最佳实践

### 1. 代码规范

- 使用ESLint和Prettier保持代码一致性
- 遵循Vue 3 Composition API风格
- 使用`<script setup>`语法糖

### 2. 组件设计

- 单一职责原则
- Props向下，Events向上
- 合理使用组合式函数(Composables)

### 3. 状态管理

- 区分本地状态和全局状态
- 避免过度使用Store
- 使用computed派生状态

### 4. 性能优化

- 使用虚拟滚动处理大列表
- 懒加载路由组件
- 图片懒加载

---

## 测试

### 单元测试

```javascript
// vitest配置
import { describe, it, expect } from 'vitest'

describe('MailStore', () => {
  it('should add mail correctly', () => {
    const store = useMailStore()
    store.addMail({ subject: 'Test' })
    expect(store.mails).toHaveLength(1)
  })
})
```

### E2E测试

使用Playwright或Cypress进行端到端测试

---

## 发布流程

### 1. 版本更新

```bash
# 更新版本号
npm version patch|minor|major
```

### 2. 构建应用

```bash
# 构建所有平台
npm run electron:build

# 或单独构建
npm run electron:build:win
npm run electron:build:mac
npm run electron:build:linux
```

### 3. 发布到GitHub Releases

1. 创建Git标签
2. 推送到仓库
3. 上传构建产物

---

## 资源链接

- [Vue 3官方文档](https://vuejs.org/)
- [Ant Design Vue](https://antdv.com/)
- [Electron文档](https://www.electronjs.org/docs)
- [Pinia文档](https://pinia.vuejs.org/)
- [Vite文档](https://vitejs.dev/)

---

**文档版本**: v1.0  
**最后更新**: 2025-10-19  
**维护者**: Maillionaire Development Team
