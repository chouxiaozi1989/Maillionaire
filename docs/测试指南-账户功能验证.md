# 测试指南：账户添加和跳转功能验证

## 🎯 测试目标

验证以下问题已修复：
1. ✅ 添加账户后点击账户不再报错
2. ✅ 点击账户能正常跳转到主界面
3. ✅ 账户数据能持久化保存到文件系统
4. ✅ Electron 环境下的文件操作正常工作

---

## 📋 测试前准备

### 1. 清理旧数据（可选）

如果想从零开始测试，可以删除旧的账户数据：

**Windows**：
```powershell
# 删除账户数据目录
Remove-Item -Path "$env:APPDATA\Maillionaire\accounts" -Recurse -Force -ErrorAction SilentlyContinue
```

**或手动删除**：
```
C:\Users\Administrator\AppData\Roaming\Maillionaire\accounts\
```

### 2. 确保应用正在运行

```bash
npm run electron:dev
```

等待看到：
```
✓ Vite 服务器已就绪
启动 Electron...
```

---

## 🧪 测试用例

### 测试用例 1：添加 Gmail 账户（测试模式）

**目的**：验证 OAuth2 测试模式和账户保存功能

#### 步骤：

1. **打开 Electron 窗口**
   - 应该看到登录页面
   - 如果有旧账户，先忽略

2. **点击"添加邮箱账户"按钮**

3. **填写表单**：
   - 邮箱类型：`Gmail`
   - 邮箱地址：`test@gmail.com`
   - 不需要填写密码（OAuth2 自动跳过）

4. **点击确定**

#### 预期结果：

- ✅ 弹窗关闭
- ✅ 显示提示："正在进行 OAuth2 认证..."
- ✅ 显示提示："OAuth2 认证成功"
- ✅ 显示提示："账户添加成功"
- ✅ 显示提示："登录成功"
- ✅ **自动跳转到主界面**（`/main/inbox`）
- ✅ 侧边栏显示账户信息：`test@gmail.com`
- ✅ 控制台**无报错**

#### 检查点：

**打开开发者工具（F12）查看控制台**：
- ❌ 不应该有红色错误信息
- ✅ 可能有蓝色的 info 日志（正常）

---

### 测试用例 2：验证账户持久化

**目的**：验证账户数据保存到文件系统

#### 步骤：

1. **关闭 Electron 应用**（完全退出）

2. **检查文件是否存在**：
   ```powershell
   # 查看账户文件
   Get-Content "$env:APPDATA\Maillionaire\accounts\accounts.json" | ConvertFrom-Json | ConvertTo-Json -Depth 5
   ```

3. **重新启动应用**：
   ```bash
   npm run electron:dev
   ```

#### 预期结果：

- ✅ 文件存在：`C:\Users\Administrator\AppData\Roaming\Maillionaire\accounts\accounts.json`
- ✅ 文件内容包含刚才添加的账户：
  ```json
  [
    {
      "id": "1729382400000",
      "type": "gmail",
      "email": "test@gmail.com",
      "name": "test",
      "imapHost": "imap.gmail.com",
      "imapPort": 993,
      "smtpHost": "smtp.gmail.com",
      "smtpPort": 465,
      "oauth2": true,
      "accessToken": "test_access_token_...",
      "refreshToken": "test_refresh_token_...",
      "connected": true,
      "testMode": true,
      "createdAt": "2025-10-19T..."
    }
  ]
  ```
- ✅ 重启后，登录页面显示之前添加的账户卡片

---

### 测试用例 3：点击现有账户登录

**目的**：验证点击账户不报错，能正常跳转

#### 步骤：

1. **确保登录页面有账户卡片**（如果没有，先执行测试用例 1）

2. **点击账户卡片**（包含头像、邮箱地址的卡片）

#### 预期结果：

- ✅ 显示提示："登录成功"
- ✅ 自动跳转到主界面
- ✅ 地址栏显示：`http://localhost:5173/main/inbox`
- ✅ 侧边栏显示当前账户
- ✅ 控制台**无报错**

#### 调试检查：

**如果仍然报错，请检查控制台错误信息**：

```javascript
// 常见错误 1：router 未定义
// 检查 Login.vue 是否正确导入 router

// 常见错误 2：accountStore.switchAccount 报错
// 检查 account.js 的 switchAccount 函数

// 常见错误 3：无法读取属性
// 检查 account.id 是否存在
```

---

### 测试用例 4：添加多个不同类型账户

**目的**：验证多账户支持和切换功能

#### 步骤：

1. **添加 QQ 邮箱**：
   - 点击"添加邮箱账户"
   - 邮箱类型：`QQ邮箱`
   - 邮箱地址：`test@qq.com`
   - 授权码/密码：`testpassword123`（测试用）
   - 点击确定

2. **添加 163 邮箱**：
   - 邮箱类型：`163邮箱`
   - 邮箱地址：`test@163.com`
   - 授权码/密码：`testpassword456`
   - 点击确定

#### 预期结果：

- ✅ 每次添加成功后都自动登录并跳转
- ✅ 登录页面显示 3 个账户卡片
- ✅ 文件中包含 3 个账户：
  ```powershell
  Get-Content "$env:APPDATA\Maillionaire\accounts\accounts.json"
  ```

---

### 测试用例 5：主界面切换账户

**目的**：验证账户切换功能

#### 步骤：

1. **进入主界面**（执行测试用例 3）

2. **在侧边栏找到账户下拉选择器**

3. **切换到其他账户**

#### 预期结果：

- ✅ 显示提示："已切换账户"
- ✅ 侧边栏头像和邮箱地址更新
- ✅ 控制台无报错

---

## 🐛 常见问题排查

### 问题 1：点击账户仍然报错

**可能原因**：
- Electron 未重启，旧代码仍在运行

**解决方法**：
```bash
# 完全关闭 Electron
taskkill /F /IM electron.exe

# 重新启动
npm run electron:dev
```

---

### 问题 2：账户数据没有保存

**检查步骤**：

1. **验证 electronAPI 是否可用**：
   - 打开控制台（F12）
   - 输入：`window.electronAPI`
   - 应该显示一个对象，包含 `readFile`、`writeFile` 等方法

   ```javascript
   // 预期输出：
   {
     getAppPath: ƒ,
     readFile: ƒ,
     writeFile: ƒ,
     deleteFile: ƒ,
     ...
   }
   ```

   **如果显示 `undefined`**：
   - 说明 preload 脚本未加载
   - 检查 `electron/main.js` 中的 `preload` 配置

2. **手动测试文件写入**：
   ```javascript
   // 在控制台执行
   await window.electronAPI.writeFile('test.json', '{"test": true}')
   
   // 应该返回 true
   ```

3. **检查文件路径**：
   ```javascript
   // 获取数据目录
   const appPath = await window.electronAPI.getAppPath()
   console.log('数据目录:', appPath)
   // 应该输出：C:\Users\Administrator\AppData\Roaming\Maillionaire
   ```

---

### 问题 3：OAuth2 认证失败

**症状**：
- 点击确定后没有反应
- 或显示"OAuth2 认证失败"

**原因**：
- 测试模式下应该不会失败
- 可能是网络问题或配置错误

**检查**：
```javascript
// 在控制台查看 oauth2Service 配置
import { oauth2Service } from '@/services/oauth'
console.log('是否测试模式:', oauth2Service.isTestMode())
// 应该返回 true
```

---

### 问题 4：跳转后页面空白

**可能原因**：
- 主界面组件加载失败
- 路由配置错误

**检查**：
1. 查看控制台错误信息
2. 检查网络请求是否有 404
3. 确认 `src/views/Main.vue` 文件存在

---

## 📊 测试记录表

请在测试后填写：

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 测试用例 1：添加 Gmail 账户 | ⬜ 通过 / ⬜ 失败 |  |
| 测试用例 2：验证账户持久化 | ⬜ 通过 / ⬜ 失败 |  |
| 测试用例 3：点击现有账户登录 | ⬜ 通过 / ⬜ 失败 |  |
| 测试用例 4：添加多个账户 | ⬜ 通过 / ⬜ 失败 |  |
| 测试用例 5：主界面切换账户 | ⬜ 通过 / ⬜ 失败 |  |

---

## 🔍 调试技巧

### 1. 查看详细日志

在 `src/services/storage.js` 中添加日志：

```javascript
async writeJSON(filename, data) {
  console.log('[Storage] 写入文件:', filename)
  console.log('[Storage] 数据大小:', JSON.stringify(data).length, 'bytes')
  console.log('[Storage] Electron 模式:', this.isElectron)
  
  try {
    const jsonData = JSON.stringify(data, null, 2)
    
    if (this.isElectron) {
      console.log('[Storage] 使用 Electron 文件系统')
      await window.electronAPI.writeFile(filename, jsonData)
      console.log('[Storage] 写入成功')
    } else {
      console.log('[Storage] 使用 localStorage')
      const key = `${this.dataPath}_${filename}`
      localStorage.setItem(key, jsonData)
    }
  } catch (error) {
    console.error('[Storage] 写入失败:', error)
    throw error
  }
}
```

### 2. 检查账户 Store 状态

在控制台执行：

```javascript
// 导入 store
import { useAccountStore } from '@/stores/account'
const accountStore = useAccountStore()

// 查看所有账户
console.log('所有账户:', accountStore.accounts)

// 查看当前账户
console.log('当前账户:', accountStore.currentAccount)
console.log('当前账户ID:', accountStore.currentAccountId)
```

### 3. 监听路由变化

```javascript
import { useRouter } from 'vue-router'
const router = useRouter()

router.beforeEach((to, from, next) => {
  console.log('路由跳转:', from.path, '→', to.path)
  next()
})
```

---

## ✅ 测试通过标准

所有测试用例通过后，应满足：

1. ✅ 添加账户流程顺畅，无卡顿或报错
2. ✅ 点击账户能立即跳转到主界面
3. ✅ 关闭应用后重新打开，账户仍然存在
4. ✅ 文件系统中存在账户数据文件
5. ✅ 控制台无任何错误信息（可忽略 Sass 警告）
6. ✅ 多账户切换正常工作

---

## 📞 遇到问题？

如果测试未通过，请提供以下信息：

1. **失败的测试用例编号**
2. **控制台错误信息**（截图或文字）
3. **执行的步骤**
4. **预期结果 vs 实际结果**
5. **是否检查了文件系统**

---

**测试日期**：2025-10-19  
**版本**：v1.0.0  
**测试环境**：Windows 11 22H2 + Electron 26.2.1 + Node.js 18.x
