# Maillionaire 打包说明文档

本文档详细介绍如何将 Maillionaire 打包为可分发的桌面应用程序。

## 目录

- [快速开始](#快速开始)
- [打包脚本说明](#打包脚本说明)
- [平台特定说明](#平台特定说明)
- [构建产物](#构建产物)
- [高级配置](#高级配置)
- [常见问题](#常见问题)

---

## 快速开始

### 环境要求

- Node.js >= 16.x
- npm >= 8.x
- 对应平台的构建工具（见[平台特定说明](#平台特定说明)）

### 一键打包

```bash
# 打包当前平台（推荐）
npm run package

# 打包 Windows 版本
npm run package:win

# 打包 macOS 版本
npm run package:mac

# 打包 Linux 版本
npm run package:linux

# 打包所有平台（需要在支持的平台上运行）
npm run package:all
```

---

## 打包脚本说明

### 可用脚本

| 脚本命令 | 说明 | 执行内容 |
|---------|------|---------|
| `npm run package` | 打包当前平台 | `npm run build && electron-builder` |
| `npm run package:win` | 打包 Windows | `npm run build && electron-builder --win` |
| `npm run package:mac` | 打包 macOS | `npm run build && electron-builder --mac` |
| `npm run package:linux` | 打包 Linux | `npm run build && electron-builder --linux` |
| `npm run package:all` | 打包所有平台 | `npm run build && electron-builder --win --mac --linux` |

### 构建流程

1. **Web 资源构建** (`npm run build`)
   - 使用 Vite 编译 Vue 应用
   - 输出到 `dist/` 目录
   - 包含 HTML、JS、CSS 和静态资源

2. **Electron 应用打包** (`electron-builder`)
   - 将 Web 资源打包到 Electron 应用中
   - 添加主进程代码（`electron/`）
   - 生成平台特定的安装包
   - 输出到 `dist-electron/` 目录

---

## 平台特定说明

### Windows

#### 环境准备

1. **Windows SDK**（可选，用于代码签名）
   - 下载：https://developer.microsoft.com/windows/downloads/windows-sdk/
   - 安装选择：只需安装 Windows SDK Signing Tools

2. **构建工具**
   - electron-builder 会自动下载所需工具
   - 需要良好的网络连接

#### 打包命令

```bash
npm run package:win
```

#### 构建产物

- **安装包**: `Maillionaire Setup 1.2.0.exe`
- **大小**: 约 150-200 MB
- **格式**: NSIS 安装程序
- **特性**:
  - 自动安装到 Program Files
  - 创建桌面快捷方式
  - 添加到开始菜单
  - 支持静默安装

#### 配置选项

```json
{
  "win": {
    "target": ["nsis"],
    "icon": "build/icon.ico",
    "artifactName": "${productName} Setup ${version}.${ext}",
    "publisherName": "Maillionaire Team"
  },
  "nsis": {
    "oneClick": false,
    "allowToChangeInstallationDirectory": true,
    "createDesktopShortcut": true,
    "createStartMenuShortcut": true
  }
}
```

---

### macOS

#### 环境准备

1. **Xcode Command Line Tools**
   ```bash
   xcode-select --install
   ```

2. **Apple Developer 账号**（可选，用于代码签名和公证）
   - 注册：https://developer.apple.com/
   - 费用：$99/年

#### 打包命令

```bash
npm run package:mac
```

#### 构建产物

- **磁盘映像**: `Maillionaire-1.2.0.dmg`
- **大小**: 约 150-200 MB
- **格式**: DMG 磁盘映像
- **特性**:
  - 拖放安装界面
  - 自动挂载
  - 包含应用程序文件夹链接

#### 配置选项

```json
{
  "mac": {
    "target": ["dmg"],
    "icon": "build/icon.icns",
    "category": "public.app-category.productivity",
    "hardenedRuntime": true,
    "gatekeeperAssess": false,
    "entitlements": "build/entitlements.mac.plist",
    "entitlementsInherit": "build/entitlements.mac.plist"
  },
  "dmg": {
    "contents": [
      {
        "x": 130,
        "y": 220
      },
      {
        "x": 410,
        "y": 220,
        "type": "link",
        "path": "/Applications"
      }
    ]
  }
}
```

#### 代码签名（可选）

```bash
# 设置环境变量
export APPLE_ID="your-apple-id@example.com"
export APPLE_ID_PASSWORD="app-specific-password"
export TEAM_ID="YOUR_TEAM_ID"

# 打包并签名
npm run package:mac
```

---

### Linux

#### 环境准备

1. **基础工具**
   ```bash
   # Ubuntu/Debian
   sudo apt-get install -y icnsutils graphicsmagick

   # Fedora/RHEL
   sudo dnf install libicns-utils GraphicsMagick

   # Arch
   sudo pacman -S libicns graphicsmagick
   ```

2. **AppImage 工具**（自动下载）
   - electron-builder 会自动下载
   - 无需手动安装

#### 打包命令

```bash
npm run package:linux
```

#### 构建产物

- **可执行文件**: `Maillionaire-1.2.0.AppImage`
- **大小**: 约 150-200 MB
- **格式**: AppImage
- **特性**:
  - 单文件，免安装
  - 包含所有依赖
  - 支持大部分 Linux 发行版

#### 配置选项

```json
{
  "linux": {
    "target": ["AppImage"],
    "icon": "build/icon.png",
    "category": "Office",
    "maintainer": "Maillionaire Team"
  },
  "appImage": {
    "license": "LICENSE",
    "desktop": {
      "StartupWMClass": "maillionaire"
    }
  }
}
```

#### 运行 AppImage

```bash
# 添加执行权限
chmod +x Maillionaire-1.2.0.AppImage

# 运行
./Maillionaire-1.2.0.AppImage
```

---

## 构建产物

### 输出目录结构

```
dist-electron/
├── win-unpacked/              # Windows 解压版本（用于测试）
├── mac/                       # macOS 应用包（用于测试）
├── linux-unpacked/            # Linux 解压版本（用于测试）
├── Maillionaire Setup 1.2.0.exe      # Windows 安装包
├── Maillionaire-1.2.0.dmg            # macOS 磁盘映像
├── Maillionaire-1.2.0.AppImage       # Linux AppImage
├── builder-effective-config.yaml    # 构建配置快照
└── builder-debug.yml                # 调试信息
```

### 产物说明

| 文件 | 平台 | 大小 | 用途 |
|------|------|------|------|
| `Maillionaire Setup 1.2.0.exe` | Windows | ~150MB | 分发给 Windows 用户 |
| `Maillionaire-1.2.0.dmg` | macOS | ~150MB | 分发给 macOS 用户 |
| `Maillionaire-1.2.0.AppImage` | Linux | ~150MB | 分发给 Linux 用户 |
| `win-unpacked/` | Windows | ~200MB | 本地测试用 |
| `mac/` | macOS | ~200MB | 本地测试用 |
| `linux-unpacked/` | Linux | ~200MB | 本地测试用 |

---

## 高级配置

### 自定义图标

应用图标位于 `build/` 目录：

```
build/
├── icon.ico     # Windows 图标（256x256）
├── icon.icns    # macOS 图标（512x512）
└── icon.png     # Linux 图标（512x512）
```

**制作图标：**

1. 准备一张 1024x1024 的 PNG 图片
2. 使用在线工具转换：
   - ICO: https://www.icoconverter.com/
   - ICNS: https://cloudconvert.com/png-to-icns
3. 替换 `build/` 目录中的对应文件

### 构建配置

electron-builder 配置位于 `package.json` 的 `build` 字段：

```json
{
  "build": {
    "appId": "com.maillionaire.app",
    "productName": "Maillionaire",
    "copyright": "Copyright © 2025 Maillionaire Team",
    "directories": {
      "output": "dist-electron",
      "buildResources": "build"
    },
    "files": [
      "dist/**/*",
      "electron/**/*",
      "package.json",
      "!node_modules/**/*",
      "node_modules/imap/**/*",
      "node_modules/mailparser/**/*",
      "node_modules/nodemailer/**/*"
    ],
    "extraResources": [
      {
        "from": "resources",
        "to": "resources",
        "filter": ["**/*"]
      }
    ]
  }
}
```

### 环境变量

可以通过环境变量控制构建行为：

```bash
# 跳过代码签名
export CSC_IDENTITY_AUTO_DISCOVERY=false

# 指定输出目录
export ELECTRON_BUILDER_CACHE=/path/to/cache

# 启用调试日志
export DEBUG=electron-builder

# 设置构建并发数
export ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES=true
```

---

## 常见问题

### 1. 打包失败：网络超时

**问题**: electron-builder 下载依赖超时

**解决方案**:
```bash
# 使用国内镜像
export ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/
export ELECTRON_BUILDER_BINARIES_MIRROR=https://npmmirror.com/mirrors/electron-builder-binaries/

# 重新打包
npm run package
```

### 2. Windows: "No native build was found"

**问题**: 缺少原生模块的编译版本

**解决方案**:
```bash
# 重新编译原生模块
npm rebuild

# 或清理后重新安装
rm -rf node_modules
npm install
```

### 3. macOS: "Code signing failed"

**问题**: 没有配置代码签名证书

**解决方案**:
```bash
# 跳过代码签名
export CSC_IDENTITY_AUTO_DISCOVERY=false
npm run package:mac
```

### 4. Linux: "Cannot find module 'electron'"

**问题**: electron 未正确安装

**解决方案**:
```bash
# 清理并重新安装
rm -rf node_modules package-lock.json
npm install
```

### 5. 构建包太大

**问题**: 打包后文件超过 200MB

**解决方案**:

1. **排除不必要的文件**
   ```json
   {
     "build": {
       "files": [
         "!**/*.map",
         "!**/node_modules/**/*.d.ts",
         "!**/node_modules/.cache"
       ]
     }
   }
   ```

2. **使用 asar 压缩**（默认启用）
   ```json
   {
     "build": {
       "asar": true
     }
   }
   ```

3. **分析包大小**
   ```bash
   npm install -g source-map-explorer
   npm run build
   source-map-explorer dist/**/*.js
   ```

### 6. 打包后应用无法启动

**检查清单**:

1. 确认 `electron/main.js` 路径正确
2. 检查 `package.json` 中的 `main` 字段
3. 查看构建日志中的错误信息
4. 使用 `win-unpacked` 测试版本调试

---

## 测试打包结果

### 本地测试

```bash
# Windows
.\dist-electron\win-unpacked\Maillionaire.exe

# macOS
open dist-electron/mac/Maillionaire.app

# Linux
./dist-electron/linux-unpacked/maillionaire
```

### 安装包测试

1. **Windows**
   ```bash
   # 安装
   .\dist-electron\Maillionaire Setup 1.2.0.exe
   ```

2. **macOS**
   ```bash
   # 挂载 DMG
   open dist-electron/Maillionaire-1.2.0.dmg
   # 拖动到 Applications 文件夹
   ```

3. **Linux**
   ```bash
   # 添加执行权限并运行
   chmod +x dist-electron/Maillionaire-1.2.0.AppImage
   ./dist-electron/Maillionaire-1.2.0.AppImage
   ```

---

## 发布流程

### 1. 更新版本号

```bash
# 手动更新
# - package.json: version
# - src/config/version.js: version, buildDate
```

### 2. 打包所有平台

```bash
# 在 Windows 上
npm run package:win

# 在 macOS 上
npm run package:mac

# 在 Linux 上
npm run package:linux
```

### 3. 创建 GitHub Release

```bash
# 创建 tag
git tag -a v1.2.0 -m "Release v1.2.0"
git push origin v1.2.0

# 在 GitHub 上创建 Release
# 上传打包好的安装包
```

### 4. 更新下载链接

在 README.md 和文档中更新下载链接。

---

## 参考资料

- [electron-builder 官方文档](https://www.electron.build/)
- [Electron 打包指南](https://www.electronjs.org/docs/latest/tutorial/application-distribution)
- [代码签名指南](https://www.electron.build/code-signing)
- [多平台构建](https://www.electron.build/multi-platform-build)

---

## 联系支持

如果在打包过程中遇到问题：

- 提交 Issue: https://github.com/chouxiaozi1989/Maillionaire/issues
- 邮箱: yi.cai1989@gmail.com

---

**最后更新**: 2025-11-07
**版本**: 1.2.0
