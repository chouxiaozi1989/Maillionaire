# 环境变量配置说明

## 概述

本项目使用 `.env` 文件管理敏感配置信息，如 OAuth2 客户端 ID 和密钥。

---

## 快速开始

### 1. 复制示例文件

```bash
cp .env.example .env
```

### 2. 编辑 `.env` 文件

使用文本编辑器打开 `.env` 文件，填入你的配置：

```env
# Gmail OAuth2 配置
VITE_GMAIL_CLIENT_ID=你的Gmail客户端ID
VITE_GMAIL_CLIENT_SECRET=你的Gmail客户端密钥

# Outlook OAuth2 配置
VITE_OUTLOOK_CLIENT_ID=你的Outlook应用ID
VITE_OUTLOOK_CLIENT_SECRET=你的Outlook客户端密钥

# OAuth2 回调地址（开发环境）
VITE_OAUTH_REDIRECT_URI=http://localhost:3000/oauth/callback
```

### 3. 重启应用

```bash
npm run electron:dev
```

---

## 环境变量说明

### Gmail OAuth2 配置

| 变量名 | 必填 | 说明 | 获取方式 |
|-------|------|------|---------|
| `VITE_GMAIL_CLIENT_ID` | 否 | Gmail OAuth2 客户端 ID | [Google Cloud Console](https://console.cloud.google.com/) |
| `VITE_GMAIL_CLIENT_SECRET` | 否 | Gmail OAuth2 客户端密钥 | Google Cloud Console |

**示例值**：
```env
VITE_GMAIL_CLIENT_ID=123456789-abcdefg.apps.googleusercontent.com
VITE_GMAIL_CLIENT_SECRET=GOCSPX-abcdefghijklmnop
```

### Outlook OAuth2 配置

| 变量名 | 必填 | 说明 | 获取方式 |
|-------|------|------|---------|
| `VITE_OUTLOOK_CLIENT_ID` | 否 | Outlook OAuth2 应用 ID | [Azure Portal](https://portal.azure.com/) |
| `VITE_OUTLOOK_CLIENT_SECRET` | 否 | Outlook OAuth2 客户端密钥 | Azure Portal |

**示例值**：
```env
VITE_OUTLOOK_CLIENT_ID=12345678-1234-1234-1234-123456789012
VITE_OUTLOOK_CLIENT_SECRET=abc~123defGHI456jkl789MNO
```

### OAuth2 回调地址

| 变量名 | 必填 | 说明 | 默认值 |
|-------|------|------|--------|
| `VITE_OAUTH_REDIRECT_URI` | 否 | OAuth2 授权回调地址 | `http://localhost:3000/oauth/callback` |

**注意事项**：
- 开发环境使用 `http://localhost:3000/oauth/callback`
- 生产环境需要使用实际的域名和 HTTPS
- 回调地址必须在 OAuth2 应用配置中预先注册

---

## 测试模式

### 自动启用条件

如果满足以下任一条件，系统会自动启用测试模式：

1. `.env` 文件不存在
2. 环境变量未配置（值为空）
3. 环境变量值为占位符（如 `YOUR_GMAIL_CLIENT_ID`）

### 测试模式特性

✅ **可用功能**：
- 添加 Gmail/Outlook 账户
- 界面和流程测试
- 使用模拟令牌认证

❌ **不可用功能**：
- 实际连接到 Gmail/Outlook 服务器
- 收发真实邮件
- OAuth2 授权窗口

### 测试模式示例

```javascript
// 测试模式下的认证结果
{
  success: true,
  email: "test@gmail.com",
  provider: "gmail",
  accessToken: "test_access_token_1729382400000",
  refreshToken: "test_refresh_token_1729382400000",
  expiresAt: 1729386000000,
  testMode: true  // ✅ 测试模式标记
}
```

---

## 安全最佳实践

### ✅ 推荐做法

1. **不要提交 `.env` 文件**
   - `.env` 已在 `.gitignore` 中
   - 只提交 `.env.example` 示例文件

2. **使用环境变量**
   - 不要在代码中硬编码密钥
   - 使用 `import.meta.env.VITE_XXX` 访问

3. **定期更换密钥**
   - 如果密钥泄露，立即在 OAuth2 控制台中撤销
   - 生成新的密钥并更新 `.env` 文件

4. **分离开发和生产环境**
   - 开发环境：`.env`
   - 生产环境：`.env.production`

### ❌ 禁止做法

1. **不要直接在代码中写密钥**
   ```javascript
   // ❌ 错误示例
   const clientId = '123456-abc.apps.googleusercontent.com'
   
   // ✅ 正确示例
   const clientId = import.meta.env.VITE_GMAIL_CLIENT_ID
   ```

2. **不要在公开渠道分享 `.env` 文件**
   - 不要发送给他人
   - 不要上传到公开网站
   - 不要提交到 Git 仓库

3. **不要使用生产环境密钥进行测试**
   - 为开发和生产创建不同的 OAuth2 应用
   - 使用不同的密钥

---

## 故障排查

### 问题 1: 环境变量未生效

**症状**：
- 修改了 `.env` 文件，但应用仍使用旧值

**解决方法**：
```bash
# 完全重启应用
taskkill /F /IM electron.exe  # Windows
npm run electron:dev
```

### 问题 2: 仍然是测试模式

**症状**：
- 配置了 `.env` 文件，但仍显示测试模式

**检查清单**：
1. ✅ `.env` 文件在项目根目录
2. ✅ 环境变量名称正确（`VITE_` 前缀）
3. ✅ 环境变量值不是占位符
4. ✅ 已重启应用

**调试方法**：
```javascript
// 在浏览器控制台执行
console.log('Gmail Client ID:', import.meta.env.VITE_GMAIL_CLIENT_ID)
console.log('Outlook Client ID:', import.meta.env.VITE_OUTLOOK_CLIENT_ID)
```

### 问题 3: OAuth2 认证失败

**可能原因**：
1. Client ID 或 Secret 错误
2. 回调地址未在 OAuth2 应用中注册
3. OAuth2 应用未启用必要的 API

**解决步骤**：
1. 检查 `.env` 文件中的配置是否正确
2. 在 Google Cloud Console / Azure Portal 中验证配置
3. 确认回调地址 `http://localhost:3000/oauth/callback` 已注册
4. Gmail: 确认已启用 Gmail API
5. Outlook: 确认已添加必要的权限

---

## 开发环境 vs 生产环境

### 开发环境

**文件**：`.env`

```env
# 开发环境配置
VITE_GMAIL_CLIENT_ID=dev-client-id
VITE_GMAIL_CLIENT_SECRET=dev-client-secret
VITE_OAUTH_REDIRECT_URI=http://localhost:3000/oauth/callback
```

### 生产环境

**文件**：`.env.production`

```env
# 生产环境配置
VITE_GMAIL_CLIENT_ID=prod-client-id
VITE_GMAIL_CLIENT_SECRET=prod-client-secret
VITE_OAUTH_REDIRECT_URI=https://yourdomain.com/oauth/callback
```

### 构建时指定环境

```bash
# 开发构建
npm run build

# 生产构建
npm run build -- --mode production
```

---

## Vite 环境变量机制

### 变量前缀

Vite 只会暴露以 `VITE_` 开头的环境变量：

```env
# ✅ 可访问
VITE_GMAIL_CLIENT_ID=123456

# ❌ 不可访问（没有 VITE_ 前缀）
GMAIL_CLIENT_ID=123456
```

### 访问方式

在代码中使用 `import.meta.env`：

```javascript
// 获取环境变量
const clientId = import.meta.env.VITE_GMAIL_CLIENT_ID

// 检查是否定义
if (import.meta.env.VITE_GMAIL_CLIENT_ID) {
  // 使用真实配置
} else {
  // 使用测试模式
}

// 提供默认值
const redirectUri = import.meta.env.VITE_OAUTH_REDIRECT_URI || 'http://localhost:3000/oauth/callback'
```

### 内置变量

Vite 提供的内置环境变量：

| 变量 | 说明 |
|------|------|
| `import.meta.env.MODE` | 运行模式 (`development` / `production`) |
| `import.meta.env.DEV` | 是否为开发环境 |
| `import.meta.env.PROD` | 是否为生产环境 |
| `import.meta.env.BASE_URL` | 应用基础路径 |

---

## 相关文档

- [OAuth2 配置指南](./OAuth2配置指南.md) - 详细的 OAuth2 配置步骤
- [问题修复-登录和OAuth2认证](./问题修复-登录和OAuth2认证.md) - OAuth2 功能实现说明
- [Vite 环境变量文档](https://cn.vitejs.dev/guide/env-and-mode.html) - Vite 官方文档

---

## 总结

✅ **配置步骤**：
1. 复制 `.env.example` 为 `.env`
2. 填入 OAuth2 配置
3. 重启应用

✅ **安全特性**：
- `.env` 文件不会被提交到 Git
- 未配置时自动启用测试模式
- 支持开发和生产环境分离

✅ **使用方便**：
- Vite 自动加载环境变量
- 代码中通过 `import.meta.env.VITE_XXX` 访问
- 提供默认值，防止应用崩溃

---

**最后更新**：2025-10-19
